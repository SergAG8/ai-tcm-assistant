<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-lang-key="title_main">AI Course Matchmaker (TCM Assistant)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet"
    />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f8fafc;
        }
        #app-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        .step-header {
            background-color: #f1f5f9;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
        }
        .result-box {
            min-height: 150px;
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        .ai-result-box {
            background-color: #ecfdf5;
            border-left: 4px solid #10b981;
            padding: 15px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div
        id="language-selector"
        class="flex justify-end max-w-5xl mx-auto mt-4 px-4"
    >
        <select
            onchange="setLanguage(this.value)"
            class="p-2 border border-gray-300 rounded-lg text-sm"
        >
            <option value="es" selected>Espa√±ol (ES)</option>
            <option value="en">English (EN)</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π (RU)</option>
        </select>
    </div>

    <div id="app-container">
        <h1
            class="text-3xl font-extrabold text-gray-900 mb-4 text-center"
            data-lang-key="title_main"
        >
            ü§ñ AI Course Matchmaker (TCM Assistant)
        </h1>
        <p
            class="text-center text-gray-600 mb-6"
            data-lang-key="subtitle_main"
        >
            Herramienta de diagn√≥stico de ventas para asegurar la colocaci√≥n
            correcta y reducir el churn por expectativas.
        </p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- STEP 1 -->
            <div class="card">
                <div class="step-header" data-lang-key="step1_header">
                    1. Diagn√≥stico del Estudiante
                </div>

                <label
                    for="student_age"
                    class="block text-sm font-medium text-gray-700 mb-1"
                    data-lang-key="label_age"
                    >Edad del Estudiante (7-17 a√±os):</label
                >
                <input
                    type="number"
                    id="student_age"
                    min="7"
                    max="17"
                    value="10"
                    class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500"
                />

                <label
                    for="student_interest"
                    class="block text-sm font-medium text-gray-700 mb-1"
                    data-lang-key="label_interest"
                    >Inter√©s Principal:</label
                >
                <select
                    id="student_interest"
                    class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500"
                >
                    <option
                        value="coding"
                        data-lang-key="opt_coding"
                    >
                        Programaci√≥n (L√≥gica)
                    </option>
                    <option
                        value="design"
                        data-lang-key="opt_design"
                    >
                        Dise√±o / Arte Digital
                    </option>
                    <option
                        value="games"
                        data-lang-key="opt_games"
                    >
                        Creaci√≥n de Videojuegos
                    </option>
                </select>

                <label
                    for="student_level"
                    class="block text-sm font-medium text-gray-700 mb-1"
                    data-lang-key="label_level"
                    >Experiencia Previa (TC Assessment):</label
                >
                <select
                    id="student_level"
                    class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500"
                >
                    <option
                        value="beginner"
                        data-lang-key="opt_beginner"
                    >
                        Principiante (Cero experiencia)
                    </option>
                    <option
                        value="intermediate"
                        data-lang-key="opt_intermediate"
                    >
                        Intermedio (Sabe bloques/Scratch)
                    </option>
                    <option
                        value="advanced"
                        data-lang-key="opt_advanced"
                    >
                        Avanzado (Sabe Python b√°sico/Roblox)
                    </option>
                </select>

                <button
                    id="btn_suggest"
                    onclick="diagnoseAndMatch()"
                    class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150"
                    data-lang-key="btn_suggest"
                >
                    üîç Sugerir Cursos (AI Match)
                </button>
            </div>

            <!-- STEP 2 -->
            <div class="card">
                <div class="step-header" data-lang-key="step2_header">
                    2. Tres Mejores Opciones y Pitch
                </div>

                <label
                    for="course_recommendation"
                    class="block text-sm font-medium text-gray-700 mb-1"
                    data-lang-key="label_suggested_courses"
                    >Cursos Sugeridos (Top 3 Priorizados):</label
                >
                <div
                    id="course_recommendation"
                    class="result-box text-gray-800 text-sm"
                    data-lang-key="status_waiting"
                >
                    Esperando diagn√≥stico...
                </div>

                <div class="mt-4">
                    <label
                        for="selected_course"
                        class="block text-sm font-medium text-gray-700 mb-1"
                        data-lang-key="label_select_pitch"
                        >Selecciona la Opci√≥n para Generar el Pitch (Ver Pitch de
                        Venta):</label
                    >
                    <select
                        id="selected_course"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option
                            value=""
                            data-lang-key="opt_first_diagnose"
                        >
                            -- Primero Diagnosticar --
                        </option>
                    </select>
                </div>

                <button
                    id="btn_pitch"
                    onclick="generatePitch()"
                    class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150 mt-4"
                    data-lang-key="btn_pitch"
                >
                    üé§ Generar Pitch (AI Venta)
                </button>
            </div>

            <!-- STEP 3 -->
            <div class="lg:col-span-2 card">
                <div class="step-header" data-lang-key="step3_header">
                    3. Argumento de Venta (Output de IA)
                </div>
                <div
                    id="pitch_output"
                    class="ai-result-box text-gray-800 text-sm"
                    data-lang-key="status_pitch_placeholder"
                >
                    El argumento de venta aparecer√° aqu√≠. Seleccione un curso y
                    presione 'Generar Pitch'.
                </div>

                <div
                    id="loading_indicator"
                    class="mt-4 hidden text-center text-blue-600 font-semibold"
                    data-lang-key="status_loading"
                >
                    Cargando an√°lisis de IA y datos de disponibilidad...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==== CONFIGURACI√ìN ====

        // URL GViz de tu Sheet (publicado)
        const SHEET_GVIZ_URL =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vRiopvWS8N7E_A7G10Y85jND6Pl7n2Acgm4tdeQRImxtRuGS1mUuSHyQavLytAelrP1fsLU_8EcHH6e/gviz/tq?gid=2084392899&headers=1";

        // Gemini (rellena tu API key)
        const API_KEY = "";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

        let currentLang = "es";
        let LIVE_COURSE_DATA = [];

        // ==== TRADUCCIONES ====

        const translations = {
            es: {
                title_main: "ü§ñ AI Course Matchmaker (TCM Assistant)",
                subtitle_main:
                    "Herramienta de diagn√≥stico de ventas para asegurar la colocaci√≥n correcta y reducir el churn por expectativas.",
                step1_header: "1. Diagn√≥stico del Estudiante",
                label_age: "Edad del Estudiante (7-17 a√±os):",
                label_interest: "Inter√©s Principal:",
                label_level: "Experiencia Previa (TC Assessment):",
                opt_coding: "Programaci√≥n (L√≥gica)",
                opt_design: "Dise√±o / Arte Digital",
                opt_games: "Creaci√≥n de Videojuegos",
                opt_beginner: "Principiante (Cero experiencia)",
                opt_intermediate: "Intermedio (Sabe bloques/Scratch)",
                opt_advanced: "Avanzado (Sabe Python b√°sico/Roblox)",
                btn_suggest: "üîç Sugerir Cursos (AI Match)",
                btn_pitch: "üé§ Generar Pitch (AI Venta)",
                step2_header: "2. Tres Mejores Opciones y Pitch",
                label_suggested_courses: "Cursos Sugeridos (Top 3 Priorizados):",
                status_waiting: "Esperando diagn√≥stico...",
                label_select_pitch:
                    "Selecciona la Opci√≥n para Generar el Pitch (Ver Pitch de Venta):",
                opt_first_diagnose: "-- Primero Diagnosticar --",
                step3_header: "3. Argumento de Venta (Output de IA)",
                status_pitch_placeholder:
                    "El argumento de venta aparecer√° aqu√≠. Seleccione un curso y presione 'Generar Pitch'.",
                status_loading:
                    "Cargando an√°lisis de IA y datos de disponibilidad...",
                output_details_title: "DETALLES CR√çTICOS DEL GRUPO:",
                output_pitch_title:
                    "ARGUMENTO DE VENTA GENERADO POR IA:",
                output_schedule: "Horario Fijo:",
                output_slots: "Cupos:",
                output_teacher: "Tutor:",
                output_remaining: "restantes",
                output_option: "OPCI√ìN",
                output_critical: "CR√çTICO",
                output_max_urgency: "M√ÅXIMA URGENCIA DE LLENADO",
                error_no_groups:
                    "‚ö†Ô∏è No se encontraron grupos disponibles para este perfil que no est√©n llenos.",
                error_invalid_age:
                    "Por favor, ingresa una edad v√°lida.",
                error_no_option:
                    "Por favor, selecciona un curso de la lista.",
                error_ai_fail:
                    "Error al conectar con el asistente de IA. Usando datos de BO.",
                error_ai_fail_full:
                    "Error al conectar con el asistente de IA. Intenta de nuevo.",
                error_ai_fail_details:
                    "El sistema no pudo generar el argumento de venta, pero aqu√≠ est√°n los datos de disponibilidad de BO:",
                warning_title: "üö® CARGANDO DATOS EN TIEMPO REAL:",
                warning_detail:
                    "Presione Sugerir Cursos para iniciar el diagn√≥stico con datos de Google Sheets."
            },
            en: {
                title_main: "ü§ñ AI Course Matchmaker (TCM Assistant)",
                subtitle_main:
                    "Sales diagnostic tool to ensure correct placement and reduce churn due to expectations.",
                step1_header: "1. Student Diagnosis",
                label_age: "Student Age (7-17 years):",
                label_interest: "Main Interest:",
                label_level: "Previous Experience (TC Assessment):",
                opt_coding: "Coding (Logic)",
                opt_design: "Design / Digital Art",
                opt_games: "Video Game Creation",
                opt_beginner: "Beginner (Zero experience)",
                opt_intermediate:
                    "Intermediate (Knows blocks/Scratch)",
                opt_advanced:
                    "Advanced (Knows basic Python/Roblox)",
                btn_suggest: "üîç Suggest Courses (AI Match)",
                btn_pitch: "üé§ Generate Pitch (AI Sale)",
                step2_header: "2. Top Three Options & Pitch",
                label_suggested_courses:
                    "Suggested Courses (Top 3 Prioritized):",
                status_waiting: "Awaiting diagnosis...",
                label_select_pitch:
                    "Select Option to Generate Pitch (View Sales Pitch):",
                opt_first_diagnose: "-- Diagnose First --",
                step3_header:
                    "3. Sales Pitch Visualization (AI Output)",
                status_pitch_placeholder:
                    "The sales pitch will appear here. Select a course and press 'Generate Pitch'.",
                status_loading:
                    "Loading AI analysis and availability data...",
                output_details_title: "CRITICAL GROUP DETAILS:",
                output_pitch_title:
                    "AI-GENERATED SALES ARGUMENT:",
                output_schedule: "Fixed Schedule:",
                output_slots: "Slots:",
                output_teacher: "Tutor:",
                output_remaining: "remaining",
                output_option: "OPTION",
                output_critical: "CRITICAL",
                output_max_urgency: "MAX FILLING URGENCY",
                error_no_groups:
                    "‚ö†Ô∏è No available groups found for this profile that are not full.",
                error_invalid_age:
                    "Please enter a valid age.",
                error_no_option:
                    "Please select a course from the list.",
                error_ai_fail:
                    "Error connecting to the AI assistant. Using BO data.",
                error_ai_fail_full:
                    "Error connecting to the AI assistant. Try again.",
                error_ai_fail_details:
                    "The system failed to generate the sales pitch, but here is the BO availability data:",
                warning_title: "üö® LOADING LIVE DATA:",
                warning_detail:
                    "Press Suggest Courses to load and diagnose using Google Sheets data."
            },
            ru: {
                title_main:
                    "ü§ñ AI –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è TCM (–ü–æ–¥–±–æ—Ä –ö—É—Ä—Å–æ–≤)",
                subtitle_main:
                    "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂: –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∏ —Å–Ω–∏–∂–∞–µ—Ç –æ—Ç—Ç–æ–∫ –∏–∑-–∑–∞ –∑–∞–≤—ã—à–µ–Ω–Ω—ã—Ö –æ–∂–∏–¥–∞–Ω–∏–π.",
                step1_header: "1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —É—á–µ–Ω–∏–∫–∞",
                label_age:
                    "–í–æ–∑—Ä–∞—Å—Ç —É—á–µ–Ω–∏–∫–∞ (7-17 –ª–µ—Ç):",
                label_interest: "–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–µ—Å:",
                label_level:
                    "–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ–ø—ã—Ç (–ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –¢–ö):",
                opt_coding:
                    "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ (–õ–æ–≥–∏–∫–∞)",
                opt_design:
                    "–î–∏–∑–∞–π–Ω / –¶–∏—Ñ—Ä–æ–≤–æ–µ –ò—Å–∫—É—Å—Å—Ç–≤–æ",
                opt_games: "–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ–∏–≥—Ä",
                opt_beginner: "–ù–∞—á–∞–ª—å–Ω—ã–π (–ù–µ—Ç –æ–ø—ã—Ç–∞)",
                opt_intermediate:
                    "–°—Ä–µ–¥–Ω–∏–π (–ó–Ω–∞–µ—Ç –±–ª–æ–∫–∏/Scratch)",
                opt_advanced:
                    "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (–ó–Ω–∞–µ—Ç –±–∞–∑–æ–≤—ã–π Python/Roblox)",
                btn_suggest:
                    "üîç –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫—É—Ä—Å—ã (AI Match)",
                btn_pitch:
                    "üé§ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ü–∏—Ç—á (AI –ü—Ä–æ–¥–∞–∂–∞)",
                step2_header:
                    "2. –¢—Ä–∏ –ª—É—á—à–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏ –ü–∏—Ç—á",
                label_suggested_courses:
                    "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã (–¢–æ–ø-3):",
                status_waiting:
                    "–û–∂–∏–¥–∞–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...",
                label_select_pitch:
                    "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ü–∏—Ç—á:",
                opt_first_diagnose:
                    "-- –°–Ω–∞—á–∞–ª–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ --",
                step3_header:
                    "3. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ü–∏—Ç—á–∞ (–í—ã–≤–æ–¥ AI)",
                status_pitch_placeholder:
                    "–ê—Ä–≥—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å. –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏ –Ω–∞–∂–º–∏—Ç–µ '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ü–∏—Ç—á'.",
                status_loading:
                    "–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ AI –∏ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...",
                output_details_title:
                    "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò –ì–†–£–ü–ü–´:",
                output_pitch_title:
                    "–°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô –ê–†–ì–£–ú–ï–ù–¢ –î–õ–Ø –ü–†–û–î–ê–ñ–ò:",
                output_schedule: "–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:",
                output_slots: "–ú–µ—Å—Ç–∞:",
                output_teacher: "–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:",
                output_remaining: "–æ—Å—Ç–∞–≤—à–∏–µ—Å—è",
                output_option: "–í–ê–†–ò–ê–ù–¢",
                output_critical: "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô",
                output_max_urgency:
                    "–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –°–†–û–ß–ù–û–°–¢–¨ –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø",
                error_no_groups:
                    "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.",
                error_invalid_age:
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç.",
                error_no_option:
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏–∑ —Å–ø–∏—Å–∫–∞.",
                error_ai_fail:
                    "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI-–ø–æ–º–æ—â–Ω–∏–∫—É. –ò—Å–ø–æ–ª—å–∑—É—é –¥–∞–Ω–Ω—ã–µ BO.",
                error_ai_fail_full:
                    "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI-–ø–æ–º–æ—â–Ω–∏–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                error_ai_fail_details:
                    "–°–∏—Å—Ç–µ–º–∞ –Ω–µ —Å–º–æ–≥–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏, –Ω–æ –≤–æ—Ç –¥–∞–Ω–Ω—ã–µ BO:",
                warning_title:
                    "üö® –¢–†–ï–ë–£–ï–¢–°–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø:",
                warning_detail:
                    "–ù–∞–∂–º–∏—Ç–µ 'Sugerir Cursos', —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets."
            }
        };

        function getTranslation(key) {
            return (
                translations[currentLang][key] ||
                translations["es"][key] ||
                ""
            );
        }

        function updateDynamicElements() {
            document
                .querySelectorAll("[data-lang-key]")
                .forEach((el) => {
                    const key = el.getAttribute("data-lang-key");
                    if (translations[currentLang][key]) {
                        el.textContent =
                            translations[currentLang][key];
                    }
                });

            const updateSelectOptions = (selectId) => {
                const select = document.getElementById(selectId);
                if (!select) return;
                Array.from(select.options).forEach((opt) => {
                    const key = opt.getAttribute("data-lang-key");
                    if (key) opt.textContent = getTranslation(key);
                });
            };

            updateSelectOptions("student_interest");
            updateSelectOptions("student_level");
            updateSelectOptions("selected_course");
        }

        function setLanguage(lang) {
            currentLang = lang;
            updateDynamicElements();
        }

        // ==== HELPERS SHEET ====

        function parseAgeRange(raw) {
            const text = (raw || "").toString().trim();
            let min = 7,
                max = 17;

            const m = text.match(/(\d+)\s*-\s*(\d+)/);
            if (m) {
                min = parseInt(m[1], 10);
                max = parseInt(m[2], 10);
                return { min, max };
            }
            const m2 = text.match(/(\d+)/);
            if (m2) {
                min = parseInt(m2[1], 10);
                max = 17;
            }
            return { min, max };
        }

        function inferInterestAndLevel(title) {
            const t = (title || "").toLowerCase();

            let interest = "coding";
            if (
                t.includes("roblox") ||
                t.includes("minecraft") ||
                t.includes("game")
            ) {
                interest = "games";
            } else if (
                t.includes("design") ||
                t.includes("art") ||
                t.includes("3d") ||
                t.includes("illustration")
            ) {
                interest = "design";
            }

            let level = "beginner";
            if (
                t.includes("advanced") ||
                t.includes("level 3") ||
                t.includes("lvl 3") ||
                t.includes("pro")
            ) {
                level = "advanced";
            } else if (
                t.includes("intermediate") ||
                t.includes("level 2") ||
                t.includes("lvl 2") ||
                t.includes("medium")
            ) {
                level = "intermediate";
            } else if (
                t.includes("beginner") ||
                t.includes("starter") ||
                t.includes("level 1") ||
                t.includes("lvl 1") ||
                t.includes("basic")
            ) {
                level = "beginner";
            }

            return { interest, level };
        }

        function getFillRatio(course) {
            if (!course.capacity || course.enrolled >= course.capacity)
                return 0;
            return course.enrolled / course.capacity;
        }

        function getCourseName(course) {
            const nameField = "name_" + currentLang;
            return course[nameField] || course.name_es;
        }

        function parseSheetData(rawText) {
            const jsonMatch = rawText.match(
                /google\.visualization\.Query\.setResponse\((.*)\);/s
            );
            if (!jsonMatch || jsonMatch.length < 2) {
                throw new Error(
                    "No se pudo extraer el JSON de la respuesta GViz."
                );
            }
            const cleanText = jsonMatch[1];
            const data = JSON.parse(cleanText);

            if (
                !data ||
                data.status !== "ok" ||
                !data.table ||
                !data.table.rows
            ) {
                throw new Error(
                    "GViz no devolvi√≥ una tabla v√°lida."
                );
            }

            const rows = data.table.rows;
            const courses = [];

            rows.forEach((row) => {
                const c = row.c;
                if (!c) return;

                const groupTitle = c[1]?.v || "";
                const courseTitle = c[3]?.v || "";
                const courseAge = c[4]?.v || "";
                const capacity = c[5]?.v
                    ? parseInt(c[5].v, 10)
                    : 0;
                const enrolled = c[6]?.v
                    ? parseInt(c[6].v, 10)
                    : 0;
                const status = (c[7]?.v || "")
                    .toString()
                    .toLowerCase();
                const teacher = c[8]?.v || "Tutor N/A";

                if (!groupTitle || !capacity) return;
                if (
                    status.includes("cancel") ||
                    status.includes("closed") ||
                    status.includes("inactive")
                )
                    return;

                const { min, max } = parseAgeRange(courseAge);
                const { interest, level } =
                    inferInterestAndLevel(courseTitle);

                const dateText =
                    c[9] ? c[9].f || c[9].v || "" : "";
                const timeText =
                    c[10] ? c[10].f || c[10].v || "" : "";
                const schedule =
                    (dateText + " " + timeText).trim() ||
                    "N/A";

                courses.push({
                    id: c[0]?.v || "ID-" + Math.random(),
                    name_es: groupTitle,
                    name_en: groupTitle,
                    name_ru: groupTitle,
                    topic: courseTitle,
                    min_age: min,
                    max_age: max,
                    interest,
                    level,
                    enrolled,
                    capacity,
                    next_start: schedule,
                    teacher
                });
            });

            return courses.filter(
                (c) => c.enrolled < c.capacity
            );
        }

        async function fetchCourseData() {
            const resultsDiv =
                document.getElementById(
                    "course_recommendation"
                );
            try {
                const resp = await fetch(SHEET_GVIZ_URL);
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}`);
                }
                const text = await resp.text();
                const courses = parseSheetData(text);
                LIVE_COURSE_DATA = courses;
                if (resultsDiv) {
                    resultsDiv.innerHTML =
                        getTranslation("status_waiting");
                }
                return courses;
            } catch (err) {
                console.error(
                    "Error al obtener datos de Google Sheets:",
                    err
                );
                if (resultsDiv) {
                    resultsDiv.innerHTML = `<span class="text-red-600 font-semibold">
                        Error al conectar con Google Sheets. Verifica que el documento est√© publicado y accesible.
                    </span>`;
                }
                throw err;
            }
        }

        // ==== L√ìGICA PRINCIPAL ====

        async function diagnoseAndMatch() {
            const resultsDiv =
                document.getElementById(
                    "course_recommendation"
                );
            const selectElement =
                document.getElementById(
                    "selected_course"
                );
            const ageInput =
                document.getElementById("student_age");

            if (LIVE_COURSE_DATA.length === 0) {
                resultsDiv.innerHTML = `<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> ${getTranslation(
                    "status_loading"
                )}</span>`;
                selectElement.innerHTML = `<option value="">${getTranslation(
                    "opt_first_diagnose"
                )}</option>`;
                try {
                    await fetchCourseData();
                } catch {
                    return;
                }
            }

            const age = parseInt(ageInput.value, 10);
            const interest =
                document.getElementById(
                    "student_interest"
                ).value;
            const level =
                document.getElementById(
                    "student_level"
                ).value;

            if (isNaN(age) || age < 7 || age > 17) {
                resultsDiv.innerHTML = `<span class="text-red-600 font-semibold">${getTranslation(
                    "error_invalid_age"
                )}</span>`;
                return;
            }

            let compatibleCourses = LIVE_COURSE_DATA.filter(
                (course) =>
                    age >= course.min_age &&
                    age <= course.max_age &&
                    course.interest === interest &&
                    course.enrolled < course.capacity
            );

            if (level === "beginner") {
                compatibleCourses =
                    compatibleCourses.filter(
                        (c) =>
                            c.level === "beginner" ||
                            c.level === "intermediate"
                    );
            } else if (level === "intermediate") {
                compatibleCourses =
                    compatibleCourses.filter(
                        (c) => c.level !== "beginner"
                    );
            }

            compatibleCourses.sort(
                (a, b) => getFillRatio(b) - getFillRatio(a)
            );

            const top3Options =
                compatibleCourses.slice(0, 3);

            if (top3Options.length === 0) {
                resultsDiv.innerHTML = `<span class="text-red-600 font-semibold">${getTranslation(
                    "error_no_groups"
                )}</span>`;
                selectElement.innerHTML = `<option value="">${getTranslation(
                    "opt_first_diagnose"
                )}</option>`;
                return;
            }

            let html = "";
            top3Options.forEach((course, index) => {
                const remaining =
                    course.capacity - course.enrolled;
                const courseName = getCourseName(course);
                const isCritical = remaining <= 2;
                const urgencyClass = isCritical
                    ? "text-orange-600 font-bold"
                    : "text-gray-600";

                html += `<p class="mb-1 ${
                    isCritical
                        ? "bg-red-50 p-1 rounded-md"
                        : ""
                }"><b>${getTranslation(
                    "output_option"
                )} ${index + 1}: ${courseName}</b></p>`;
                html += `<ul class="ml-4 list-disc text-sm text-gray-700">`;
                html += `<li>‚è∞ <b>${getTranslation(
                    "output_schedule"
                )}</b> ${course.next_start}</li>`;
                html += `<li class="${urgencyClass}">üíª <b>${getTranslation(
                    "output_slots"
                )}</b> ${course.enrolled}/${
                    course.capacity
                } (${remaining} ${getTranslation(
                    "output_remaining"
                )})</li>`;
                html += `<li>üë®‚Äçüè´ <b>${getTranslation(
                    "output_teacher"
                )}</b> ${course.teacher}</li>`;
                if (isCritical) {
                    html += `<li class="text-red-600 font-bold">üö® ${getTranslation(
                        "output_max_urgency"
                    )} üö®</li>`;
                }
                html += `</ul><hr class="my-2 border-gray-200">`;
            });

            resultsDiv.innerHTML = html;

            selectElement.innerHTML = `<option value="">${getTranslation(
                "opt_first_diagnose"
            )}</option>`;
            top3Options.forEach((course) => {
                const courseName = getCourseName(course);
                const remaining =
                    course.capacity - course.enrolled;
                const urgencyTag =
                    remaining <= 2
                        ? ` (${getTranslation(
                              "output_critical"
                          )} - ${remaining} ${getTranslation(
                              "output_remaining"
                          )})`
                        : "";
                selectElement.innerHTML += `<option value="${
                    course.id
                }">${courseName} - ${
                    course.next_start
                }${urgencyTag}</option>`;
            });

            document.getElementById(
                "pitch_output"
            ).innerHTML =
                getTranslation("status_pitch_placeholder");
        }

        async function generatePitch() {
            const selectedCourseId =
                document.getElementById(
                    "selected_course"
                ).value;
            const loadingIndicator =
                document.getElementById(
                    "loading_indicator"
                );
            const pitchOutputDiv =
                document.getElementById(
                    "pitch_output"
                );

            if (!selectedCourseId) {
                pitchOutputDiv.innerHTML =
                    getTranslation("error_no_option");
                return;
            }

            const course = LIVE_COURSE_DATA.find(
                (c) => c.id === selectedCourseId
            );
            if (!course) return;

            const remaining =
                course.capacity - course.enrolled;

            loadingIndicator.classList.remove("hidden");
            pitchOutputDiv.innerHTML = "";

            const pitchLanguage =
                currentLang === "ru"
                    ? "ruso"
                    : currentLang === "en"
                    ? "ingl√©s"
                    : "espa√±ol";

            const systemPrompt = `Act√∫a como un vendedor (TCM) experto en Kodland. Tu objetivo es generar un argumento de venta (pitch) persuasivo. El pitch debe ser en ${pitchLanguage}, conciso (m√°ximo 150 palabras), y debe centrarse en el valor educativo y los logros del curso (${course.topic}). NO menciones el cupo o la fecha de inicio a menos que sea para generar urgencia.`;

            const userQuery = `Genera un pitch de venta enfocado en el contenido y valor para el curso ${getCourseName(
                course
            )}. El estudiante tiene ${
                document.getElementById(
                    "student_age"
                ).value
            } a√±os. Las caracter√≠sticas clave del contenido son: [T√≥picos: ${
                course.topic
            }], [Nivel: ${course.level}].`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                let response;
                const maxRetries = 3;
                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    response = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    if (attempt === maxRetries - 1) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`
                        );
                    }
                    await new Promise((r) =>
                        setTimeout(r, Math.pow(2, attempt) * 1000)
                    );
                }

                const result = await response.json();
                const generatedText =
                    result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!generatedText) {
                    throw new Error("API returned no text content.");
                }

                const boInfo = `
<div class="mb-4 p-2 bg-blue-100 rounded-lg">
    <b>${getTranslation(
        "output_details_title"
    )}</b>
    <ul>
        <li>üìÖ <b>${getTranslation(
            "output_schedule"
        )}</b> ${course.next_start}</li>
        <li>üßë‚Äçüíª <b>${getTranslation(
            "output_slots"
        )}</b> ${remaining} de ${
                    course.capacity
                } ${getTranslation("output_remaining")}.</li>
        <li>üë®‚Äçüè´ <b>${getTranslation(
            "output_teacher"
        )}</b> ${course.teacher}</li>
    </ul>
</div>

<b>${getTranslation(
    "output_pitch_title"
)}</b>
<p style="margin-top:10px;line-height:1.6;">${generatedText
        .replace(/\n/g, "<br>")
        }</p>`;

                pitchOutputDiv.innerHTML = boInfo;
            } catch (err) {
                console.error(
                    "Error al llamar a la API de Gemini:",
                    err
                );
                const boFallback = `
<div class="mb-4 p-2 bg-red-100 rounded-lg">
    <b class="text-red-700">‚ö†Ô∏è ${getTranslation(
        "error_ai_fail"
    )}</b>
    <p>${getTranslation(
        "error_ai_fail_details"
    )}</p>
    <ul>
        <li>üìÖ <b>${getTranslation(
            "output_schedule"
        )}</b> ${course.next_start}</li>
        <li>üßë‚Äçüíª <b>${getTranslation(
            "output_slots"
        )}</b> ${remaining} de ${
                    course.capacity
                } ${getTranslation("output_remaining")}.</li>
        <li>üë®‚Äçüè´ <b>${getTranslation(
            "output_teacher"
        )}</b> ${course.teacher}</li>
    </ul>
</div>`;
                pitchOutputDiv.innerHTML = boFallback;
            } finally {
                loadingIndicator.classList.add("hidden");
            }
        }

        // ==== INIT ====

        window.onload = () => {
            setLanguage("es");
            document.getElementById("student_age").value = 10;
            document.getElementById("student_interest").value =
                "coding";
            document.getElementById("student_level").value =
                "beginner";

            const resultsDiv =
                document.getElementById(
                    "course_recommendation"
                );
            resultsDiv.innerHTML = `<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> ${getTranslation(
                "status_loading"
            )}</span>`;

            fetchCourseData().catch(() => {});
        };
    </script>
</body>
</html>


