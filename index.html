<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Course Matchmaker (TCM Assistant)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    body { font-family: 'Inter', sans-serif; background-color:#f8fafc; }
    #app-container { max-width:1400px; margin:40px auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.05); }
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:20px; }
    .step-header { background:#f1f5f9; padding:10px 15px; border-radius:8px; font-weight:600; color:#1e293b; margin-bottom:15px; }
    .result-box { min-height:120px; background:#f9fafb; border-radius:8px; padding:12px 14px; margin-top:8px; border:1px solid #e5e7eb; white-space:normal; }
    .ai-result-box { background:#ecfdf5; border-left:4px solid #10b981; padding:15px; border-radius:6px; }
    .error-box { background:#fef2f2; border-left:4px solid #ef4444; padding:15px; border-radius:6px; margin:10px 0; }
    .warning-box { background:#fffbeb; border-left:4px solid #f59e0b; padding:15px; border-radius:6px; margin:10px 0; }
    .success-box { background:#f0fdf4; border-left:4px solid #22c55e; padding:15px; border-radius:6px; margin:10px 0; }
    .course-option { border-radius:10px; border:1px solid #e5e7eb; background:#fff; padding:10px 12px; margin-bottom:10px; }
    .course-option.critical { background:#fef2f2; border-color:#fecaca; }
    .course-option.almost-full { background:#fffbeb; border-color:#fcd34d; }
    .course-option.selected { background:#dbeafe; border:2px solid #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .course-option.possible-group { background:#f0fdf4; border-color:#86efac; }
    .course-option-title { font-weight:600; margin-bottom:6px; color:#111827; }
    .course-option-row { font-size:.875rem; color:#374151; margin-bottom:2px; }
    .course-option-row strong { font-weight:600; }
    .course-option-urgency { font-size:.85rem; margin-top:4px; }
    .course-option-urgency.critical-text { color:#b91c1c; font-weight:700; }
    .course-option-urgency.warning-text { color:#d97706; font-weight:600; }
    .course-option-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-top: 4px; }
    .badge-possible { background: #d1fae5; color: #065f46; }
    .badge-active { background: #dbeafe; color: #1e40af; }
    .connection-status { position: fixed; top: 20px; right: 20px; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; z-index: 1000; }
    .connection-status.connected { background: #22c55e; color: white; }
    .connection-status.disconnected { background: #ef4444; color: white; }
    .connection-status.loading { background: #3b82f6; color: white; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; display: none; }
    .modal-overlay.active { display: block; }
    .modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; z-index: 9999; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: none; }
    .modal-container.active { display: block; }
    .modal-header { position: sticky; top: 0; background: white; padding: 20px; border-bottom: 2px solid #e5e7eb; z-index: 10; }
    .modal-body { padding: 20px; }
    .btn-select { padding: 8px 16px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .btn-select.selected { background: #3b82f6; color: white; }
    .btn-select.unselected { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
    .btn-select.unselected:hover { background: #e5e7eb; }
    .btn-select.disabled { opacity: 0.5; cursor: not-allowed; }
    .schedule-btn { background: #f97316; color: white; padding: 10px 16px; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.15s; width: 100%; margin-top: 12px; border: none; }
    .schedule-btn:hover { background: #ea580c; }
    .schedule-btn.selected { background: #22c55e; }
  </style>
</head>

<body>
  <div id="connection-status" class="connection-status loading">
    <i class="fas fa-spinner fa-spin"></i> Conectando...
  </div>

  <div id="language-selector" class="flex justify-end max-w-7xl mx-auto mt-4 px-4">
    <select onchange="setLanguage(this.value)" class="p-2 border border-gray-300 rounded-lg text-sm">
      <option value="es" selected>Espa√±ol (ES)</option>
      <option value="en">English (EN)</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π (RU)</option>
    </select>
  </div>

  <div id="app-container">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-4 text-center">
      ü§ñ AI Course Matchmaker (TCM Assistant)
    </h1>
    <p class="text-center text-gray-600 mb-6">
      Herramienta de diagn√≥stico de ventas para asegurar la colocaci√≥n correcta y reducir el churn por expectativas.
    </p>

    <div id="system-messages"></div>

    <!-- FILA SUPERIOR: 3 COLUMNAS -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

      <!-- COLUMNA 1: Diagn√≥stico -->
      <div class="card">
        <div class="step-header">1. Diagn√≥stico del Estudiante</div>

        <label for="amo_crm_link" class="block text-sm font-medium text-gray-700 mb-1">
          üîó amo CRM Link:
        </label>
        <input type="url" id="amo_crm_link" placeholder="https://kodland.amocrm.com/leads/detail/..."
               class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" />

        <label for="tcm_name" class="block text-sm font-medium text-gray-700 mb-1">
          üë§ Nombre del TCM:
        </label>
        <select id="tcm_name" required
               class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
          <option value="">-- Selecciona tu nombre --</option>
          <option value="TCM 1">TCM 1</option>
          <option value="TCM 2">TCM 2</option>
          <option value="TCM 3">TCM 3</option>
          <option value="TCM 4">TCM 4</option>
          <option value="TCM 5">TCM 5</option>
          <option value="TCM 6">TCM 6</option>
          <option value="TCM 7">TCM 7</option>
          <option value="TCM 8">TCM 8</option>
          <option value="TCM 9">TCM 9</option>
          <option value="TCM 10">TCM 10</option>
          <option value="TCM 11">TCM 11</option>
          <option value="TCM 12">TCM 12</option>
          <option value="TCM 13">TCM 13</option>
          <option value="TCM 14">TCM 14</option>
          <option value="TCM 15">TCM 15</option>
          <option value="TCM 16">TCM 16</option>
          <option value="TCM 17">TCM 17</option>
          <option value="TCM 18">TCM 18</option>
          <option value="TCM 19">TCM 19</option>
          <option value="TCM 20">TCM 20</option>
        </select>
        
        <label for="student_age" class="block text-sm font-medium text-gray-700 mb-1">
          Edad del Estudiante (7-17 a√±os):
        </label>
        <input type="number" id="student_age" min="7" max="17" value="10"
               class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" />

        <label for="student_interest" class="block text-sm font-medium text-gray-700 mb-1">
          Inter√©s Principal:
        </label>
        <select id="student_interest"
                class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
                <option value="coding">Coding y Videojuegos</option>
                <option value="design">Media y Dise√±o</option>
        </select>

        <label for="client_timezone" class="block text-sm font-medium text-gray-700 mb-1">
          üåç Zona Horaria:
        </label>
        <select id="client_timezone" onchange="updateTimezoneDisplay()" 
                class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm">
          </select>

        <label for="course_type" class="block text-sm font-medium text-gray-700 mb-1">
          Tipo de Curso Espec√≠fico:
        </label>
        <select id="course_type" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
          <option value="">-- Selecciona el curso --</option>
          <option value="python">Python (B√°sico)</option>
          <option value="python_pro">Python Pro</option>
          <option value="scratch">Scratch</option>
          <option value="roblox">Roblox</option>
          <option value="roblox_lvl2">Roblox Nivel 2</option>
          <option value="minecraft">Minecraft</option>
          <option value="minecraft_lvl2">Minecraft Nivel 2</option>
          <option value="digital_creativity">Creatividad Digital</option>
          <option value="digital_creativity_lvl2">Creatividad Digital Nivel 2</option>
          <option value="drawing">Drawing</option>
          <option value="ilustracion">Ilustraci√≥n</option>
          <option value="graphic_design">Dise√±o Gr√°fico</option>
          <option value="fwd_pro">FWD Pro (Mundos Fant√°sticos)</option>
          <option value="unity">Unity</option>
          <option value="web">Desarrollo Web</option>
          <option value="funtech">FunTech</option>
        </select>

        <label for="group_type" class="block text-sm font-medium text-gray-700 mb-1">
          Tipo de Grupo:
        </label>
        <select id="group_type"
                class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
          <option value="regular">Regular</option>
          <option value="premium">Premium (PRM)</option>
        </select>

        <button id="btn_select_schedule" onclick="openPreferredScheduleModal()" class="schedule-btn">
          üïê Seleccionar Horario Preferido
        </button>
        <div id="schedule-summary" class="text-xs text-gray-600 mt-2 hidden"></div>

        <div class="flex items-center mb-4 mt-4 p-3 bg-gray-50 rounded-lg">
          <input type="checkbox" id="is_sen" 
                 class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
          <label for="is_sen" class="ml-2 text-sm font-medium text-gray-700">
            ‚≠ê Estudiante SEN (Special Educational Needs)
          </label>
        </div>

        <button id="btn_suggest"
                onclick="diagnoseAndMatch()"
                class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">
          üîç Sugerir Cursos (AI Match)
        </button>

        <div class="mt-2 text-xs text-gray-500">
          <span id="data-source-info">Data source: <b>Conectando...</b></span>
        </div>
      </div>

      <!-- COLUMNA 2: TOP 3 GRUPOS ACTIVOS -->
      <div class="card">
        <div class="step-header">2. Grupos Activos (Top 3)</div>

        <label class="block text-sm font-medium text-gray-700 mb-1">
          Cursos Activos Sugeridos:
        </label>
        <div id="course_recommendation" class="result-box text-gray-800 text-sm">
          Esperando diagn√≥stico...
        </div>
      </div>

      <!-- COLUMNA 3: GRUPOS POSIBLES -->
      <div class="card">
        <div class="step-header">3. Grupos Posibles (Top 3)</div>

        <label class="block text-sm font-medium text-gray-700 mb-1">
          Grupos Creados por Demanda:
        </label>
        <div id="possible_groups_list" class="result-box text-gray-600 text-sm">
          <div class="text-center py-4">
            <i class="fas fa-hourglass-half text-gray-400 text-2xl mb-2"></i>
            <p>Esperando diagn√≥stico...</p>
          </div>
        </div>
      </div>

    </div>

    <!-- FILA INFERIOR: 2 COLUMNAS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- COLUMNA 1: ARGUMENTO DE VENTA -->
      <div class="card">
        <div class="step-header">4. Argumento de Venta (Output de IA)</div>

        <label for="selected_course" class="block text-sm font-medium text-gray-700 mb-1">
          Selecciona la Opci√≥n para Generar el Pitch:
        </label>
        <select id="selected_course"
                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4">
          <option value="">-- Selecciona un curso primero --</option>
        </select>

        <button id="btn_pitch"
                onclick="generatePitch()"
                class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150">
          üé§ Generar Pitch (AI Venta)
        </button>

        <div id="pitch_output" class="ai-result-box text-gray-800 text-sm mt-4">
          El argumento de venta aparecer√° aqu√≠. Seleccione un curso y presione 'Generar Pitch'.
        </div>

        
      </div>

      <!-- COLUMNA 2: ENVIAR VENTA -->
      <div class="card bg-gradient-to-br from-blue-50 to-purple-50">
        <div class="step-header bg-blue-100">5. Confirmar y Enviar Venta</div>

        <div id="sale-summary" class="mb-4 p-3 bg-white rounded-lg border border-blue-200">
          <h3 class="font-semibold text-gray-800 mb-2">üìã Resumen de la Venta:</h3>
          <div id="summary-content" class="text-sm text-gray-600">
            Completa el diagn√≥stico y selecciona un curso para ver el resumen.
          </div>
        </div>

        <button id="btn_submit_sale"
                onclick="submitSale()"
                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
        üíæ Guardar
        </button>

        <p class="text-xs text-gray-500 mt-2 text-center">
          Los datos se guardar√°n en el Google Sheet de TCM Sales
        </p>
      </div>

    </div>
  </div>

  <!-- Modal para ver todos los cursos activos -->
  <div id="modal-overlay" class="modal-overlay" onclick="closeCoursesModal()"></div>
  <div id="courses-modal" class="modal-container">
    <div class="modal-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Todos los Cursos Activos Disponibles</h2>
          <p class="text-sm text-gray-600 mt-1">Selecciona hasta 2 cursos para generar pitch</p>
        </div>
        <button onclick="closeCoursesModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
          √ó
        </button>
      </div>
      <div id="selected-count" class="mt-3 text-sm font-semibold text-blue-600"></div>
    </div>
    <div id="modal-courses-list" class="modal-body"></div>
  </div>

  <!-- Modal para ver todos los grupos posibles -->
  <div id="possible-modal-overlay" class="modal-overlay" onclick="closePossibleGroupsModal()"></div>
  <div id="possible-groups-modal" class="modal-container">
    <div class="modal-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Todos los Grupos Posibles Disponibles</h2>
          <p class="text-sm text-gray-600 mt-1">Grupos creados por demanda de estudiantes</p>
        </div>
        <button onclick="closePossibleGroupsModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
          √ó
        </button>
      </div>
    </div>
    <div id="modal-possible-groups-list" class="modal-body"></div>
  </div>

  <!-- Modal para Preferred Schedule -->
  <div id="schedule-modal-overlay" class="modal-overlay" onclick="closeScheduleModal()"></div>
  <div id="schedule-modal" class="modal-container">
    <div class="modal-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 class="text-xl font-bold text-gray-900">üïê Selecciona tu Horario Preferido</h2>
          <p class="text-sm text-gray-600 mt-1">Marca los horarios que te funcionan (puedes seleccionar varios)</p>
        </div>
        <button onclick="closeScheduleModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
          √ó
        </button>
      </div>
    </div>
    <div class="modal-body">
      <div style="overflow-x: auto;">
        <table class="w-full border-collapse text-sm">
          <thead>
            <tr class="bg-gray-100">
              <th class="border p-2 font-semibold">Hora</th>
              <th class="border p-2 font-semibold">Lun</th>
              <th class="border p-2 font-semibold">Mar</th>
              <th class="border p-2 font-semibold">Mi√©</th>
              <th class="border p-2 font-semibold">Jue</th>
              <th class="border p-2 font-semibold">Vie</th>
              <th class="border p-2 font-semibold">S√°b</th>
              <th class="border p-2 font-semibold">Dom</th>
            </tr>
          </thead>
          <tbody id="schedule-table-body"></tbody>
        </table>
      </div>
      <button onclick="submitPreferredSchedule()" 
              class="w-full bg-orange-600 text-white p-3 rounded-lg font-semibold hover:bg-orange-700 transition duration-150 mt-4">
        ‚úÖ Confirmar Horarios Seleccionados
      </button>
    </div>
  </div>

  <script>

// ============================================
// CONFIGURACI√ìN DE SPREADSHEETS (MODO P√öBLICO)
// ============================================

// 1. IDs de las Hojas PUBLICADAS EN LA WEB (Empiezan por 2PACX...)
const SHEET_ID = "2PACX-1vRiopvWS8N7E_A7G10Y85jND6Pl7n2Acgm4tdeQRImxtRuGS1mUuSHyQavLytAelrP1fsLU_8EcHH6e";
const SHEET_GID = "2084392899"; // GID de la pesta√±a de Activos en la versi√≥n p√∫blica

const POSSIBLE_GROUPS_SHEET_ID = "2PACX-1vRfJ1Dc2mTlooFRM6Jc0r-zKyrjmbWFGCOaT3UeiOc0vyihrxBL8UaN3n8Z0QxxJDfSEwzQYn1-YmIM";
const POSSIBLE_GROUPS_GID = "1601359885";

// 2. Tu Nuevo Script de Registro de Ventas (Este lo dejamos nuevo)
const SALES_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkhc55bmSOhSDHTQhrLuq4cqC2xJ1oJO5a-xythsjrgMo-KBPACj0zCiDnpHxm_vR0Lg/exec";

// 3. Configuraci√≥n de Conexi√≥n (Sin Proxy)
const USE_CORS_PROXY = false; 
const CORS_PROXY = ""; // Ya no se usa

const DATA_SOURCES = {
  active: {
    // Usamos la estructura /pub que permite acceso directo
    csv: `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv`,
    json: `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`
  },
  possible: {
    csv: `https://docs.google.com/spreadsheets/d/e/${POSSIBLE_GROUPS_SHEET_ID}/pub?gid=${POSSIBLE_GROUPS_GID}&single=true&output=csv`,
    json: `https://docs.google.com/spreadsheets/d/e/${POSSIBLE_GROUPS_SHEET_ID}/gviz/tq?tqx=out:json&gid=${POSSIBLE_GROUPS_GID}`
  }
};


// ==========================================
// DICCIONARIO MAESTRO (SOLO IDs - L√ìGICA PURA) (SOLUCI√ìN PROBLEMA 1)
// ==========================================
const COURSE_MASTER_MAP = {
  "python":                  [1116],
  "python_pro":              [1218],
  "scratch":                 [1189],
  "roblox":                  [1210, 1720],
  "roblox_lvl2":             [1442],
  "minecraft":               [1618],
  "minecraft_lvl2":          [1713],
  "digital_creativity":      [1354], // Nivel 1
  "digital_creativity_lvl2": [1215], // Nivel 2
  "drawing":                 [1627],
  "ilustracion":             [1431],
  "graphic_design":          [1344],
  "fwd_pro":                 [1219],
  "unity":                   [1209],
  "web":                     [1220],
  "funtech":                 [1696] // Dej√© √∫nicamente el ID de Funtech una vez por semana
};

// ============================================
// BASE DE DATOS DE CURSOS - INFORMACI√ìN COMPLETA
// ============================================
const COURSE_GUIDELINES = {
  "funtech": {
    name: "FunTech Explorers",
    age_range: { min: 5, max: 7 },
    keywords: ["funtech", "explorers"],
    interest_profile: "Descubrir el mundo digital, aprender a usar el computador",
    min_requirements: "Ninguno (es para quienes no saben usar mouse/teclado)",
    tech_requirements: "PC o Port√°til (Windows/Mac), Zoom, Chrome",
    tools: "Scratch Junior, Google Docs, Google Slides, Google Sheets, Brush Ninja, Gartic Phone",
    soft_skills: "L√≥gica, trabajo en equipo, pensamiento creativo",
    hard_skills: "Manejo de mouse y teclado, estructura de carpetas, algoritmos b√°sicos, animaci√≥n GIF, creaci√≥n de presentaciones",
    complementary_course: "La magia del c√≥digo con Scratch (una vez cumplan 8 a√±os o dominen lectoescritura)",
    key_selling_points: [
      "Curso perfecto para iniciar en el mundo digital",
      "No requiere conocimientos previos",
      "Aprenden jugando y creando",
      "Base s√≥lida para futuros cursos de programaci√≥n"
    ]
  },
  
  "scratch": {
    name: "La Magia del C√≥digo con Scratch",
    age_range: { min: 8, max: 12 },
    keywords: ["scratch", "magia", "c√≥digo"],
    interest_profile: "Crear historias interactivas, juegos y animaciones",
    min_requirements: "Saber leer y escribir, manejo b√°sico de PC",
    tech_requirements: "PC o Port√°til (Windows/Mac)",
    tools: "Scratch (versi√≥n web/escritorio)",
    soft_skills: "Storytelling (narraci√≥n), resoluci√≥n de problemas, pensamiento l√≥gico",
    hard_skills: "Coordenadas, variables, bucles, condicionales, depuraci√≥n de errores (debugging), clones",
    complementary_course: "Creatividad Digital 1 (para mejorar sus gr√°ficos) o Roblox (para saltar al 3D)",
    key_selling_points: [
      "Est√°ndar mundial para aprender programaci√≥n",
      "Desarrolla pensamiento l√≥gico jugando",
      "Crea sus propios juegos y animaciones",
      "Preparaci√≥n perfecta para lenguajes profesionales"
    ]
  },
  
  "roblox_8_9": {
    name: "Roblox Game Developer",
    age_range: { min: 8, max: 9 },
    keywords: ["roblox"],
    interest_profile: "Jugar videojuegos, crear sus propios mundos y reglas",
    min_requirements: "Lectoescritura fluida (deben escribir c√≥digo)",
    tech_requirements: "8GB RAM (M√≠nimo), Tarjeta gr√°fica dedicada (o integrada reciente), Mouse con rueda",
    tools: "Roblox Studio, Lenguaje LUA",
    soft_skills: "Trabajo en equipo, monetizaci√≥n b√°sica, paciencia (testing)",
    hard_skills: "Modelado 3D b√°sico (bloques), Scripting LUA (Variables, Bucles, Funciones), Edici√≥n de terreno, GUI (Interfaces)",
    complementary_course: "Creatividad Digital (para dise√±ar texturas)",
    key_selling_points: [
      "Aprende a programar en LUA mientras crea juegos",
      "Posibilidad de publicar juegos en la plataforma Roblox",
      "Desarrollo 3D desde temprana edad",
      "Puede monetizar sus creaciones en el futuro"
    ]
  },
  
  "roblox_10_12": {
    name: "Roblox Game Developer (Avanzado)",
    age_range: { min: 10, max: 12 },
    keywords: ["roblox"],
    interest_profile: "Videojuegos, mec√°nica de juegos avanzada, programaci√≥n",
    min_requirements: "Manejo fluido de teclado y mouse, l√≥gica b√°sica",
    tech_requirements: "8GB RAM, Tarjeta gr√°fica dedicada, Mouse con rueda",
    tools: "Roblox Studio, Lenguaje LUA",
    soft_skills: "Dise√±o de juegos (Game Design), planificaci√≥n de proyectos",
    hard_skills: "F√≠sica de juegos, Animaci√≥n de objetos, Scripting LUA avanzado (Condicionales complejos), Monetizaci√≥n (Game Passes), NPCs",
    complementary_course: "Python New (para fortalecer la l√≥gica de c√≥digo escrito)",
    key_selling_points: [
      "Versi√≥n m√°s avanzada y profunda de Roblox",
      "Aprende mec√°nicas profesionales de Game Design",
      "Programaci√≥n LUA avanzada con f√≠sica y animaci√≥n",
      "Preparaci√≥n para desarrollo profesional de videojuegos"
    ]
  },
  
    "python_new": {
    name: "Python New (Fundamentos)",
    age_range: { min: 10, max: 17 },
    keywords: ["python new", "python fundamentos", "python b√°sico", "pythonnew"],
    interest_profile: "L√≥gica pura, 'hackers', crear software real, automatizaci√≥n",
    min_requirements: "Pensamiento l√≥gico avanzado, ingl√©s b√°sico (para comandos como print, while)",
    tech_requirements: "PC/Mac, Teclado y Mouse",
    tools: "Python, Librer√≠a PyGame Zero",
    soft_skills: "Trabajo en equipo (desarrollo grupal), presentaci√≥n de proyectos",
    hard_skills: "Sintaxis de Python, Tipos de datos (listas, diccionarios), Ciclos (While/For), L√≥gica booleana, Desarrollo de juegos 2D",
    complementary_course: "Dise√±o Web (para interfaz) o Unity (siguiente paso en juegos)",
    key_selling_points: [
      "Primer paso hacia programaci√≥n profesional",
      "Python es el lenguaje #1 en el mundo",
      "Base para Inteligencia Artificial y Data Science",
      "Crear software real desde el primer d√≠a"
    ]
  },
  
"python_pro": {
  name: "Python Pro",
  age_range: { min: 13, max: 17 },
  keywords: ["[1218] python", "python lvl2", "python lvl 2", "python level 2", "python pro", "pythonpro", "python avanzado", "python advanced"],
  interest_profile: "Inteligencia Artificial, Bots, Back-end, Datos",
  min_requirements: "Haber completado Python B√°sico o examen de validaci√≥n",
  tech_requirements: "PC/Mac",
  tools: "Python, Discord.py, Git/GitHub, Flask (Web), Google Colab (IA)",
  soft_skills: "Metodolog√≠as √Ågiles (Scrum), Revisi√≥n de c√≥digo (Code Review)",
  hard_skills: "POO (Programaci√≥n Orientada a Objetos), APIs, Desarrollo Web Backend, Machine Learning (IA), S√≠ntesis de voz",
  complementary_course: "Dise√±o Web (para conectar con Flask)",
  key_selling_points: [
    "Nivel profesional: IA, bots y desarrollo web",
    "Aprende Machine Learning e Inteligencia Artificial",
    "Crea aplicaciones web completas",
    "Preparaci√≥n para universidad o trabajo tech"
  ]
},
  
  "creatividad_1": {
    name: "Creatividad Digital Nivel 1",
    age_range: { min: 8, max: 9 },
    keywords: ["creatividad", "digital", "arte", "nivel 1"],
    interest_profile: "Dibujar, pintar, crear caricaturas",
    min_requirements: "Manejo b√°sico de mouse",
    tech_requirements: "PC/Mac (Uso intensivo de mouse para dibujar)",
    tools: "Kleki (Dibujo), FlipAnim (Animaci√≥n), 123Apps (Edici√≥n video)",
    soft_skills: "Expresi√≥n emocional, creatividad visual",
    hard_skills: "Pixel Art, uso de capas, animaci√≥n cuadro por cuadro, Storyboarding, edici√≥n de video b√°sica",
    complementary_course: "Scratch (para dar vida interactiva a sus dibujos)",
    key_selling_points: [
      "Desarrolla expresi√≥n art√≠stica digital",
      "Aprende t√©cnicas profesionales de animaci√≥n",
      "Crea su propio contenido visual",
      "Base para dise√±o gr√°fico profesional"
    ]
  },
  
  "creatividad_2": {
    name: "Creatividad Digital Nivel 2",
    age_range: { min: 10, max: 12 },
    keywords: ["creatividad", "digital", "dise√±o", "nivel 2"],
    interest_profile: "Dise√±o, logos, animaci√≥n m√°s compleja, 3D",
    min_requirements: "Manejo de PC",
    tech_requirements: "PC/Mac",
    tools: "Canva, Krita, WickEditor, Spline (3D), Figma, WIX",
    soft_skills: "Autopresentaci√≥n, creaci√≥n de portafolio",
    hard_skills: "Dise√±o vectorial, Branding (Libro de marca), Ilustraci√≥n digital, Modelado 3D b√°sico, Creaci√≥n de sitios web en WIX",
    complementary_course: "Ilustraci√≥n o FWD Pro (cuando cumpla la edad/equipo)",
    key_selling_points: [
      "Evoluci√≥n hacia dise√±o gr√°fico profesional",
      "Modelado 3D b√°sico con Spline",
      "Crea su portafolio digital",
      "Aprende branding y dise√±o de marcas"
    ]
  },
  
  "ilustracion": {
    name: "Ilustraci√≥n (Artista CG)",
    age_range: { min: 10, max: 12 },
    keywords: ["ilustraci√≥n", "ilustracion", "artista", "dibujo"],
    interest_profile: "Dibujo profesional, c√≥mics, arte conceptual",
    min_requirements: "Gusto por el dibujo manual/digital",
    tech_requirements: "PC/Mac. Idealmente Tableta Digitalizadora",
    tools: "Software de arte digital, Herramientas de IA",
    soft_skills: "√âtica en el uso de IA, estilo propio",
    hard_skills: "Teor√≠a del color, luces y sombras, perspectiva, anatom√≠a, Photobashing, dise√±o de personajes",
    complementary_course: "Creatividad Digital 2",
    key_selling_points: [
      "Enfoque art√≠stico profesional",
      "T√©cnicas avanzadas de ilustraci√≥n digital",
      "Aprende a usar IA como herramienta art√≠stica",
      "Desarrolla estilo propio y portafolio"
    ]
  },
  
  "diseno_grafico": {
    name: "Dise√±o Gr√°fico",
    age_range: { min: 13, max: 17 },
    keywords: ["dise√±o", "gr√°fico", "grafico", "branding"],
    interest_profile: "Branding, logos, publicidad, redes sociales",
    min_requirements: "Autonom√≠a digital, sentido est√©tico",
    tech_requirements: "PC/Mac",
    tools: "Figma, Photopea, Behance",
    soft_skills: "Orientaci√≥n profesional, presentaci√≥n personal",
    hard_skills: "Vectores, tipograf√≠a, ret√≠culas modulares, retoque fotogr√°fico, Mockups, dise√±o de Landing Pages (UI)",
    complementary_course: "Dise√±o Web (es el complemento natural)",
    key_selling_points: [
      "Preparaci√≥n para carrera en dise√±o",
      "Aprende herramientas profesionales (Figma)",
      "Crea branding completo para marcas",
      "Portfolio profesional en Behance"
    ]
  },
  
  "diseno_web": {
    name: "Dise√±o Web (WEB)",
    age_range: { min: 13, max: 17 },
    keywords: ["web", "html", "css", "frontend"],
    interest_profile: "Crear p√°ginas web, c√≥digo + dise√±o",
    min_requirements: "Escribir en ingl√©s b√°sico (keywords), no usar tablet",
    tech_requirements: "PC/Port√°til, Chrome. No Tablets/Chromebooks",
    tools: "Visual Studio Code, HTML5, CSS3, Figma, Bootstrap",
    soft_skills: "An√°lisis de usuario (UX), presentaci√≥n de proyectos",
    hard_skills: "Maquetaci√≥n HTML/CSS, Flexbox/Grid, Dise√±o Responsivo, JavaScript b√°sico (interactividad), SEO b√°sico",
    complementary_course: "Dise√±o Gr√°fico (para mejorar la UI) o Python Pro (para el backend)",
    key_selling_points: [
      "Crea sitios web profesionales desde cero",
      "Habilidad m√°s demandada en el mercado laboral",
      "Aprende HTML, CSS y JavaScript",
      "Base para desarrollo Full Stack"
    ]
  },
  
  "fwd_pro": {
    name: "Fantastic World Design Pro (FWD Pro)",
    age_range: { min: 13, max: 17 },
    keywords: ["fwd", "blender", "3d", "modelado", "fantastic", "world"],
    interest_profile: "3D, arquitectura, animaci√≥n realista",
    min_requirements: "Paciencia, pensamiento espacial",
    tech_requirements: "8GB - 32GB RAM, CPU 64-bit. No Chromebooks",
    tools: "Blender, Photopea, Tilda (Web)",
    soft_skills: "Planificaci√≥n de proyectos complejos",
    hard_skills: "Modelado 3D (Low/High poly), Texturizado UV, Simulaciones f√≠sicas (fuego, fluidos), Renderizado, Dise√±o arquitect√≥nico",
    complementary_course: "Unity (para importar los modelos 3D a un juego)",
    key_selling_points: [
      "Blender: herramienta usada en Hollywood",
      "Modelado 3D profesional y arquitectura",
      "Simulaciones f√≠sicas avanzadas",
      "Preparaci√≥n para industria de VFX y videojuegos"
    ]
  },
  
  "unity": {
    name: "Unity (Juegos Unity 3D)",
    age_range: { min: 13, max: 17 },
    keywords: ["unity", "c#", "game"],
    interest_profile: "Crear videojuegos profesionales, programaci√≥n C#",
    min_requirements: "Experiencia previa en programaci√≥n, Usuario confiado de PC",
    tech_requirements: "PC Potente (i3/i5, GPU dedicada recomendada). No Chromebooks",
    tools: "Unity Editor, Visual Studio (C#), Photon (Multiplayer), GitHub",
    soft_skills: "Gesti√≥n de versiones, equilibrio de juego",
    hard_skills: "Programaci√≥n C# (Clases, Herencia, POO), F√≠sica 2D/3D, Inteligencia Artificial (IA) b√°sica, Redes (Multiplayer), Animaci√≥n",
    complementary_course: "FWD Pro (para crear los assets 3D)",
    key_selling_points: [
      "Motor usado en juegos AAA profesionales",
      "Aprende C#: lenguaje de alta demanda",
      "Crea juegos multiplayer",
      "Preparaci√≥n para industria de videojuegos"
    ]
  },
  
  "minecraft_1": {
    name: "Minecraft Education (Nivel 1)",
    age_range: { min: 8, max: 9 },
    keywords: ["minecraft", "nivel 1", "education"],
    interest_profile: "Construir, jugar Minecraft, automatizar tareas, crear juegos simples",
    min_requirements: "Habilidad b√°sica de PC (rat√≥n/teclado). No requiere experiencia previa en programaci√≥n",
    tech_requirements: "PC/Mac o Chrome OS, 8GB RAM, Procesador i3 o superior",
    tools: "Minecraft Education Edition, MakeCode (bloques)",
    soft_skills: "Trabajo en equipo, planificaci√≥n de proyectos, resoluci√≥n creativa de problemas, presentaci√≥n de proyectos",
    hard_skills: "Algoritmos, bucles, coordenadas, l√≥gica condicional (if/else), automatizaci√≥n con Agente, Redstone",
    complementary_course: "Roblox (8-9) (para saltar a otro motor 3D) o Minecraft Nivel 2 (para avanzar a c√≥digo escrito)",
    key_selling_points: [
      "Aprende programaci√≥n dentro de su juego favorito",
      "No requiere experiencia previa",
      "Automatizaci√≥n con bloques visuales",
      "Base perfecta para Python despu√©s"
    ]
  },
  
  "minecraft_2": {
    name: "Minecraft Education Nivel 2 (Python)",
    age_range: { min: 10, max: 11 },
    keywords: ["minecraft", "python", "nivel 2"],
    interest_profile: "Programar 'de verdad', controlar el juego con c√≥digo, Inteligencia Artificial (IA)",
    min_requirements: "Lectura fluida (c√≥digo en ingl√©s b√°sico), l√≥gica b√°sica",
    tech_requirements: "PC/Mac o Chrome OS, Hardware espec√≠fico (Intel i3/AMD A8 o superior)",
    tools: "Minecraft Education Edition, Lenguaje Python",
    soft_skills: "√âtica de la IA, presentaci√≥n de proyectos, pensamiento sistem√°tico",
    hard_skills: "Sintaxis Python, Bucles anidados, Variables, Funciones parametrizadas, Listas, Coordenadas 3D (x, y, z), Uso de IA para c√≥digo",
    complementary_course: "Python New (para salir del entorno de juego) o Roblox (10-12)",
    key_selling_points: [
      "Evoluci√≥n a programaci√≥n profesional con Python",
      "Controla Minecraft con c√≥digo real",
      "Introducci√≥n a IA dentro del juego",
      "Transici√≥n perfecta hacia Python profesional"
    ]
  },
  
  "drawing": {
    name: "Drawing (Dibujo en papel)",
    age_range: { min: 8, max: 9 },
    keywords: ["drawing", "dibujo", "papel"],
    interest_profile: "Dibujar en papel, c√≥mics, anime, realismo, pintura",
    min_requirements: "Paciencia, motricidad fina, gusto por dibujar a mano",
    tech_requirements: "PC/Mac/Tablet (para ver la clase por Zoom). Materiales F√≠sicos: Papel A4, L√°piz HB, Borrador, Regla, Colores/Marcadores, Pinturas a base de agua",
    tools: "Papel y materiales tradicionales",
    soft_skills: "Confianza en s√≠ mismo, concentraci√≥n, estabilidad emocional, superaci√≥n del miedo al error",
    hard_skills: "Proporci√≥n, perspectiva, teor√≠a del color, sombreado, estilos (anime, cubismo, impresionismo), bocetado r√°pido",
    complementary_course: "Creatividad Digital 1 (para digitalizar su arte) o Ilustraci√≥n (futuro paso)",
    key_selling_points: [
      "Fundamentos art√≠sticos tradicionales",
      "No requiere tableta digital costosa",
      "Desarrolla concentraci√≥n y confianza",
      "Base perfecta para ilustraci√≥n digital despu√©s"
    ]
  }
};

// ============================================
// VARIABLES GLOBALES
// ============================================
let currentLang = "es";
let LIVE_COURSE_DATA = [];
let LIVE_POSSIBLE_GROUPS = [];
let connectionStatus = { connected: false, method: null };
let lastFetchTime = null;
let isFetching = false;
let allFilteredCourses = [];
let allFilteredPossibleGroups = [];
let selectedCourses = [];
let preferredSchedule = [];

// ============================================
// FUNCIONES DE UI Y CONEXI√ìN
// ============================================
function updateConnectionStatus(status) {
  const statusEl = document.getElementById('connection-status');
  statusEl.className = 'connection-status ' + status;
  if (status === 'connected') statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Conectado';
  else if (status === 'disconnected') statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Sin conexi√≥n';
  else statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando...';
}

function showSystemMessage(type, title, message) {
  const container = document.getElementById('system-messages');
  const msgId = 'msg-' + Date.now();
  const html = `<div id="${msgId}" class="${type}-box"><div style="display: flex; justify-content: space-between; align-items: start;"><div><strong>${title}</strong><p class="text-sm mt-1">${message}</p></div><button onclick="document.getElementById('${msgId}').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button></div></div>`;
  container.innerHTML = html + container.innerHTML;
  if (type === 'success') setTimeout(() => { const el = document.getElementById(msgId); if (el) el.remove(); }, 5000);
}

// ============================================
// FUNCIONES DE PARSING MEJORADAS
// ============================================

// ==========================================
// PARSER CSV AVANZADO (SOPORTA MULTI-L√çNEA)
// ==========================================
function parseCSVRobust(text) {
  const rows = [];
  let currentRow = [];
  let currentCell = "";
  let inQuotes = false;

  // Recorremos el texto letra por letra para no confundirnos
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const nextChar = text[i + 1];

    // 1. Manejo de Comillas
    if (char === '"') {
      if (inQuotes && nextChar === '"') {
        // Si hay doble comilla dentro de comillas, es una comilla literal
        currentCell += '"';
        i++; // Saltamos la siguiente
      } else {
        // Entramos o salimos del modo "protegido"
        inQuotes = !inQuotes;
      }
    }
    // 2. Manejo de Separador (Coma)
    else if (char === ',' && !inQuotes) {
      // Solo separamos columna si NO estamos dentro de comillas
      currentRow.push(currentCell.trim());
      currentCell = "";
    }
    // 3. Manejo de Fin de Fila (Enter)
    else if ((char === '\n' || char === '\r') && !inQuotes) {
      // Solo cambiamos de fila si NO estamos dentro de comillas
      if (char === '\r' && nextChar === '\n') i++; // Manejo de saltos Windows

      currentRow.push(currentCell.trim());
      // Guardamos la fila si tiene datos
      if (currentRow.length > 1 || currentRow[0] !== "") {
        rows.push(currentRow);
      }
      currentRow = [];
      currentCell = "";
    }
    // 4. Car√°cter normal
    else {
      currentCell += char;
    }
  }

  // Guardar lo √∫ltimo que qued√≥ en memoria
  if (currentCell || currentRow.length > 0) {
    currentRow.push(currentCell.trim());
    rows.push(currentRow);
  }

  // Separar encabezados del resto
  const headers = rows.length > 0 ? rows[0] : [];
  const dataRows = rows.slice(1);

  return { headers, rows: dataRows };
}

function parseAgeRange(ageStr) {
  const m = String(ageStr || "").match(/(\d+)\D+(\d+)/);
  return m ? { min: parseInt(m[1],10), max: parseInt(m[2],10) } : { min: 7, max: 17 };
}

function inferInterest(courseTitle) {
  const t = String(courseTitle || "").toLowerCase();
  
  // Coding y Videojuegos
  if (
    t.includes("funtech") ||
    t.includes("scratch") ||
    t.includes("minecraft") ||
    t.includes("roblox") ||
    t.includes("python") ||
    t.includes("unity") ||
    t.includes("web") ||
    t.includes("godot") ||
    t.includes("game") ||
    t.includes("c#")
  ) {
    return "coding";
  }
  
  // Media y Dise√±o
  if (
    t.includes("drawing") ||
    t.includes("dibujo") ||
    t.includes("ilustra") ||
    t.includes("creatividad") ||
    t.includes("creativity") ||
    t.includes("fwd") ||
    t.includes("blender") ||
    t.includes("graphic") ||
    t.includes("design") ||
    t.includes("dise√±o") ||
    t.includes("figma") ||
    t.includes("art") ||
    t.includes("3d")
  ) {
    return "design";
  }
  
  // Default
  return "coding";
}

function extractCourseType(courseName, courseTitle) {
  const fullText = `${courseName || ""} ${courseTitle || ""}`.toLowerCase().trim();
  
  // Lista de detecci√≥n con niveles (orden importa - espec√≠ficos primero)
  const courseMap = {
    // Coding y Videojuegos (espec√≠ficos primero)
    "minecraft lvl 2": ["minecraft lvl 2", "minecraft level 2", "minecraft nivel 2", "minecraft 2"],
    "minecraft": ["minecraft"],
    
    "roblox lvl 2": ["roblox lvl 2", "roblox level 2", "roblox nivel 2", "roblox 2", "roblox game developer lvl 2"],
    "roblox": ["roblox"],
    
    "python pro": ["python pro", "python avanzado", "python advanced", "python lvl 2", "python lvl2", "python level 2", "python nivel 2", "pythonlvl2"],
    "python": ["python new", "python fundamentos", "python b√°sico"], // Solo b√°sico
    
    "funtech": ["funtech", "fun tech", "explorers"],
    "scratch": ["scratch", "magia", "c√≥digo"],
    "unity": ["unity", "c#"],
    "web": ["web", "html", "css", "dise√±o web"],
    "godot": ["godot"],
    
    // Media y Dise√±o (espec√≠ficos primero)
    "digital creativity 2": ["creatividad digital nivel 2", "digital creativity 2", "creatividad 2", "creativity 2"],
    "digital creativity 1": ["creatividad digital nivel 1", "digital creativity 1", "creatividad 1", "creativity 1"],
    "drawing": ["drawing", "dibujo"],
    "ilustraci√≥n": ["ilustra", "ilustracion", "illustration"],
    "fwd pro": ["fwd", "blender", "fantastic world"],
    "graphic design": ["graphic", "grafico", "dise√±o gr√°fico"]
  };
  
  // Buscar coincidencia (los espec√≠ficos se comprueban primero)
  for (const [cleanName, keywords] of Object.entries(courseMap)) {
    for (const keyword of keywords) {
      if (fullText.includes(keyword)) {
        // Formatear el nombre con capitalizaci√≥n correcta
        return cleanName
          .split(' ')
          .map(word => word === 'lvl' ? 'lvl' : word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
      }
    }
  }
  
  // Fallback: retornar el t√≠tulo original limpio (sin IDs)
  const cleaned = (courseTitle || courseName || "Curso")
    .replace(/ID\s*\d+:/gi, "")
    .replace(/\$\d+/g, "")
    .trim();
  return cleaned;
}

function parseISODateOnly(s) {
  const m = String(s || "").match(/(\d{4}-\d{2}-\d{2})/);
  if (!m) return null;
  const d = new Date(m[1] + "T00:00:00");
  return isNaN(d.getTime()) ? null : d;
}

function parseTimeToMinutes(timeStr) {
  const match = String(timeStr || "").match(/(\d{1,2}):(\d{2})/);
  if (!match) return null;
  return parseInt(match[1]) * 60 + parseInt(match[2]);
}

function parseDayAbbreviation(dayStr) {
  const dayMap = {
    'mon': 'lunes', 'monday': 'lunes',
    'tue': 'martes', 'tuesday': 'martes',  
    'wed': 'mi√©rcoles', 'wednesday': 'mi√©rcoles',
    'thu': 'jueves', 'thursday': 'jueves',
    'fri': 'viernes', 'friday': 'viernes',
    'sat': 's√°bado', 'saturday': 's√°bado',
    'sun': 'domingo', 'sunday': 'domingo',
    'lun': 'lunes', 'lunes': 'lunes',
    'mar': 'martes', 'martes': 'martes',
    'mi√©': 'mi√©rcoles', 'mie': 'mi√©rcoles', 'mi√©rcoles': 'mi√©rcoles', 'miercoles': 'mi√©rcoles',
    'jue': 'jueves', 'jueves': 'jueves',
    'vie': 'viernes', 'viernes': 'viernes',
    's√°b': 's√°bado', 'sab': 's√°bado', 's√°bado': 's√°bado', 'sabado': 's√°bado',
    'dom': 'domingo', 'domingo': 'domingo'
  };
  const normalized = String(dayStr || "").toLowerCase().trim();
  return dayMap[normalized] || normalized;
}
    function getDayOfWeekFromDate(dateObj) {
  if (!dateObj) return null;
  
  const dayMap = {
    0: 'domingo',
    1: 'lunes',
    2: 'martes',
    3: 'mi√©rcoles',
    4: 'jueves',
    5: 'viernes',
    6: 's√°bado'
  };
  
  return dayMap[dateObj.getDay()];
}

// ============================================
// MAPEO DE DATOS: GRUPOS ACTIVOS (CORREGIDO CON NOMBRE EXACTO)
// ============================================
function mapRowsToCourses(headers, rows) {
  // 1. DIAGN√ìSTICO DE ENCABEZADOS
  console.group("üîç DIAGN√ìSTICO DE COLUMNAS");
  // console.log("Todos los encabezados:", headers); // Descomentar si necesitas ver todos

  const findCol = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
  
  const idx_group = findCol("group_title");
  const idx_course = findCol("course_title");
  const idx_age = findCol("age");
  const idx_capacity = findCol("capacity");
  const idx_enrolled = findCol("enrolled");
  const idx_status = findCol("status");
  const idx_teacher = findCol("teacher");
  
  const idx_date = findCol("first_lesson_date"); 
  
  // --- CORRECCI√ìN AQU√ç: USAMOS EL NOMBRE EXACTO QUE ENCONTRASTE ---
  let idx_time = findCol("first_lesson_time_gmt_5"); 
  
  // Fallback por si acaso cambia en el futuro
  if (idx_time === -1) idx_time = findCol("time_gmt"); 
  if (idx_time === -1) idx_time = findCol("first_lesson_time");

  console.log(`‚úÖ √çndice 'course_title': ${idx_course}`);
  console.log(`‚úÖ √çndice 'first_lesson_date': ${idx_date}`);
  console.log(`‚úÖ √çndice 'first_lesson_time_gmt_5': ${idx_time}`); // ESTE YA NO DEBE SER -1
  console.groupEnd();

  const courses = [];
  const today = new Date();
  today.setHours(0,0,0,0);
  const twoWeeksAgo = new Date(today);
  twoWeeksAgo.setDate(today.getDate() - 14);

  for (let i = 0; i < rows.length; i++) {
    const r = rows[i];
    
    // OBTENCI√ìN DE DATOS
    const internalCode = idx_group >= 0 ? (r[idx_group] || "") : "";
    const name = idx_course >= 0 ? (r[idx_course] || internalCode) : internalCode; 
    
    // LECTURA DE HORA CON DEBUGGING (Solo primeras 3 filas)
    const rawDate = idx_date >= 0 ? r[idx_date] : "";
    const rawTime = idx_time >= 0 ? r[idx_time] : "";
    
    // Usamos la funci√≥n de limpieza formatTimeHHMM que ya tienes
    const timeStr = formatTimeHHMM(rawTime); 

    if (i < 3) {
        console.log(`üìù FILA ${i}: Fecha="${rawDate}" | Hora Raw="${rawTime}" | Hora Limpia="${timeStr}"`);
    }

    // FILTROS DE CALIDAD
    const capacity = idx_capacity >= 0 ? parseInt(r[idx_capacity] || "0") : 0;
    const enrolled = idx_enrolled >= 0 ? parseInt(r[idx_enrolled] || "0") : 0;
    const status = idx_status >= 0 ? (r[idx_status] || "").toLowerCase() : "";
    
    if (!name || (status && status !== "active")) continue;
    if (name.includes("WRONG") || name.includes("ERROR")) continue;
    if (capacity > 0 && enrolled > capacity) continue;

    const startDate = parseISODateOnly(rawDate);
    if (startDate && startDate < twoWeeksAgo) continue;

    // Extracci√≥n de ID y Edad
    const idMatch = name.match(/\[(\d+)\]/);
    const courseId = idMatch ? parseInt(idMatch[1]) : 0;
    const ageVal = idx_age >= 0 ? r[idx_age] : "";
    const ageRange = parseAgeRange(ageVal);

    courses.push({
      id: `active_${i}_${courseId}`,
      courseId: courseId,
      name_es: name,
      topic: name,
      internalCode: internalCode,
      min_age: ageRange.min,
      max_age: ageRange.max,
      interest: inferInterest(name),
      courseType: extractCourseType(name, name),
      enrolled: enrolled,
      capacity: capacity,
      isFull: capacity > 0 && enrolled >= capacity,
      next_start: rawDate && timeStr ? `${rawDate} | ${timeStr}` : (rawDate || "N/A"),
      teacher: idx_teacher >= 0 ? r[idx_teacher] : "Tutor N/A",
      startDateObj: startDate,
      timeStr: timeStr, // <--- ESTA ES LA VARIABLE CLAVE QUE AHORA S√ç TENDR√Å DATOS
      timeMinutes: parseTimeToMinutes(timeStr),
      day: startDate ? getDayOfWeekFromDate(startDate) : null,
      type: 'active'
    });
  }
  
  console.log(`‚úÖ Loaded ${courses.length} active groups.`);
  return courses;
}

// ============================================
// MAPEO DE DATOS: GRUPOS POSIBLES (CON PUNTAJE COLUMNA M)
// ============================================
function mapRowsToPossibleGroups(headers, rows) {
  const groups = [];
  
  console.log("=== PARSING POSSIBLE GROUPS ===");
  
  for (let i = 0; i < rows.length; i++) {
    const r = rows[i];
    const semanticId = (r[21] || "").trim(); // Columna V (ID Sem√°ntico)
    
    // --- NUEVO: LEER PUNTAJE DE COLUMNA M (√çndice 12) ---
    // Convertimos a flotante por si tiene decimales, si falla es 0
    let rawScore = r[12] || "0";
    // Limpieza b√°sica por si viene con texto
    rawScore = rawScore.replace(/,/g, '.').replace(/[^\d.-]/g, ''); 
    const clusterScore = parseFloat(rawScore) || 0;
    // ----------------------------------------------------

    const courseName = (r[0] || "").trim();
    const format = (r[1] || "").toLowerCase().trim();
    const dayRaw = (r[2] || "").trim();
    const hora = (r[3] || "").trim();
    const students = parseInt(r[4] || "0");
    const ageRangeStr = r[6] || ""; 
    
    // ID de referencia Columna U (√çndice 20)
    let idRef = 0;
    try { idRef = parseInt(r[20] || "0"); } catch (e) { idRef = 0; }

    if (!courseName || courseName.startsWith("‚Ä¢") || !dayRaw) continue;

    const day = parseDayAbbreviation(dayRaw);
    const ageRange = parseAgeRange(ageRangeStr);
    const isPremium = format.includes("prm") || format.includes("premium");
    const capacity = isPremium ? 4 : 14;

    if (students > capacity) continue;

    const group = {
      id: `possible_${i}_${courseName}_${day}_${hora}`,
      courseId: idRef,
      name_es: courseName,
      topic: courseName,
      courseTitle: courseName,
      format: isPremium ? "premium" : "regular",
      day: day,
      dayRaw: dayRaw,
      hora: hora,
      timeMinutes: parseTimeToMinutes(hora),
      enrolled: students,
      capacity: capacity,
      isFull: students >= capacity,
      min_age: ageRange.min,
      max_age: ageRange.max,
      interest: inferInterest(courseName),
      courseType: extractCourseType(courseName, courseName),
      next_start: `${day} | ${hora}`,
      teacher: "Por asignar",
      type: 'possible',
      semanticId: semanticId,
      clusterScore: clusterScore // <--- GUARDAMOS EL PUNTAJE AQU√ç
    };
    
    groups.push(group);
  }
  
  console.log(`‚úÖ Loaded ${groups.length} possible groups.`);
  return groups;
}


// ============================================
// FUNCIONES DE FETCH - MEJORADAS
// ============================================
async function fetchWithCSV(dataSource) {
  let targetUrl = dataSource.csv + "&_=" + Date.now();
  
  if (USE_CORS_PROXY) {
    // Detectamos qu√© proxy estamos usando
    if (CORS_PROXY.includes("allorigins")) {
        targetUrl = CORS_PROXY + encodeURIComponent(targetUrl);
    } else {
        // Para corsproxy.io es directo
        targetUrl = CORS_PROXY + targetUrl;
    }
  }

  const resp = await fetch(targetUrl, { cache: "no-store" });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const text = await resp.text();
  return parseCSVRobust(text);
}

async function fetchWithGViz(dataSource) {
  let url = dataSource.json + "&_=" + Date.now();
  let resp;
  try {
    resp = await fetch(url, { mode: 'cors', cache: "no-store" });
  } catch {
    url = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    resp = await fetch(url, { cache: "no-store" });
  }
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  let text = await resp.text();
  text = text.replace(/^.*?google\.visualization\.Query\.setResponse\(/, '').replace(/\);?\s*$/, '');
  const data = JSON.parse(text);
  const headers = data.table.cols.map(col => col.label || col.id || "");
  const rows = data.table.rows.map(row => row.c.map(cell => cell ? (cell.v || "") : ""));
  return { headers, rows };
}

function updateDataSourceInfo() {
  const el = document.getElementById('data-source-info');
  if (lastFetchTime) {
    const diffSec = Math.floor((new Date() - lastFetchTime) / 1000);
    const timeAgo = diffSec < 60 ? `${diffSec}s` : `${Math.floor(diffSec/60)}m`;
    el.innerHTML = `Data source: <b>${connectionStatus.method}</b> | <span class="text-xs text-green-600">‚úì ${timeAgo}</span>`;
  }
}

async function fetchCourseData(forceRefresh = false) {
  if (isFetching && !forceRefresh) return;
  isFetching = true;
  updateConnectionStatus('loading');
  
  const methods = [
    { name: 'CSV Export', fn: fetchWithCSV }, 
    { name: 'GViz JSON', fn: fetchWithGViz }
  ];

  for (const method of methods) {
    try {
      const result = await method.fn(DATA_SOURCES.active);
      LIVE_COURSE_DATA = mapRowsToCourses(result.headers, result.rows);
      if (LIVE_COURSE_DATA.length === 0) throw new Error("No hay cursos activos");
      console.log(`‚úÖ Active groups loaded: ${LIVE_COURSE_DATA.length}`);
      break;
    } catch (err) {
      console.warn(`‚úó Active ${method.name}:`, err.message);
    }
  }

  for (const method of methods) {
    try {
      console.log(`\nüîÑ Trying to fetch Possible Groups with ${method.name}...`);
      const result = await method.fn(DATA_SOURCES.possible);
      LIVE_POSSIBLE_GROUPS = mapRowsToPossibleGroups(result.headers, result.rows);
      console.log(`‚úÖ Possible groups loaded: ${LIVE_POSSIBLE_GROUPS.length}`);
      break;
    } catch (err) {
      console.warn(`‚úó Possible ${method.name}:`, err.message);
    }
  }

  if (LIVE_COURSE_DATA.length === 0 && LIVE_POSSIBLE_GROUPS.length === 0) {
    connectionStatus = { connected: false, method: null };
    isFetching = false;
    updateConnectionStatus('disconnected');
    throw new Error("Error de conexi√≥n");
  }

  connectionStatus = { connected: true, method: 'Multi-source' };
  lastFetchTime = new Date();
  updateConnectionStatus('connected');
  updateDataSourceInfo();
  isFetching = false;
}

// ============================================
// C√ÅLCULO DE PRIORIDAD (FECHA CERCANA vs PUNTAJE CLUSTER)
// ============================================
function calculatePriority(course) {
  
  // --- REGLA 1: SI ES GRUPO POSIBLE, USA LA COLUMNA M ---
  if (course.type === 'possible') {
      // Retornamos el valor directo del Excel. 
      // Entre mayor sea el n√∫mero en Columna M, m√°s arriba saldr√°.
      return course.clusterScore || 0;
  }

  // --- REGLA 2: SI ES GRUPO ACTIVO, PRIORIZA FECHA M√ÅS CERCANA ---
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const daysUntilStart = course.startDateObj 
    ? Math.ceil((course.startDateObj - today) / (1000 * 60 * 60 * 24)) 
    : 999; 

  if (daysUntilStart < 0) return 0; // Ya pas√≥

  // F√≥rmula base: Empezamos en 1000 y restamos los d√≠as.
  // Ejemplo: Empieza ma√±ana (1 d√≠a) = 999 pts.
  // Ejemplo: Empieza en 20 d√≠as = 980 pts.
  let score = 1000 - daysUntilStart;

  // AJUSTE T√âCNICO: Penalizaci√≥n por Overbooking
  // Aunque priorizamos fecha, si el grupo est√° LLENO, le quitamos 500 puntos.
  // ¬øPor qu√©? Para que si tienes un grupo ma√±ana (Lleno) y uno pasado ma√±ana (Libre),
  // el sistema te muestre el Libre primero.
  if (course.isFull) {
      score -= 500;
  }

  // Aseguramos que no de negativo
  if (score < 0) score = 0;

  return score;
}


function calculateScheduleMatchScore(course) {
  if (preferredSchedule.length === 0) return 0;
  
  let bestScore = 0;
  const courseTimeMinutes = course.timeMinutes; 
  const courseDay = course.day ? course.day.toLowerCase() : null;
  
  if (!courseTimeMinutes) return 0;
  
  for (const pref of preferredSchedule) {
    const colTime = convertClientToColombia(pref.day, pref.hour);
    const prefTimeMinutes = colTime.hour * 60;
    const prefDay = colTime.day;
    
    const timeDiff = Math.abs(courseTimeMinutes - prefTimeMinutes);
    let currentScore = 0;

    // Calcular coincidencia pura
    if (courseDay === prefDay && timeDiff <= 30) {
      currentScore = 1000 - timeDiff; 
    } else if (timeDiff <= 30) {
      currentScore = 800 - timeDiff;  
    } else if (courseDay === prefDay && timeDiff <= 120) {
      currentScore = 600 - timeDiff;  
    }

    // --- CORRECCI√ìN DR√ÅSTICA ---
    // Si est√° lleno, ignoramos el puntaje alto y lo bajamos al piso.
    // Le damos 100 puntos fijos para que aparezca en la lista (mejor que 0),
    // pero NUNCA le ganar√° a un grupo disponible con coincidencia (que tendr√° 600+).
    if (course.isFull && currentScore > 0) {
        currentScore = 100; 
    }

    bestScore = Math.max(bestScore, currentScore);
  }
  
  return bestScore;
}


// ============================================
// FUNCIONES DE ACTUALIZACI√ìN DE UI
// ============================================
function updateCourseTypeOptions() {
  const interest = document.getElementById("student_interest").value;
  const courseTypeSelect = document.getElementById("course_type");
  
  if (!LIVE_COURSE_DATA.length && !LIVE_POSSIBLE_GROUPS.length) {
    courseTypeSelect.innerHTML = '<option value="">-- Cargando... --</option>';
    return;
  }
  
  const types = new Set();
  
  // Lista blanca de cursos v√°lidos (con niveles espec√≠ficos)
  const validCourses = {
    "coding": [
      "FunTech",
      "Scratch", 
      "Minecraft", 
      "Minecraft Lvl 2",
      "Roblox", 
      "Roblox Lvl 2",
      "Python", 
      "Python Pro",
      "Web", 
      "Unity"
    ],
    "design": [
      "Drawing",
      "Ilustraci√≥n",
      "Digital Creativity 1",
      "Digital Creativity 2",
      "FWD Pro",
      "Graphic Design"
    ]
  };
  
  const allowedForThisInterest = validCourses[interest] || [];
  
  // Procesar cursos
  [...LIVE_COURSE_DATA, ...LIVE_POSSIBLE_GROUPS].forEach(c => {
    if (c.interest === interest && c.courseType) {
      const normalizedCourseType = c.courseType.toLowerCase().trim();
      
      // Buscar coincidencia EXACTA (no includes)
      for (const validCourse of allowedForThisInterest) {
        const normalizedValid = validCourse.toLowerCase().trim();
        
        // Comparaci√≥n exacta o muy cercana
        if (normalizedCourseType === normalizedValid || 
            normalizedCourseType.replace(/\s+/g, '') === normalizedValid.replace(/\s+/g, '')) {
          types.add(validCourse); // Agregar el nombre formateado correctamente
          break;
        }
      }
    }
  });
  
  // Popular el dropdown
  courseTypeSelect.innerHTML = '<option value="">-- Todos los cursos de este inter√©s --</option>';
  
  if (types.size === 0) {
    courseTypeSelect.innerHTML += '<option value="" disabled>No hay cursos disponibles para este inter√©s</option>';
    return;
  }
  
  // Ordenar alfab√©ticamente
  Array.from(types).sort().forEach(type => {
    courseTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
  });
  
  console.log(`‚úÖ Populated dropdown with ${types.size} course types for ${interest}`);
}

function courseMatchesType(course, selectedType) {
  if (!selectedType) return true;
  
  // Normalizar
  const courseName = (course.name_es || "").toLowerCase();
  const courseType = (course.courseType || "").toLowerCase();
  const topic = (course.topic || course.courseTitle || "").toLowerCase();
  const selected = selectedType.toLowerCase();
  
  console.log(`Checking match: "${selected}" against "${courseName}"`);
  
  // Mapa de sin√≥nimos expandido con niveles
  const synonymMap = {
    "funtech": ["funtech", "fun tech", "explorers"],
    "scratch": ["scratch", "magia del c√≥digo"],
    
    "minecraft lvl 2": ["minecraft lvl 2", "minecraft level 2", "minecraft nivel 2", "minecraft 2", "mc lvl 2"],
    "minecraft": ["minecraft", "mc"], // Solo sin nivel
    
    "roblox lvl 2": ["roblox lvl 2", "roblox level 2", "roblox nivel 2", "roblox 2", "roblox game developer lvl 2"],
    "roblox": ["roblox"], // Solo sin nivel (no incluye lvl 2)
    
    "python pro": ["python pro", "python avanzado", "python advanced", "python lvl 2", "python lvl2", "python level 2", "python nivel 2", "python 2", "pythonlvl2"],
    "python": ["python new", "python fundamentos", "python b√°sico"], // Solo b√°sico (no incluye pro ni lvl 2)
    
    "unity": ["unity", "c#", "juegos unity"],
    "web": ["web", "html", "css", "javascript", "dise√±o web"],
    "godot": ["godot"],
    
    "drawing": ["drawing", "dibujo", "papel"],
    "ilustraci√≥n": ["ilustra", "ilustracion", "illustration", "artista cg"],
    
    "digital creativity 2": ["creatividad digital nivel 2", "digital creativity 2", "creatividad 2", "creativity 2"],
    "digital creativity 1": ["creatividad digital nivel 1", "digital creativity 1", "creatividad 1", "creativity 1"],
    
    "fwd pro": ["fwd", "blender", "fantastic world", "3d"],
    "graphic design": ["graphic", "grafico", "dise√±o gr√°fico", "branding"]
  };
  
  // Casos especiales para evitar falsos positivos
const exclusions = {
  "minecraft": ["lvl 2", "level 2", "nivel 2"],
  "roblox": ["lvl 2", "level 2", "nivel 2"],
  "python": ["pro", "avanzado", "advanced", "lvl 2", "level 2", "nivel 2"], // Python b√°sico NO debe coincidir con pro ni lvl 2
  "digital creativity 1": ["nivel 2", "level 2", "lvl 2"]
};
  
  // Verificar exclusiones primero
  if (exclusions[selected]) {
    for (const exclusion of exclusions[selected]) {
      if (courseName.includes(exclusion) || courseType.includes(exclusion) || topic.includes(exclusion)) {
        console.log(`  ‚ùå Excluded by: "${exclusion}"`);
        return false;
      }
    }
  }
  
  // Buscar coincidencia directa
  if (courseName.includes(selected) || courseType.includes(selected) || topic.includes(selected)) {
    console.log(`  ‚úÖ Direct match`);
    return true;
  }
  
  // Buscar en sin√≥nimos
  const synonyms = synonymMap[selected] || [];
  for (const synonym of synonyms) {
    if (courseName.includes(synonym) || courseType.includes(synonym) || topic.includes(synonym)) {
      console.log(`  ‚úÖ Synonym match: "${synonym}"`);
      return true;
    }
  }
  
  console.log(`  ‚ùå No match`);
  return false;
}

// ============================================
// DIAGN√ìSTICO Y MATCHING (CON MONITOR DE LOGICA)
// ============================================
async function diagnoseAndMatch() {
  const activeDiv = document.getElementById("course_recommendation");
  const possibleDiv = document.getElementById("possible_groups_list");
  
  activeDiv.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> Cargando grupos activos...</span>';
  possibleDiv.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> Cargando grupos posibles...</span>';
  
  // Limpiar pitch output
  const pitchOutput = document.getElementById("pitch_output");
  pitchOutput.innerHTML = `
    <div class="text-center py-8">
      <i class="fas fa-search text-blue-400 text-4xl mb-3"></i>
      <p class="text-gray-600 font-medium">Nueva b√∫squeda iniciada</p>
    </div>
  `;

  try {
    await fetchCourseData(false); // No forzamos recarga para ser m√°s r√°pidos
  } catch {
    activeDiv.innerHTML = '<span class="text-red-600">Error de conexi√≥n</span>';
    possibleDiv.innerHTML = '<span class="text-red-600">Error de conexi√≥n</span>';
    return;
  }

  const age = parseInt(document.getElementById("student_age").value, 10);
  const interest = document.getElementById("student_interest").value;
  const courseType = document.getElementById("course_type").value;
  const groupType = document.getElementById("group_type").value;

  // 1. FILTRADO INICIAL
  const allowedIds = COURSE_MASTER_MAP[courseType] || [];
  
  // Filtrar Activos
  let filteredActive = LIVE_COURSE_DATA.filter(c => {
    if (allowedIds.length > 0 && !allowedIds.includes(c.courseId)) return false;
    if (age < c.min_age || age > c.max_age) return false;
    const isPremium = (c.internalCode + c.name_es).toUpperCase().includes("PRM");
    if (groupType === "premium" && !isPremium) return false;
    if (groupType === "regular" && isPremium) return false;
    return true;
  });

  // Filtrar Posibles
  let filteredPossible = LIVE_POSSIBLE_GROUPS.filter(c => {
    if (allowedIds.length > 0 && !allowedIds.includes(c.courseId)) return false;
    if (age < c.min_age || age > c.max_age) return false;
    const formatMatch = groupType === c.format;
    if (!formatMatch) return false;
    return true;
  });

  // 2. C√ÅLCULO DE PUNTAJES (SCORING)
  filteredActive.forEach(c => {
    c.priority = calculatePriority(c);            // L√≥gica de negocio (Llenar vac√≠os)
    c.scheduleScore = calculateScheduleMatchScore(c); // Preferencia de cliente
  });
  
  filteredPossible.forEach(c => {
    c.priority = calculatePriority(c);
    c.scheduleScore = calculateScheduleMatchScore(c);
  });

  // 3. ORDENAMIENTO (SORTING)
  const sortFunction = (a, b) => {
    // Si el cliente eligi√≥ horario, manda el Schedule Score
    if (preferredSchedule.length > 0) {
        if (b.scheduleScore !== a.scheduleScore) return b.scheduleScore - a.scheduleScore;
    }
    // Si no (o si empatan), manda la Prioridad de Negocio
    return b.priority - a.priority;
  };

  filteredActive.sort(sortFunction);
  filteredPossible.sort(sortFunction);

  // ============================================================
  // üïµÔ∏è‚Äç‚ôÇÔ∏è MONITOR DE L√ìGICA (AQU√ç EST√Å LO QUE PEDISTE)
  // ============================================================
  console.group("üìä MONITOR DE PRIORIZACI√ìN - TOP 10 ACTIVOS");
  console.log(`Criterio de Orden: ${preferredSchedule.length > 0 ? "HORARIO DEL CLIENTE (ScheduleScore)" : "URGENCIA DE NEGOCIO (PriorityScore)"}`);
  
  const debugData = filteredActive.slice(0, 10).map((c, i) => {
      const today = new Date();
      today.setHours(0,0,0,0);
      const days = c.startDateObj ? Math.ceil((c.startDateObj - today)/(1000*60*60*24)) : 999;
      
      let estado = "Normal";
      if (c.isFull) estado = "‚õî LLENO (Castigado)";
      else if (days <= 5 && (c.enrolled/c.capacity) < 0.5) estado = "üî• URGENTE (Rescate)";
      else if (days > 30) estado = "üìâ LEJANO";

      return {
          "#": i + 1,
          "ID": c.internalCode,
          "Fecha Inicio": c.next_start.split("|")[0].trim(), // Solo la fecha
          "D√≠as Falta": days,
          "Ocupaci√≥n": `${c.enrolled}/${c.capacity} (${Math.round((c.enrolled/c.capacity)*100)}%)`,
          "ESTADO": estado,
          "Pts Negocio": Math.round(c.priority),
          "Pts Horario": Math.round(c.scheduleScore),
          "SCORE FINAL": preferredSchedule.length > 0 ? Math.round(c.scheduleScore) : Math.round(c.priority)
      };
  });
  
  if(debugData.length > 0) {
      console.table(debugData);
      console.log("üëÜ Si ves 'LLENO' arriba de 'URGENTE' o 'Normal', hay un error en la l√≥gica.");
  } else {
      console.log("‚ö†Ô∏è No hay grupos activos que cumplan los filtros b√°sicos (Edad/Tipo/Curso)");
  }
  console.groupEnd();
  // ============================================================

  allFilteredCourses = filteredActive;
  allFilteredPossibleGroups = filteredPossible;
  selectedCourses = [];

  // 4. RENDERIZADO
  if (filteredActive.length === 0) {
    activeDiv.innerHTML = '<span class="text-gray-600">No hay grupos activos para estos criterios</span>';
  } else {
    const top3Active = filteredActive.slice(0, 3);
    let html = renderCourseList(top3Active, true);
    if (filteredActive.length > 3) {
      html += `<div class="mt-4 text-center"><button onclick="openCoursesModal()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700">üìã Ver todos los ${filteredActive.length} grupos activos</button></div>`;
    }
    activeDiv.innerHTML = html;
  }

  if (filteredPossible.length === 0) {
    possibleDiv.innerHTML = '<span class="text-gray-600">No hay grupos posibles para estos criterios</span>';
  } else {
    const top3Possible = filteredPossible.slice(0, 3);
    let html = renderCourseList(top3Possible, false);
    if (filteredPossible.length > 3) {
      html += `<div class="mt-4 text-center"><button onclick="openPossibleGroupsModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700">üìã Ver todos los ${filteredPossible.length} grupos posibles</button></div>`;
    }
    possibleDiv.innerHTML = html;
  }

  if (preferredSchedule.length > 0) {
    const hasMatches = filteredActive.some(c => c.scheduleScore > 0) || filteredPossible.some(c => c.scheduleScore > 0);
    if (hasMatches) showSystemMessage('success', '‚úÖ Coincidencias encontradas', 'Se encontraron cursos seg√∫n horario');
    else showSystemMessage('warning', '‚ö†Ô∏è Sin coincidencias exactas', 'Mostrando alternativas cercanas');
  }

  updatePitchDropdown();
  updateSaleSummary();
}


// ============================================
// RENDERIZADO (CON ETIQUETAS DE MATCH DETALLADAS)
// ============================================
function renderCourseList(courses, showIndex = true) {
  let html = "";
  
  const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
  const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
  const COLOMBIA_OFFSET = -5;

  courses.forEach((course, idx) => {
    const remaining = course.capacity - course.enrolled;
    const critical = remaining <= 2 && remaining > 0;
    const almostFull = remaining > 2 && remaining <= 5;
    const isSelected = selectedCourses.some(c => c.id === course.id);
    
    // Clases base
    let cardClass = "course-option";
    if (course.type === 'possible') cardClass += " possible-group";
    else if (course.isFull) cardClass += " critical";
    else if (critical) cardClass += " critical";
    else if (almostFull) cardClass += " almost-full";
    if (isSelected) cardClass += " selected";
    
    // T√≠tulos
    let mainTitle = course.name_es;
    let subTitle = "";
    if (course.type === 'active' && course.internalCode) {
        mainTitle = course.internalCode; 
        subTitle = course.name_es;       
    }

    const displayIdx = showIndex ? `OPCI√ìN ${idx + 1}` : `#${idx + 1}`;
    const badge = course.type === 'possible' 
      ? '<span class="course-option-badge badge-possible">GRUPO POSIBLE</span>'
      : '<span class="course-option-badge badge-active">GRUPO ACTIVO</span>';

    // 1. C√ÅLCULO DE HORA VISUAL
    let displayTime = "";
    let colTimeLabel = course.timeStr || course.hora || "??:??";
    const hasValidTime = colTimeLabel.includes(":"); 

    if (course.startDateObj && hasValidTime && course.timeStr) {
       const clientOffset = parseInt(document.getElementById("client_timezone").value);
       const diff = clientOffset - COLOMBIA_OFFSET;
       const clientDate = new Date(course.startDateObj);
       const [h, m] = course.timeStr.split(':');
       clientDate.setHours(parseInt(h), parseInt(m));
       clientDate.setHours(clientDate.getHours() + diff);
       
       const dName = dayNames[clientDate.getDay()];
       const dNum = clientDate.getDate();
       const mName = monthNames[clientDate.getMonth()];
       const finalH = clientDate.getHours().toString().padStart(2, '0');
       const finalM = clientDate.getMinutes().toString().padStart(2, '0');
       const finalDateStr = `${dName} ${dNum} ${mName}, ${finalH}:${finalM}`;
       
       displayTime = `<b>${finalDateStr}</b> <span class="text-xs text-blue-600">(Tu hora)</span> <span class="text-gray-400 text-xs">| ${colTimeLabel} COL</span>`;
    
    } else if (course.day && course.hora && hasValidTime) {
       const days = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
       const targetDayIdx = days.indexOf(course.day.toLowerCase());
       const tempDate = new Date();
       if (targetDayIdx !== -1) {
           const currentDayIdx = tempDate.getDay();
           const distance = targetDayIdx - currentDayIdx;
           tempDate.setDate(tempDate.getDate() + distance);
       }
       const [h, m] = course.hora.split(':');
       tempDate.setHours(h, m, 0); 
       const clientTimeFull = convertColombiaToClient(tempDate); 
       displayTime = `<b>${clientTimeFull}</b> <span class="text-xs text-blue-600">(Tu hora)</span> <span class="text-gray-400 text-xs">| ${colTimeLabel} COL</span>`;
    } else {
       const safeDate = course.next_start || "Fecha Pendiente";
       displayTime = `${safeDate} <span class="text-gray-400 text-xs">| ${colTimeLabel} COL</span>`;
    }

    // 2. CONSTRUCCI√ìN DE LA TARJETA
    html += `<div class="${cardClass}" id="course-card-${course.id}">
      <div class="course-option-title text-lg">${displayIdx}: ${mainTitle} ${badge}</div>
      ${subTitle ? `<div class="text-xs text-gray-500 mb-2 font-mono border-b pb-1 truncate" title="${subTitle}">${subTitle}</div>` : ""}
      
      <div class="course-option-row">üìÖ ${displayTime}</div>
      <div class="course-option-row ${critical || course.isFull ? "text-orange-600 font-semibold" : ""}">üíª ${course.enrolled}/${course.capacity} (${remaining} restantes)</div>
      <div class="course-option-row">üë®‚Äçüè´ ${course.teacher}</div>`;
    
    // 3. LOGICA DE MENSAJES DE COINCIDENCIA (AQU√ç EST√Å EL CAMBIO)
    if (preferredSchedule.length > 0) {
      // Recalculamos la "raz√≥n" del match para mostrar el texto correcto
      // (Porque el score num√©rico ya est√° 'sucio' por la penalizaci√≥n de lleno)
      
      let matchLabel = "";
      let matchIcon = "";
      let isExact = false;
      
      // Buscamos cu√°l fue la mejor coincidencia que gener√≥ este curso
      for (const pref of preferredSchedule) {
         const colTime = convertClientToColombia(pref.day, pref.hour);
         const prefTimeMinutes = colTime.hour * 60;
         const courseTimeMinutes = course.timeMinutes;
         const prefDay = colTime.day;
         const courseDay = course.day ? course.day.toLowerCase() : "";
         
         const timeDiff = Math.abs(courseTimeMinutes - prefTimeMinutes);

         if (courseDay === prefDay && timeDiff <= 30) {
             matchLabel = "üéØ Coincidencia EXACTA";
             matchIcon = "üéØ";
             isExact = true;
             break; // Encontramos la mejor, salimos
         } else if (timeDiff <= 30 && !isExact) {
             matchLabel = "‚è∞ Misma hora, diferente d√≠a";
             matchIcon = "‚è∞";
         } else if (courseDay === prefDay && timeDiff <= 120 && !isExact && matchLabel !== "‚è∞ Misma hora, diferente d√≠a") {
             matchLabel = "üóìÔ∏è Mismo d√≠a, diferente hora";
             matchIcon = "üóìÔ∏è";
         }
      }

      // Renderizamos la etiqueta si hubo alg√∫n match
      if (matchLabel) {
        let colorClass = "text-green-700 bg-green-50 border border-green-200";
        let extraText = "";

        // Si est√° lleno, cambiamos el color y agregamos advertencia
        if (course.isFull) {
            colorClass = "text-orange-700 bg-orange-50 border border-orange-200";
            extraText = " (Pero grupo lleno ‚ö†Ô∏è)";
        }
        
        html += `<div class="course-option-row mt-2 p-1 rounded text-center text-sm font-bold ${colorClass}">
            ${matchLabel}${extraText}
        </div>`;
      }
    }
    
    // Alertas de cupo
    if (course.isFull) {
      html += '<div class="course-option-urgency critical-text">‚ö†Ô∏è GRUPO LLENO - REQUIERE AUTORIZACI√ìN</div>';
    } else if (remaining === 1) {
      html += '<div class="course-option-urgency critical-text">üö® ¬°√öLTIMO CUPO DISPONIBLE! üö®</div>';
    } else if (remaining === 2) {
      html += '<div class="course-option-urgency critical-text">üö® URGENTE - 2 cupos üö®</div>';
    } else if (remaining === 3) {
      html += '<div class="course-option-urgency warning-text">‚ö†Ô∏è Casi lleno - 3 cupos</div>';
    } else if (almostFull) {
      html += `<div class="course-option-urgency warning-text">‚ö†Ô∏è Casi lleno - ${remaining} cupos</div>`;
    }
    
    html += `<button onclick="toggleCourseSelection('${course.id}')" class="btn-select mt-3 w-full ${isSelected ? "selected" : "unselected"}" id="btn-select-${course.id}">${isSelected ? "‚úì Seleccionado" : "Seleccionar"}</button>
    </div>`;
  });
  return html;
}


// [CONTIN√öA con las funciones restantes: toggleCourseSelection, modales, pitch, etc...]
// Por brevedad, mantengo el resto igual que en la versi√≥n anterior

function toggleCourseSelection(courseId) {
  const course = [...allFilteredCourses, ...allFilteredPossibleGroups].find(c => c.id === courseId);
  if (!course) return;
  const isSelected = selectedCourses.some(c => c.id === courseId);
  if (isSelected) {
    selectedCourses = selectedCourses.filter(c => c.id !== courseId);
  } else {
    if (selectedCourses.length >= 2) {
      alert("‚ö†Ô∏è M√°ximo 2 cursos para comparaci√≥n");
      return;
    }
    selectedCourses.push(course);
  }
  updateSelectionUI();
  updatePitchDropdown();
  updateSaleSummary();
}

function updateSelectionUI() {
  [...allFilteredCourses, ...allFilteredPossibleGroups].forEach(course => {
    const btn = document.getElementById(`btn-select-${course.id}`);
    const card = document.getElementById(`course-card-${course.id}`);
    const isSelected = selectedCourses.some(c => c.id === course.id);
    if (btn) {
      btn.className = `btn-select mt-3 w-full ${isSelected ? "selected" : "unselected"}`;
      btn.textContent = isSelected ? "‚úì Seleccionado" : "Seleccionar";
      if (selectedCourses.length >= 2 && !isSelected) btn.classList.add("disabled");
    }
    if (card) {
      isSelected ? card.classList.add("selected") : card.classList.remove("selected");
    }
  });
  const countEl = document.getElementById("selected-count");
  if (countEl) countEl.textContent = `${selectedCourses.length}/2 cursos seleccionados`;
}

function updatePitchDropdown() {
  const selectElement = document.getElementById("selected_course");
  const submitBtn = document.getElementById("btn_submit_sale");
  if (selectedCourses.length === 0) {
    selectElement.innerHTML = '<option value="">-- Selecciona un curso primero --</option>';
    submitBtn.disabled = true;
    return;
  }
  selectElement.innerHTML = '<option value="">-- Elige cu√°l pitch generar --</option>';
  selectedCourses.forEach((course, idx) => {
    const remaining = course.capacity - course.enrolled;
    let urgencyTag = "";
    if (remaining === 1) urgencyTag = " (¬°√öLTIMO CUPO!)";
    else if (remaining === 2) urgencyTag = " (URGENTE - 2 cupos)";
    else if (remaining === 3) urgencyTag = " (Casi lleno - 3 cupos)";
    else if (remaining <= 5) urgencyTag = ` (${remaining} cupos)`;
    
    const typeTag = course.type === 'possible' ? " [GRUPO POSIBLE]" : "";
    
    selectElement.innerHTML += `<option value="${course.id}">Curso ${idx + 1}: ${course.name_es}${urgencyTag}${typeTag}</option>`;
  });
  submitBtn.disabled = false;
}

function updateSaleSummary() {
  const summaryContent = document.getElementById("summary-content");
  const amoCrm = document.getElementById("amo_crm_link").value.trim();
  const age = document.getElementById("student_age").value;
  const interest = document.getElementById("student_interest").value;
  const groupType = document.getElementById("group_type").value;
  const isSen = document.getElementById("is_sen").checked;
  
  if (selectedCourses.length === 0) {
    summaryContent.innerHTML = '<p class="text-gray-500">Completa el diagn√≥stico y selecciona cursos</p>';
    return;
  }
  
  let html = '<div class="space-y-2">';
  if (amoCrm) html += `<div><strong>amo CRM:</strong> <a href="${amoCrm}" target="_blank" class="text-blue-600 hover:underline">Ver lead</a></div>`;
  html += `<div><strong>Edad:</strong> ${age} a√±os</div>`;
  
  // --- NUEVO: MOSTRAR CLUSTER ID SI EXISTE ---
  // Buscamos si hay alg√∫n grupo posible seleccionado con ID
  const possibleGroup = selectedCourses.find(c => c.type === 'possible' && c.semanticId);
  if (possibleGroup) {
      html += `<div class="bg-yellow-100 p-2 rounded border border-yellow-300 text-yellow-800">
        <strong>üÜî Cluster ID:</strong> <span class="font-mono text-lg font-bold">${possibleGroup.semanticId}</span>
        <div class="text-xs mt-1 text-gray-600">(Se copiar√° al portapapeles al guardar)</div>
      </div>`;
  }
  // -------------------------------------------

  if (preferredSchedule.length > 0) {
    html += `<div><strong>Horarios:</strong> ${preferredSchedule.length} opciones</div>`;
  }
  
  html += `<div class="mt-2 border-t pt-2"><strong>Selecci√≥n:</strong></div>`;
  selectedCourses.forEach((c, idx) => {
    const typeLabel = c.type === 'possible' ? ' [POSIBLE]' : ' [ACTIVO]';
    html += `<div class="text-sm pl-2">‚Ä¢ ${c.name_es}${typeLabel}</div>`;
  });
  html += '</div>';
  summaryContent.innerHTML = html;
}


function openCoursesModal() {
  const modal = document.getElementById("courses-modal");
  const overlay = document.getElementById("modal-overlay");
  const modalBody = document.getElementById("modal-courses-list");
  modalBody.innerHTML = renderCourseList(allFilteredCourses, false);
  modal.classList.add("active");
  overlay.classList.add("active");
  updateSelectionUI();
}

function closeCoursesModal() {
  document.getElementById("courses-modal").classList.remove("active");
  document.getElementById("modal-overlay").classList.remove("active");
}

function openPossibleGroupsModal() {
  const modal = document.getElementById("possible-groups-modal");
  const overlay = document.getElementById("possible-modal-overlay");
  const modalBody = document.getElementById("modal-possible-groups-list");
  modalBody.innerHTML = renderCourseList(allFilteredPossibleGroups, false);
  modal.classList.add("active");
  overlay.classList.add("active");
  updateSelectionUI();
}

function closePossibleGroupsModal() {
  document.getElementById("possible-groups-modal").classList.remove("active");
  document.getElementById("possible-modal-overlay").classList.remove("active");
}

function openPreferredScheduleModal() {
  const modal = document.getElementById("schedule-modal");
  const overlay = document.getElementById("schedule-modal-overlay");
  const tbody = document.getElementById("schedule-table-body");
  const days = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
  let html = "";
  for (let hour = 6; hour <= 22; hour++) {
    const timeStr = `${hour.toString().padStart(2, '0')}:00`;
    html += `<tr><td class="border p-2 font-medium">${timeStr}</td>`;
    days.forEach(day => {
      const checkId = `schedule-${day}-${hour}`;
      const isChecked = preferredSchedule.some(p => p.day === day && p.hour === hour);
      html += `<td class="border p-2 text-center"><input type="checkbox" id="${checkId}" class="w-5 h-5 cursor-pointer schedule-checkbox" data-day="${day}" data-hour="${hour}" ${isChecked ? 'checked' : ''}/></td>`;
    });
    html += "</tr>";
  }
  tbody.innerHTML = html;
  modal.classList.add("active");
  overlay.classList.add("active");
}

function closeScheduleModal() {
  document.getElementById("schedule-modal").classList.remove("active");
  document.getElementById("schedule-modal-overlay").classList.remove("active");
}

// ============================================
// GUARDAR HORARIOS PREFERIDOS (CON RESUMEN VISUAL)
// ============================================
function submitPreferredSchedule() {
  const checkboxes = document.querySelectorAll('.schedule-checkbox:checked');
  if (checkboxes.length === 0) {
    alert("‚ö†Ô∏è Selecciona al menos un horario preferido");
    return;
  }
  
  preferredSchedule = [];
  // Mapa para traducir c√≥digos a nombres cortos
  const dayMap = {'mon': 'Lun', 'tue': 'Mar', 'wed': 'Mi√©', 'thu': 'Jue', 'fri': 'Vie', 'sat': 'S√°b', 'sun': 'Dom'};
  let summaryParts = [];

  checkboxes.forEach(cb => {
    const d = cb.dataset.day;
    const h = cb.dataset.hour;
    preferredSchedule.push({ day: d, hour: parseInt(h) });
    
    // Construimos el texto: "Lun 17:00"
    summaryParts.push(`${dayMap[d] || d} ${h}:00`);
  });
  
  const btn = document.getElementById("btn_select_schedule");
  btn.classList.add("selected");
  btn.innerHTML = `‚úÖ ${checkboxes.length} horarios seleccionados`;
  
  // AQU√ç EST√Å EL CAMBIO VISUAL
  const summary = document.getElementById("schedule-summary");
  summary.classList.remove("hidden");
  summary.className = "mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800";
  summary.innerHTML = `
    <div class="font-bold mb-1"><i class="fas fa-clock"></i> Selecci√≥n (Hora Cliente):</div>
    <div class="text-gray-700">${summaryParts.join(", ")}</div>
    <div class="text-xs text-gray-500 mt-1 italic">El sistema buscar√° coincidencias basadas en estos horarios.</div>
  `;
  
  showSystemMessage('success', '‚úÖ Horarios guardados', 'Presiona "Sugerir Cursos" para ver las coincidencias.');
  closeScheduleModal();
}

// ============================================
// FUNCI√ìN DE MATCHING INTELIGENTE
// ============================================
function findCourseGuideline(courseName, studentAge) {
  const searchTerm = courseName.toLowerCase();
  
  for (const [key, course] of Object.entries(COURSE_GUIDELINES)) {
    const matchesKeyword = course.keywords.some(kw => searchTerm.includes(kw));
    const matchesAge = studentAge >= course.age_range.min && studentAge <= course.age_range.max;
    
    if (matchesKeyword && matchesAge) {
      return course;
    }
  }
  
  for (const [key, course] of Object.entries(COURSE_GUIDELINES)) {
    const matchesKeyword = course.keywords.some(kw => searchTerm.includes(kw));
    if (matchesKeyword) {
      return course;
    }
  }
  
  return null;
}

    // ============================================
// FUNCI√ìN PARA GENERAR PITCH 
// ============================================
async function generatePitch() {
  const selectedId = document.getElementById("selected_course").value;
  const out = document.getElementById("pitch_output");

  if (!selectedId) {
    out.innerHTML = '<span class="text-gray-600">‚ö†Ô∏è Selecciona un curso de la lista</span>';
    return;
  }

  const course = [...LIVE_COURSE_DATA, ...LIVE_POSSIBLE_GROUPS].find(c => c.id === selectedId);
  if (!course) return;

  const studentAge = parseInt(document.getElementById("student_age").value);
  const remaining = course.capacity - course.enrolled;
  const typeLabel = course.type === 'possible' ? 'üåü GRUPO POSIBLE (creado por demanda)' : '‚úÖ GRUPO ACTIVO';
  
  const guideline = findCourseGuideline(course.name_es, studentAge);
  
  if (!guideline) {
    out.innerHTML = `
      <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-500 rounded">
        <div class="font-bold text-lg mb-2">üìä ${course.name_es}</div>
        <div class="text-sm mb-1"><b>${typeLabel}</b></div>
        <div class="text-sm mb-1">üìÖ <b>Inicio:</b> ${course.next_start}</div>
        <div class="text-sm mb-1">üíª <b>Disponibilidad:</b> ${remaining} de ${course.capacity} cupos</div>
        <div class="text-sm mb-1">üë®‚Äçüè´ <b>Instructor:</b> ${course.teacher}</div>
        ${course.isFull ? '<div class="text-orange-600 font-semibold mt-2">‚ö†Ô∏è Grupo lleno</div>' : ''}
      </div>
      <div class="p-3 bg-yellow-50 rounded">
        <p class="text-sm">‚ÑπÔ∏è Informaci√≥n no disponible para este curso</p>
      </div>
    `;
    return;
  }

  let pitchHTML = `
    <div class="space-y-4">
      <div class="p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg">
        <h3 class="text-xl font-bold mb-1">üéØ ${guideline.name}</h3>
        <p class="text-sm opacity-90">${typeLabel} | Edad: ${guideline.age_range.min}-${guideline.age_range.max} a√±os</p>
      </div>

      <div class="p-3 ${remaining <= 3 ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300'} border-l-4 rounded">
        <div class="font-semibold text-lg mb-1">üìÖ Informaci√≥n del Grupo</div>
        <div class="text-sm space-y-1">
          <div>üïê <b>Horario:</b> ${course.next_start}</div>
          <div>üí∫ <b>Cupos:</b> ${remaining} de ${course.capacity} disponibles ${remaining <= 3 ? '‚ö†Ô∏è ¬°CASI LLENO!' : ''}</div>
          <div>üë®‚Äçüè´ <b>Instructor:</b> ${course.teacher}</div>
        </div>
      </div>

      <div class="p-3 bg-purple-50 border-l-4 border-purple-400 rounded">
        <div class="font-semibold mb-2">üë§ Perfil Ideal del Estudiante</div>
        <p class="text-sm">${guideline.interest_profile}</p>
      </div>

      <div class="p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
        <div class="font-semibold mb-2">üéì Lo que Aprender√°</div>
        <div class="text-sm space-y-2">
          <div><b>üõ†Ô∏è Herramientas:</b> ${guideline.tools}</div>
          <div><b>üí™ Habilidades T√©cnicas:</b> ${guideline.hard_skills}</div>
          <div><b>üß† Habilidades Blandas:</b> ${guideline.soft_skills}</div>
        </div>
      </div>

      <div class="p-3 bg-orange-50 border-l-4 border-orange-400 rounded">
        <div class="font-semibold mb-2">‚öôÔ∏è Requisitos Importantes</div>
        <div class="text-sm space-y-1">
          <div><b>üìö Acad√©micos:</b> ${guideline.min_requirements}</div>
          <div><b>üíª T√©cnicos:</b> ${guideline.tech_requirements}</div>
        </div>
      </div>

      <div class="p-3 bg-green-50 border-l-4 border-green-500 rounded">
        <div class="font-semibold mb-2">‚ú® ¬øPor qu√© este curso es perfecto?</div>
        <ul class="text-sm space-y-1 list-disc list-inside">
          ${guideline.key_selling_points.map(point => `<li>${point}</li>`).join('')}
        </ul>
      </div>

      <div class="p-3 bg-indigo-50 border-l-4 border-indigo-400 rounded">
        <div class="font-semibold mb-1">üöÄ Siguiente Paso en su Aprendizaje</div>
        <p class="text-sm">${guideline.complementary_course}</p>
      </div>

      ${remaining <= 5 ? `
      <div class="p-4 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg text-center">
        <div class="text-lg font-bold mb-1">‚ö†Ô∏è ¬°ATENCI√ìN!</div>
        <p class="text-sm">Solo quedan <b>${remaining} cupos</b>. ${remaining <= 2 ? '¬°Asegura el lugar AHORA!' : 'Reserva antes de que se llene.'}</p>
      </div>
      ` : ''}
    </div>
  `;

  out.innerHTML = pitchHTML;
}

async function submitSale() {
  if (selectedCourses.length === 0) {
    alert("‚ö†Ô∏è Selecciona al menos un curso antes de guardar");
    return;
  }
  
  // 1. Preparar datos (Igual que antes) ...
  const tcmName = document.getElementById("tcm_name").value.trim();
  if (!tcmName) { alert("‚ö†Ô∏è Ingresa el nombre del TCM"); return; }

  let scheduleText = "";
  if (preferredSchedule && preferredSchedule.length > 0) {
    const dayMap = {'mon': 'Lun', 'tue': 'Mar', 'wed': 'Mi√©', 'thu': 'Jue', 'fri': 'Vie', 'sat': 'S√°b', 'sun': 'Dom'};
    scheduleText = preferredSchedule.map(s => `${dayMap[s.day] || s.day} ${s.hour}:00`).join(", ");
  }

  const saleData = {
    timestamp: new Date().toISOString(),
    amo_crm_link: document.getElementById("amo_crm_link").value.trim(),
    tcm_name: tcmName,
    student_age: document.getElementById("student_age").value,
    interest: document.getElementById("student_interest").value,
    course_type: document.getElementById("course_type").value,
    group_type: document.getElementById("group_type").value,
    is_sen: document.getElementById("is_sen").checked,
    preferred_schedule_text: scheduleText, 
    selected_courses: selectedCourses.map(c => {
        let finalName = c.name_es;
        if (c.type === 'active' && c.internalCode) finalName = `${c.internalCode} - ${c.name_es}`;
        return {
          id: c.id,
          name: finalName,
          type: c.type,
          schedule: c.next_start,
          teacher: c.teacher,
          semantic_id: c.semanticId || "" // Enviamos ID al sheet tambi√©n
        };
    })
  };
  
  // 2. Interfaz de carga
  const btn = document.getElementById("btn_submit_sale");
  const originalText = btn.innerHTML; // Guardamos el HTML original (icono + texto)
  btn.disabled = true;
  btn.innerText = "‚è≥ Guardando...";

  try {
    // 3. Enviar a Google Sheets
    await fetch(SALES_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(saleData)
    });
    
    // 4. L√ìGICA DE COPIADO AL PORTAPAPELES (NUEVO)
    const possibleGroup = selectedCourses.find(c => c.type === 'possible' && c.semanticId);
    let copyMessage = "";
    
    if (possibleGroup) {
        // Texto exacto solicitado: "Selector Tool - Cluster [ID]"
        const textToCopy = `Selector Tool - Cluster ${possibleGroup.semanticId}`;
        
        // Usamos la API del portapapeles
        await navigator.clipboard.writeText(textToCopy);
        copyMessage = `\n\nüìã COPIADO AL PORTAPAPELES:\n"${textToCopy}"`;
    }

    // 5. Feedback Final
    showSystemMessage('success', '‚úÖ Guardado Exitoso', 'El registro se envi√≥ correctamente.' + (copyMessage ? ' Cluster ID copiado.' : ''));
    
    // Alerta visual para confirmar el copiado antes de recargar
    if (copyMessage) {
        alert("‚úÖ ¬°Registro Guardado!\n" + copyMessage + "\n\nYa puedes pegarlo en el Formulario de Pago.");
    }
    
    // Recargar
    setTimeout(() => { location.reload(); }, 2000); // Un poco menos de tiempo para agilidad
    
  } catch (error) {
    console.error("‚ùå Error:", error);
    btn.disabled = false;
    btn.innerHTML = originalText;
    showSystemMessage('error', '‚ùå Error', 'Hubo un problema de conexi√≥n.');
  }
}

function setLanguage(lang) {
  currentLang = lang;
}

// ============================================
// L√ìGICA DE ZONA HORARIA
// ============================================

// Offset de Colombia (UTC-5)
const COLOMBIA_OFFSET = -5; 

function populateTimezones() {
  const select = document.getElementById("client_timezone");
  let html = "";
  
  // Generar de UTC-12 a UTC+14
  for (let i = -12; i <= 14; i++) {
    const sign = i >= 0 ? "+" : "";
    const label = `UTC${sign}${i}:00`;
    // Seleccionar Colombia/Per√∫/EST (UTC-5) por defecto
    const isSelected = i === -5 ? "selected" : "";
    
    // Agregamos algunas referencias comunes para ayudar al TCM (opcional, pero recomendado)
    let ref = "";
    if (i === -5) ref = " (Colombia/Per√∫/Miami)";
    else if (i === -6) ref = " (M√©xico CDMX)";
    else if (i === 1) ref = " (Espa√±a)";
    else if (i === -3) ref = " (Argentina/Chile)";
    
    html += `<option value="${i}" ${isSelected}>${label}${ref}</option>`;
  }
  select.innerHTML = html;
}

// Convierte (D√≠a/Hora Cliente) -> (D√≠a/Hora Colombia) para BUSCAR en la base de datos
function convertClientToColombia(dayStr, hourInt) {
  const clientOffset = parseInt(document.getElementById("client_timezone").value);
  const diff = COLOMBIA_OFFSET - clientOffset; // Ej: Espa√±a (+1). Diff = -5 - 1 = -6 horas.
  
  // D√≠as num√©ricos para manejar cambios de d√≠a (0=Dom, 1=Lun...)
  const days = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
  
  // Normalizar d√≠a de entrada
  let dayIndex = days.indexOf(parseDayAbbreviation(dayStr));
  if (dayIndex === -1) return { day: dayStr, hour: hourInt }; // Fallback

  let newHour = hourInt + diff;
  let newDayIndex = dayIndex;

  // Ajuste de cambio de d√≠a
  if (newHour < 0) {
    newHour += 24;
    newDayIndex = dayIndex - 1;
    if (newDayIndex < 0) newDayIndex = 6;
  } else if (newHour >= 24) {
    newHour -= 24;
    newDayIndex = dayIndex + 1;
    if (newDayIndex > 6) newDayIndex = 0;
  }

  return { day: days[newDayIndex], hour: newHour };
}

// Convierte (Hora Colombia) -> (Hora Cliente) para MOSTRAR en la tarjeta
function convertColombiaToClient(colDateObj) {
  if (!colDateObj) return "N/A";
  
  const clientOffset = parseInt(document.getElementById("client_timezone").value);
  const diff = clientOffset - COLOMBIA_OFFSET; // Ej: Espa√±a (+1). Diff = 1 - (-5) = +6 horas.
  
  // Clonamos la fecha para no modificar la original
  const clientDate = new Date(colDateObj);
  clientDate.setHours(clientDate.getHours() + diff);
  
  const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
  const dayName = days[clientDate.getDay()];
  
  const h = clientDate.getHours().toString().padStart(2, '0');
  const m = clientDate.getMinutes().toString().padStart(2, '0');
  
  return `${dayName} ${h}:${m}`;
}

function updateTimezoneDisplay() {
  // Cuando cambia la zona horaria, refrescamos los c√°lculos si hay resultados
  if (allFilteredCourses.length > 0 || allFilteredPossibleGroups.length > 0) {
    diagnoseAndMatch(); 
  }
}

// ============================================
// FUNCI√ìN PARA FORMATEAR HORA (HH:MM:SS -> HH:MM)
// ============================================
function formatTimeHHMM(timeStr) {
  if (!timeStr) return "";
  // Busca patrones como 17:00 o 17:00:00
  const match = String(timeStr).match(/(\d{1,2}):(\d{2})/);
  if (match) {
    return `${match[1].padStart(2, '0')}:${match[2].padStart(2, '0')}`;
  }
  return ""; 
}

window.onload = () => {
  setLanguage("es");
  populateTimezones();
  document.getElementById("student_age").value = 10;
  fetchCourseData().then(() => {
    updateDataSourceInfo();
  }).catch(() => {
    showSystemMessage('warning', '‚ö†Ô∏è Conexi√≥n limitada', 'No se pudo cargar la base de datos de cursos. Intenta refrescar la p√°gina.');
  });
  setInterval(() => { if (lastFetchTime) updateDataSourceInfo(); }, 30000);
};
</script>
</body>
</html>





