<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-lang-key="title_main">AI Course Matchmaker (TCM Assistant)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    #app-container { max-width: 1000px; margin: 40px auto; padding: 20px; background-color: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); }
    .card { background-color: #ffffff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
    .step-header { background-color: #f1f5f9; padding: 10px 15px; border-radius: 8px; font-weight: 600; color: #1e293b; margin-bottom: 15px; }
    .result-box { min-height: 120px; background-color: #f9fafb; border-radius: 8px; padding: 12px 14px; margin-top: 8px; border: 1px solid #e5e7eb; white-space: normal; }
    .ai-result-box { background-color: #ecfdf5; border-left: 4px solid #10b981; padding: 15px; border-radius: 6px; }
    .course-option { border-radius: 10px; border: 1px solid #e5e7eb; background-color: #ffffff; padding: 10px 12px; margin-bottom: 10px; }
    .course-option.critical { background-color: #fef2f2; border-color: #fecaca; }
    .course-option-title { font-weight: 600; margin-bottom: 6px; color: #111827; }
    .course-option-row { font-size: 0.875rem; color: #374151; margin-bottom: 2px; }
    .course-option-row strong { font-weight: 600; }
    .course-option-urgency { font-size: 0.85rem; margin-top: 4px; }
    .course-option-urgency.critical-text { color: #b91c1c; font-weight: 700; }
  </style>
</head>
<body>

  <!-- Selector de idioma -->
  <div id="language-selector" class="flex justify-end max-w-5xl mx-auto mt-4 px-4">
    <select onchange="setLanguage(this.value)" class="p-2 border border-gray-300 rounded-lg text-sm">
      <option value="es" selected>Espa√±ol (ES)</option>
      <option value="en">English (EN)</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π (RU)</option>
    </select>
  </div>

  <div id="app-container">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-4 text-center" data-lang-key="title_main">
      ü§ñ AI Course Matchmaker (TCM Assistant)
    </h1>
    <p class="text-center text-gray-600 mb-6" data-lang-key="subtitle_main">
      Herramienta de diagn√≥stico de ventas para asegurar la colocaci√≥n correcta y reducir el churn por expectativas.
    </p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- STEP 1 -->
      <div class="card">
        <div class="step-header" data-lang-key="step1_header">1. Diagn√≥stico del Estudiante</div>

        <label for="student_age" class="block text-sm font-medium text-gray-700 mb-1" data-lang-key="label_age">
          Edad del Estudiante (7-17 a√±os):
        </label>
        <input type="number" id="student_age" min="7" max="17" value="10"
          class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" />

        <label for="student_interest" class="block text-sm font-medium text-gray-700 mb-1" data-lang-key="label_interest">
          Inter√©s Principal:
        </label>
        <select id="student_interest"
          class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
          <option value="coding" data-lang-key="opt_coding">Programaci√≥n (L√≥gica)</option>
          <option value="design" data-lang-key="opt_design">Dise√±o / Arte Digital</option>
          <option value="games" data-lang-key="opt_games">Creaci√≥n de Videojuegos</option>
        </select>

        <label for="student_level" class="block text-sm font-medium text-gray-700 mb-1" data-lang-key="label_level">
          Experiencia Previa (TC Assessment):
        </label>
        <select id="student_level"
          class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
          <option value="beginner" data-lang-key="opt_beginner">Principiante (Cero experiencia)</option>
          <option value="intermediate" data-lang-key="opt_intermediate">Intermedio (Sabe bloques/Scratch)</option>
          <option value="advanced" data-lang-key="opt_advanced">Avanzado (Sabe Python b√°sico/Roblox)</option>
        </select>

        <button id="btn_suggest" onclick="diagnoseAndMatch(false)"
          class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150"
          data-lang-key="btn_suggest">
          üîç Sugerir Cursos (AI Match)
        </button>

        <div class="mt-3 text-xs text-gray-500">
          Data source: <b>Google Sheets (GViz, live)</b>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="card">
        <div class="step-header" data-lang-key="step2_header">2. Tres Mejores Opciones y Pitch</div>

        <label for="course_recommendation" class="block text-sm font-medium text-gray-700 mb-1"
          data-lang-key="label_suggested_courses">
          Cursos Sugeridos (Top 3 Priorizados):
        </label>
        <div id="course_recommendation" class="result-box text-gray-800 text-sm" data-lang-key="status_waiting">
          Esperando diagn√≥stico...
        </div>

        <div class="mt-4">
          <label for="selected_course" class="block text-sm font-medium text-gray-700 mb-1"
            data-lang-key="label_select_pitch">
            Selecciona la Opci√≥n para Generar el Pitch (Ver Pitch de Venta):
          </label>
          <select id="selected_course"
            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <option value="" data-lang-key="opt_first_diagnose">-- Primero Diagnosticar --</option>
          </select>
        </div>

        <button id="btn_pitch" onclick="generatePitch()"
          class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150 mt-4"
          data-lang-key="btn_pitch">
          üé§ Generar Pitch (AI Venta)
        </button>
      </div>

      <!-- STEP 3 -->
      <div class="lg:col-span-2 card">
        <div class="step-header" data-lang-key="step3_header">3. Argumento de Venta (Output de IA)</div>
        <div id="pitch_output" class="ai-result-box text-gray-800 text-sm" data-lang-key="status_pitch_placeholder">
          El argumento de venta aparecer√° aqu√≠. Seleccione un curso y presione 'Generar Pitch'.
        </div>

        <div id="loading_indicator" class="mt-4 hidden text-center text-blue-600 font-semibold"
          data-lang-key="status_loading">
          Cargando an√°lisis de IA y datos de disponibilidad...
        </div>
      </div>

    </div>
  </div>

<script>
  // ---------- CONFIG ----------
  // PUBLIC "publish to web" ID + gid from your link
  const SHEET_PUB_ID = "2PACX-1vRiopvWS8N7E_A7G10Y85jND6Pl7n2Acgm4tdeQRImxtRuGS1mUuSHyQavLytAelrP1fsLU_8EcHH6e";
  const SHEET_GID = "2084392899";

  // Correct GViz endpoint (IMPORTANT)
  function buildGvizUrl() {
    const cb = Date.now(); // cache-buster for live updates
    return `https://docs.google.com/spreadsheets/d/e/${SHEET_PUB_ID}/gviz/tq?gid=${SHEET_GID}&tqx=out:json&cb=${cb}`;
  }

  const API_KEY = ""; // if you don't use Gemini, keep empty
  const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
  const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

  let currentLang = "es";
  let LIVE_COURSE_DATA = [];

  // ---------- TRADUCCIONES ----------
  const translations = {
    es: {
      title_main: "ü§ñ AI Course Matchmaker (TCM Assistant)",
      subtitle_main: "Herramienta de diagn√≥stico de ventas para asegurar la colocaci√≥n correcta y reducir el churn por expectativas.",
      step1_header: "1. Diagn√≥stico del Estudiante",
      label_age: "Edad del Estudiante (7-17 a√±os):",
      label_interest: "Inter√©s Principal:",
      label_level: "Experiencia Previa (TC Assessment):",
      opt_coding: "Programaci√≥n (L√≥gica)",
      opt_design: "Dise√±o / Arte Digital",
      opt_games: "Creaci√≥n de Videojuegos",
      opt_beginner: "Principiante (Cero experiencia)",
      opt_intermediate: "Intermedio (Sabe bloques/Scratch)",
      opt_advanced: "Avanzado (Sabe Python b√°sico/Roblox)",
      btn_suggest: "üîç Sugerir Cursos (AI Match)",
      btn_pitch: "üé§ Generar Pitch (AI Venta)",
      step2_header: "2. Tres Mejores Opciones y Pitch",
      label_suggested_courses: "Cursos Sugeridos (Top 3 Priorizados):",
      status_waiting: "Esperando diagn√≥stico...",
      label_select_pitch: "Selecciona la Opci√≥n para Generar el Pitch (Ver Pitch de Venta):",
      opt_first_diagnose: "-- Primero Diagnosticar --",
      step3_header: "3. Argumento de Venta (Output de IA)",
      status_pitch_placeholder: "El argumento de venta aparecer√° aqu√≠. Seleccione un curso y presione 'Generar Pitch'.",
      status_loading: "Cargando an√°lisis de IA y datos de disponibilidad...",
      output_details_title: "DETALLES CR√çTICOS DEL GRUPO:",
      output_pitch_title: "ARGUMENTO DE VENTA GENERADO POR IA:",
      output_schedule: "Horario Fijo:",
      output_slots: "Cupos:",
      output_teacher: "Tutor:",
      output_remaining: "restantes",
      output_option: "OPCI√ìN",
      output_critical: "CR√çTICO",
      output_max_urgency: "M√ÅXIMA URGENCIA DE LLENADO",
      error_no_groups: "‚ö†Ô∏è No se encontraron grupos disponibles para este perfil (no llenos y con fecha desde hoy en adelante).",
      error_invalid_age: "Por favor, ingresa una edad v√°lida.",
      error_no_option: "Por favor, selecciona un curso de la lista.",
      error_ai_fail: "Error al conectar con el asistente de IA. Usando datos de BO.",
      error_ai_fail_details: "El sistema no pudo generar el argumento de venta, pero aqu√≠ est√°n los datos de disponibilidad de BO:",
      error_sheet: "Error al conectar con Google Sheets. Verifica que el documento est√© publicado y accesible."
    },
    en: {
      title_main: "ü§ñ AI Course Matchmaker (TCM Assistant)",
      subtitle_main: "Sales diagnostic tool to ensure correct placement and reduce churn due to expectations.",
      step1_header: "1. Student Diagnosis",
      label_age: "Student Age (7-17 years):",
      label_interest: "Main Interest:",
      label_level: "Previous Experience (TC Assessment):",
      opt_coding: "Coding (Logic)",
      opt_design: "Design / Digital Art",
      opt_games: "Video Game Creation",
      opt_beginner: "Beginner (Zero experience)",
      opt_intermediate: "Intermediate (Knows blocks/Scratch)",
      opt_advanced: "Advanced (Knows basic Python/Roblox)",
      btn_suggest: "üîç Suggest Courses (AI Match)",
      btn_pitch: "üé§ Generate Pitch (AI Sale)",
      step2_header: "2. Top Three Options & Pitch",
      label_suggested_courses: "Suggested Courses (Top 3 Prioritized):",
      status_waiting: "Awaiting diagnosis...",
      label_select_pitch: "Select Option to Generate Pitch:",
      opt_first_diagnose: "-- Diagnose First --",
      step3_header: "3. Sales Pitch (AI Output)",
      status_pitch_placeholder: "The sales pitch will appear here. Select a course and press 'Generate Pitch'.",
      status_loading: "Loading AI analysis and availability data...",
      output_details_title: "CRITICAL GROUP DETAILS:",
      output_pitch_title: "AI-GENERATED SALES ARGUMENT:",
      output_schedule: "Fixed Schedule:",
      output_slots: "Slots:",
      output_teacher: "Tutor:",
      output_remaining: "remaining",
      output_option: "OPTION",
      output_critical: "CRITICAL",
      output_max_urgency: "MAX FILLING URGENCY",
      error_no_groups: "‚ö†Ô∏è No available groups found (not full and starting today or later).",
      error_invalid_age: "Please enter a valid age.",
      error_no_option: "Please select a course from the list.",
      error_ai_fail: "Error connecting to AI. Using BO data.",
      error_ai_fail_details: "Could not generate pitch, but here is BO availability:",
      error_sheet: "Error connecting to Google Sheets. Verify it is published and accessible."
    },
    ru: {
      title_main: "ü§ñ AI –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è TCM (–ü–æ–¥–±–æ—Ä –ö—É—Ä—Å–æ–≤)",
      subtitle_main: "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂: –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ –æ—Ç—Ç–æ–∫–∞ –∏–∑-–∑–∞ –æ–∂–∏–¥–∞–Ω–∏–π.",
      step1_header: "1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —É—á–µ–Ω–∏–∫–∞",
      label_age: "–í–æ–∑—Ä–∞—Å—Ç —É—á–µ–Ω–∏–∫–∞ (7-17 –ª–µ—Ç):",
      label_interest: "–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–µ—Å:",
      label_level: "–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ–ø—ã—Ç (TC):",
      opt_coding: "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ (–õ–æ–≥–∏–∫–∞)",
      opt_design: "–î–∏–∑–∞–π–Ω / –¶–∏—Ñ—Ä–æ–≤–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ",
      opt_games: "–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ–∏–≥—Ä",
      opt_beginner: "–ù–∞—á–∞–ª—å–Ω—ã–π",
      opt_intermediate: "–°—Ä–µ–¥–Ω–∏–π",
      opt_advanced: "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π",
      btn_suggest: "üîç –ü–æ–¥–æ–±—Ä–∞—Ç—å –∫—É—Ä—Å—ã (AI Match)",
      btn_pitch: "üé§ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Ç—á (AI)",
      step2_header: "2. –¢–æ–ø-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏ –ø–∏—Ç—á",
      label_suggested_courses: "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—Ç–æ–ø-3):",
      status_waiting: "–û–∂–∏–¥–∞–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...",
      label_select_pitch: "–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –¥–ª—è –ø–∏—Ç—á–∞:",
      opt_first_diagnose: "-- –°–Ω–∞—á–∞–ª–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ --",
      step3_header: "3. –ü–∏—Ç—á (AI Output)",
      status_pitch_placeholder: "–ü–∏—Ç—á –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å. –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏ –Ω–∞–∂–º–∏—Ç–µ '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å'.",
      status_loading: "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...",
      output_details_title: "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò –ì–†–£–ü–ü–´:",
      output_pitch_title: "AI –ü–ò–¢–ß:",
      output_schedule: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:",
      output_slots: "–ú–µ—Å—Ç–∞:",
      output_teacher: "–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:",
      output_remaining: "–æ—Å—Ç–∞–ª–æ—Å—å",
      output_option: "–í–ê–†–ò–ê–ù–¢",
      output_critical: "–ö–†–ò–¢–ò–ß–ù–û",
      output_max_urgency: "–ú–ê–ö–°. –°–†–û–ß–ù–û–°–¢–¨",
      error_no_groups: "‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø (–Ω–µ –ø–æ–ª–Ω—ã–µ –∏ —Å—Ç–∞—Ä—Ç —Å–µ–≥–æ–¥–Ω—è/–ø–æ–∑–∂–µ).",
      error_invalid_age: "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç.",
      error_no_option: "–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏–∑ —Å–ø–∏—Å–∫–∞.",
      error_ai_fail: "–û—à–∏–±–∫–∞ AI. –ò—Å–ø–æ–ª—å–∑—É—é –¥–∞–Ω–Ω—ã–µ BO.",
      error_ai_fail_details: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Ç—á, –Ω–æ –≤–æ—Ç –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:",
      error_sheet: "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—é."
    }
  };

  function getTranslation(key) {
    return translations[currentLang]?.[key] || translations["es"][key] || key;
  }

  function updateDynamicElements() {
    document.querySelectorAll("[data-lang-key]").forEach((el) => {
      const k = el.getAttribute("data-lang-key");
      if (translations[currentLang]?.[k]) el.textContent = translations[currentLang][k];
    });

    const updateSelectOptions = (id) => {
      const select = document.getElementById(id);
      if (!select) return;
      Array.from(select.options).forEach((opt) => {
        const k = opt.getAttribute("data-lang-key");
        if (k) opt.textContent = getTranslation(k);
      });
    };

    updateSelectOptions("student_interest");
    updateSelectOptions("student_level");
    updateSelectOptions("selected_course");
  }

  function setLanguage(lang) {
    currentLang = lang;
    updateDynamicElements();
  }

  // ---------- HELPERS ----------
  function normalizeLabel(s) {
    return String(s || "")
      .trim()
      .toLowerCase()
      .replace(/\s+/g, "_")
      .replace(/[^\w_]/g, "");
  }

  function parseAgeRange(ageStr) {
    const m = (ageStr || "").match(/(\d+)\D+(\d+)/);
    if (m) return { min: parseInt(m[1], 10), max: parseInt(m[2], 10) };
    return { min: 7, max: 17 };
  }

  function inferInterest(courseTitle) {
    const t = (courseTitle || "").toLowerCase();
    if (t.includes("roblox") || t.includes("minecraft") || t.includes("game") || t.includes("–∏–≥—Ä")) return "games";
    if (t.includes("design") || t.includes("figma") || t.includes("art") || t.includes("–¥–∏–∑")) return "design";
    return "coding";
  }

  function parseGvizDateCell(cell) {
    // cell can be: {v:"Date(2025,11,20)"} or {f:"2025-12-20"} or {v:"2025-12-20"}
    if (!cell) return null;

    const raw = cell.v ?? cell.f ?? null;
    if (!raw) return null;

    // Date(YYYY,MM,DD,hh,mm,ss)
    const m = String(raw).match(/Date\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+),\s*(\d+),\s*(\d+))?\)/);
    if (m) {
      const year = parseInt(m[1], 10);
      const month = parseInt(m[2], 10); // 0-based in GViz
      const day = parseInt(m[3], 10);
      const hh = m[4] ? parseInt(m[4], 10) : 0;
      const mm = m[5] ? parseInt(m[5], 10) : 0;
      const ss = m[6] ? parseInt(m[6], 10) : 0;
      const d = new Date(year, month, day, hh, mm, ss);
      return isNaN(d.getTime()) ? null : d;
    }

    // ISO yyyy-mm-dd
    const iso = String(raw).match(/(\d{4}-\d{2}-\d{2})/);
    if (iso) {
      const d = new Date(iso[1] + "T00:00:00");
      return isNaN(d.getTime()) ? null : d;
    }

    // fallback
    const d = new Date(raw);
    return isNaN(d.getTime()) ? null : d;
  }

  function formatDateYYYYMMDD(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function formatTimeHHMMSS(cell) {
    if (!cell) return "";
    const raw = cell.f ?? cell.v ?? "";
    return String(raw || "").trim();
  }

  function getFillRatio(course) {
    if (!course.capacity) return 0;
    return course.enrolled / course.capacity;
  }

  function getCourseName(course) {
    const key = "name_" + currentLang;
    return course[key] || course.name_es || "Curso Kodland";
  }

  // ---------- GVIZ PARSER ----------
  function extractGvizJson(rawText) {
    // Handles: /*O_o*/\ngoogle.visualization.Query.setResponse({...});
    const start = rawText.indexOf("setResponse(");
    if (start === -1) throw new Error("Could not find setResponse() in GViz response.");

    const from = start + "setResponse(".length;
    const end = rawText.lastIndexOf(");");
    if (end === -1 || end <= from) throw new Error("Could not locate end of GViz JSON payload.");

    const jsonLike = rawText.slice(from, end).trim();
    return JSON.parse(jsonLike);
  }

  function buildColumnIndexMap(obj) {
    const cols = obj?.table?.cols || [];
    const map = {};
    cols.forEach((c, idx) => {
      const label = normalizeLabel(c?.label || `col_${idx}`);
      map[label] = idx;
    });
    return map;
  }

  function findCol(map, candidates) {
    // candidates: ["first_lesson_date_gmt", "first_lesson_date", ...]
    for (const c of candidates) {
      const key = normalizeLabel(c);
      if (map[key] != null) return map[key];
    }
    // fuzzy contains
    const keys = Object.keys(map);
    for (const cand of candidates) {
      const norm = normalizeLabel(cand);
      const hit = keys.find(k => k.includes(norm));
      if (hit) return map[hit];
    }
    return null;
  }

  function getCell(row, idx) {
    if (idx == null) return null;
    return row?.c?.[idx] ?? null;
  }

  function parseCoursesFromGviz(rawText) {
    const obj = extractGvizJson(rawText);
    if (!obj?.table?.rows) throw new Error("GViz returned no rows.");

    const colMap = buildColumnIndexMap(obj);

    // required / preferred columns (by your screenshot)
    const idxGroupTitle = findCol(colMap, ["group_title"]);
    const idxCourseTitle = findCol(colMap, ["course_title"]);
    const idxCourseAge = findCol(colMap, ["course_age"]);
    const idxCapacity = findCol(colMap, ["capacity"]);
    const idxEnrolled = findCol(colMap, ["enrolled_stu", "enrolled_students", "enrolled"]);
    const idxStatus = findCol(colMap, ["status"]);
    const idxTeacher = findCol(colMap, ["teacher"]);
    const idxFirstLessonDate = findCol(colMap, ["first_lesson_date_gmt", "first_lesson_date"]);
    const idxFirstLessonTime = findCol(colMap, ["first_lesson_time_gmt", "first_lesson_time"]);

    const today = new Date();
    const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    const courses = obj.table.rows.map((row, i) => {
      const groupTitleCell = getCell(row, idxGroupTitle);
      const courseTitleCell = getCell(row, idxCourseTitle);
      const courseAgeCell = getCell(row, idxCourseAge);
      const capacityCell = getCell(row, idxCapacity);
      const enrolledCell = getCell(row, idxEnrolled);
      const statusCell = getCell(row, idxStatus);
      const teacherCell = getCell(row, idxTeacher);
      const dateCell = getCell(row, idxFirstLessonDate);
      const timeCell = getCell(row, idxFirstLessonTime);

      const group_title = (groupTitleCell?.v ?? groupTitleCell?.f ?? "").toString().trim();
      const course_title = (courseTitleCell?.v ?? courseTitleCell?.f ?? "").toString().trim();
      const course_age = (courseAgeCell?.v ?? courseAgeCell?.f ?? "").toString().trim();

      const capacity = capacityCell?.v != null ? parseInt(capacityCell.v, 10) : 0;
      const enrolled = enrolledCell?.v != null ? parseInt(enrolledCell.v, 10) : 0;

      const status = (statusCell?.v ?? statusCell?.f ?? "").toString().trim();
      const teacher = (teacherCell?.v ?? teacherCell?.f ?? "Tutor N/A").toString().trim();

      const startDateObj = parseGvizDateCell(dateCell);
      const timeStr = formatTimeHHMMSS(timeCell);

      const ageRange = parseAgeRange(course_age);

      const displayDate = startDateObj ? formatDateYYYYMMDD(startDateObj) : (dateCell?.f || dateCell?.v || "N/A");
      const next_start = (displayDate && timeStr) ? `${displayDate} | ${timeStr}` : (displayDate || "N/A");

      return {
        id: `${i}_${group_title || course_title || "NA"}_${displayDate}_${timeStr}`,
        name_es: group_title || course_title || "N/A",
        name_en: group_title || course_title || "N/A",
        name_ru: group_title || course_title || "N/A",
        topic: course_title || group_title || "Curso Kodland",
        min_age: ageRange.min,
        max_age: ageRange.max,
        interest: inferInterest(course_title || group_title),
        level: "beginner",
        enrolled: enrolled || 0,
        capacity: capacity || 0,
        next_start,
        teacher,
        status,
        startDateObj
      };
    });

    // filters: not full, not archived/closed, start date >= today (if present)
    return courses.filter(c => {
      if (!c.name_es || c.name_es === "N/A") return false;
      if (c.capacity <= c.enrolled) return false;

      const st = String(c.status || "").toLowerCase();
      if (st === "closed" || st === "archived") return false;

      if (c.startDateObj && c.startDateObj < todayMidnight) return false;
      return true;
    });
  }

  async function fetchCourseData() {
    const url = buildGvizUrl();
    try {
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const text = await resp.text();

      LIVE_COURSE_DATA = parseCoursesFromGviz(text);

      if (!LIVE_COURSE_DATA.length) {
        throw new Error("No valid courses found (maybe all full/archived/past).");
      }
    } catch (err) {
      console.error("Error fetching/parsing Google Sheets:", err);
      const box = document.getElementById("course_recommendation");
      box.innerHTML = `<span class="text-red-600 font-semibold">${getTranslation("error_sheet")}</span>`;
      // helpful popup like you had
      alert("Error al obtener datos. Revisa la consola para m√°s detalles.");
      throw err;
    }
  }

  // ---------- MATCH ----------
  async function diagnoseAndMatch(isLanguageChange = false) {
    const resultsDiv = document.getElementById("course_recommendation");
    const selectElement = document.getElementById("selected_course");

    if (!LIVE_COURSE_DATA.length && !isLanguageChange) {
      resultsDiv.innerHTML =
        `<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> ${getTranslation("status_loading")}</span>`;
      try {
        await fetchCourseData();
      } catch (_) { return; }
    }

    const age = parseInt(document.getElementById("student_age").value, 10);
    const interest = document.getElementById("student_interest").value;
    const level = document.getElementById("student_level").value;

    if (isNaN(age) || age < 7 || age > 17) {
      resultsDiv.innerHTML = `<span class="text-red-600 font-semibold">${getTranslation("error_invalid_age")}</span>`;
      return;
    }

    let filtered = LIVE_COURSE_DATA.filter(c =>
      c.capacity > c.enrolled &&
      age >= c.min_age &&
      age <= c.max_age &&
      c.interest === interest
    );

    // level hook (optional)
    if (level === "beginner") {
      // keep all
    }

    filtered.sort((a, b) => getFillRatio(b) - getFillRatio(a));
    const top3 = filtered.slice(0, 3);

    if (!top3.length) {
      resultsDiv.innerHTML = `<span class="text-red-600 font-semibold">${getTranslation("error_no_groups")}</span>`;
      selectElement.innerHTML = `<option value="">${getTranslation("opt_first_diagnose")}</option>`;
      return;
    }

    let html = "";
    top3.forEach((course, idx) => {
      const remaining = course.capacity - course.enrolled;
      const name = getCourseName(course);
      const critical = remaining <= 2;

      html += `
        <div class="course-option ${critical ? "critical" : ""}">
          <div class="course-option-title">
            ${getTranslation("output_option")} ${idx + 1}: ${name}
          </div>
          <div class="course-option-row">
            ‚è∞ <strong>${getTranslation("output_schedule")}</strong> ${course.next_start}
          </div>
          <div class="course-option-row ${critical ? "text-orange-600 font-semibold" : ""}">
            üíª <strong>${getTranslation("output_slots")}</strong>
            ${course.enrolled}/${course.capacity} (${remaining} ${getTranslation("output_remaining")})
          </div>
          <div class="course-option-row">
            üë®‚Äçüè´ <strong>${getTranslation("output_teacher")}</strong> ${course.teacher}
          </div>
          ${critical ? `<div class="course-option-urgency critical-text">üö® ${getTranslation("output_max_urgency")} üö®</div>` : ""}
        </div>`;
    });

    resultsDiv.innerHTML = html;

    selectElement.innerHTML = `<option value="">${getTranslation("opt_first_diagnose")}</option>`;
    top3.forEach((course) => {
      const remaining = course.capacity - course.enrolled;
      const urgencyTag =
        remaining <= 2 ? ` (${getTranslation("output_critical")} - ${remaining} ${getTranslation("output_remaining")})` : "";
      selectElement.innerHTML += `<option value="${course.id}">${getCourseName(course)} - ${course.next_start}${urgencyTag}</option>`;
    });

    document.getElementById("pitch_output").innerHTML = getTranslation("status_pitch_placeholder");
  }

  // ---------- PITCH ----------
  async function generatePitch() {
    const selectedId = document.getElementById("selected_course").value;
    const loading = document.getElementById("loading_indicator");
    const out = document.getElementById("pitch_output");

    if (!selectedId) {
      out.innerHTML = getTranslation("error_no_option");
      return;
    }

    const course = LIVE_COURSE_DATA.find((c) => c.id === selectedId);
    if (!course) return;

    const remaining = course.capacity - course.enrolled;
    loading.classList.remove("hidden");
    out.innerHTML = "";

    const pitchLanguage =
      currentLang === "ru" ? "ruso" : currentLang === "en" ? "ingl√©s" : "espa√±ol";

    const baseInfo = `
      <div class="mb-4 p-2 bg-blue-100 rounded-lg">
        <b>${getTranslation("output_details_title")}</b>
        <div class="course-option-row">üìÖ <strong>${getTranslation("output_schedule")}</strong> ${course.next_start}</div>
        <div class="course-option-row">üßë‚Äçüíª <strong>${getTranslation("output_slots")}</strong> ${remaining} ${getTranslation("output_remaining")} (de ${course.capacity})</div>
        <div class="course-option-row">üë®‚Äçüè´ <strong>${getTranslation("output_teacher")}</strong> ${course.teacher}</div>
      </div>
    `;

    if (!API_KEY) {
      out.innerHTML = baseInfo + "<p><i>(Gemini API key vac√≠a: mostrando solo datos de BO)</i></p>";
      loading.classList.add("hidden");
      return;
    }

    const systemPrompt = `Act√∫a como un vendedor (TCM) experto en Kodland. Genera un pitch persuasivo en ${pitchLanguage}, m√°ximo 150 palabras, centrado en el valor educativo del curso (${course.topic}).`;
    const userQuery = `Genera un pitch de venta para ${getCourseName(course)}. El estudiante tiene ${document.getElementById("student_age").value} a√±os.`;

    const payload = {
      contents: [{ parts: [{ text: userQuery }] }],
      systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
      if (!text) throw new Error("Empty response text.");

      out.innerHTML =
        baseInfo +
        `<b>${getTranslation("output_pitch_title")}</b>
         <p style="margin-top:10px;line-height:1.6;">${text.replace(/\n/g, "<br>").trim()}</p>`;
    } catch (err) {
      console.error("Error Gemini:", err);
      out.innerHTML =
        `<div class="mb-4 p-2 bg-red-100 rounded-lg">
          <b class="text-red-700">‚ö†Ô∏è ${getTranslation("error_ai_fail")}</b>
          <p>${getTranslation("error_ai_fail_details")}</p>
        </div>` + baseInfo;
    } finally {
      loading.classList.add("hidden");
    }
  }

  // ---------- INIT ----------
  window.onload = () => {
    setLanguage("es");
    document.getElementById("student_age").value = 10;
    document.getElementById("student_interest").value = "coding";
    document.getElementById("student_level").value = "beginner";

    const resultsDiv = document.getElementById("course_recommendation");
    resultsDiv.innerHTML =
      `<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> ${getTranslation("status_loading")}</span>`;

    fetchCourseData()
      .then(() => { resultsDiv.innerHTML = getTranslation("status_waiting"); })
      .catch(() => {});
  };
</script>

</body>
</html>



