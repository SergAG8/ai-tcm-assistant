<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Course Matchmaker (TCM Assistant)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    body { font-family: 'Inter', sans-serif; background-color:#f8fafc; }
    #app-container { max-width:1400px; margin:40px auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.05); }
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:20px; }
    .step-header { background:#f1f5f9; padding:10px 15px; border-radius:8px; font-weight:600; color:#1e293b; margin-bottom:15px; }
    .result-box { min-height:120px; background:#f9fafb; border-radius:8px; padding:12px 14px; margin-top:8px; border:1px solid #e5e7eb; white-space:normal; }
    .ai-result-box { background:#ecfdf5; border-left:4px solid #10b981; padding:15px; border-radius:6px; }
    .error-box { background:#fef2f2; border-left:4px solid #ef4444; padding:15px; border-radius:6px; margin:10px 0; }
    .warning-box { background:#fffbeb; border-left:4px solid #f59e0b; padding:15px; border-radius:6px; margin:10px 0; }
    .success-box { background:#f0fdf4; border-left:4px solid #22c55e; padding:15px; border-radius:6px; margin:10px 0; }
    .course-option { border-radius:10px; border:1px solid #e5e7eb; background:#fff; padding:10px 12px; margin-bottom:10px; }
    .course-option.critical { background:#fef2f2; border-color:#fecaca; }
    .course-option.almost-full { background:#fffbeb; border-color:#fcd34d; }
    .course-option.selected { background:#dbeafe; border:2px solid #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .course-option.possible-group { background:#f0fdf4; border-color:#86efac; }
    .course-option-title { font-weight:600; margin-bottom:6px; color:#111827; }
    .course-option-row { font-size:.875rem; color:#374151; margin-bottom:2px; }
    .course-option-row strong { font-weight:600; }
    .course-option-urgency { font-size:.85rem; margin-top:4px; }
    .course-option-urgency.critical-text { color:#b91c1c; font-weight:700; }
    .course-option-urgency.warning-text { color:#d97706; font-weight:600; }
    .course-option-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-top: 4px; }
    .badge-possible { background: #d1fae5; color: #065f46; }
    .badge-active { background: #dbeafe; color: #1e40af; }
    .connection-status { position: fixed; top: 20px; right: 20px; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; z-index: 1000; }
    .connection-status.connected { background: #22c55e; color: white; }
    .connection-status.disconnected { background: #ef4444; color: white; }
    .connection-status.loading { background: #3b82f6; color: white; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; display: none; }
    .modal-overlay.active { display: block; }
    .modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; z-index: 9999; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: none; }
    .modal-container.active { display: block; }
    .modal-header { position: sticky; top: 0; background: white; padding: 20px; border-bottom: 2px solid #e5e7eb; z-index: 10; }
    .modal-body { padding: 20px; }
    .btn-select { padding: 8px 16px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .btn-select.selected { background: #3b82f6; color: white; }
    .btn-select.unselected { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
    .btn-select.unselected:hover { background: #e5e7eb; }
    .btn-select.disabled { opacity: 0.5; cursor: not-allowed; }
    .schedule-btn { background: #f97316; color: white; padding: 10px 16px; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.15s; width: 100%; margin-top: 12px; border: none; }
    .schedule-btn:hover { background: #ea580c; }
    .schedule-btn.selected { background: #22c55e; }
  </style>
</head>

<body>
  <div id="connection-status" class="connection-status loading">
    <i class="fas fa-spinner fa-spin"></i> Conectando...
  </div>

  <div id="language-selector" class="flex justify-end max-w-7xl mx-auto mt-4 px-4">
    <select onchange="setLanguage(this.value)" class="p-2 border border-gray-300 rounded-lg text-sm">
      <option value="es" selected>Espa√±ol (ES)</option>
      <option value="en">English (EN)</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π (RU)</option>
    </select>
  </div>

  <div id="app-container">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-4 text-center">
      ü§ñ AI Course Matchmaker (TCM Assistant)
    </h1>
    <p class="text-center text-gray-600 mb-6">
      Herramienta de diagn√≥stico de ventas para asegurar la colocaci√≥n correcta y reducir el churn por expectativas.
    </p>

    <div id="system-messages"></div>

    <!-- FILA SUPERIOR: 3 COLUMNAS -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

      <!-- COLUMNA 1: Diagn√≥stico -->
      <div class="card">
        <div class="step-header">1. Diagn√≥stico del Estudiante</div>

        <label for="amo_crm_link" class="block text-sm font-medium text-gray-700 mb-1">
          üîó amo CRM Link:
        </label>
        <input type="url" id="amo_crm_link" placeholder="https://kodland.amocrm.com/leads/detail/..."
               class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" />

        <label for="student_age" class="block text-sm font-medium text-gray-700 mb-1">
          Edad del Estudiante (7-17 a√±os):
        </label>
        <input type="number" id="student_age" min="7" max="17" value="10"
               class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" />

        <label for="student_interest" class="block text-sm font-medium text-gray-700 mb-1">
          Inter√©s Principal:
        </label>
        <select id="student_interest" onchange="updateCourseTypeOptions()"
                class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
          <option value="coding">Programaci√≥n (L√≥gica)</option>
          <option value="design">Dise√±o / Arte Digital</option>
          <option value="games">Creaci√≥n de Videojuegos</option>
        </select>

        <label for="course_type" class="block text-sm font-medium text-gray-700 mb-1">
          Tipo de Curso Espec√≠fico:
        </label>
        <select id="course_type"
                class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
          <option value="">-- Todos los cursos de este inter√©s --</option>
        </select>

        <label for="group_type" class="block text-sm font-medium text-gray-700 mb-1">
          Tipo de Grupo:
        </label>
        <select id="group_type"
                class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
          <option value="regular">Regular</option>
          <option value="premium">Premium (PRM)</option>
        </select>

        <!-- NUEVO: Selector de Horario Preferido -->
        <button id="btn_select_schedule" onclick="openPreferredScheduleModal()" class="schedule-btn">
          üïê Seleccionar Horario Preferido
        </button>
        <div id="schedule-summary" class="text-xs text-gray-600 mt-2 hidden"></div>

        <div class="flex items-center mb-4 mt-4 p-3 bg-gray-50 rounded-lg">
          <input type="checkbox" id="is_sen" 
                 class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
          <label for="is_sen" class="ml-2 text-sm font-medium text-gray-700">
            ‚≠ê Estudiante SEN (Special Educational Needs)
          </label>
        </div>

        <button id="btn_suggest"
                onclick="diagnoseAndMatch()"
                class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">
          üîç Sugerir Cursos (AI Match)
        </button>

        <div class="mt-2 text-xs text-gray-500">
          <span id="data-source-info">Data source: <b>Conectando...</b></span>
        </div>
      </div>

      <!-- COLUMNA 2: TOP 3 GRUPOS ACTIVOS -->
      <div class="card">
        <div class="step-header">2. Grupos Activos (Top 3)</div>

        <label class="block text-sm font-medium text-gray-700 mb-1">
          Cursos Activos Sugeridos:
        </label>
        <div id="course_recommendation" class="result-box text-gray-800 text-sm">
          Esperando diagn√≥stico...
        </div>
      </div>

      <!-- COLUMNA 3: GRUPOS POSIBLES -->
      <div class="card">
        <div class="step-header">3. Grupos Posibles (Top 3)</div>

        <label class="block text-sm font-medium text-gray-700 mb-1">
          Grupos Creados por Demanda:
        </label>
        <div id="possible_groups_list" class="result-box text-gray-600 text-sm">
          <div class="text-center py-4">
            <i class="fas fa-hourglass-half text-gray-400 text-2xl mb-2"></i>
            <p>Esperando diagn√≥stico...</p>
          </div>
        </div>
      </div>

    </div>

    <!-- FILA INFERIOR: 2 COLUMNAS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- COLUMNA 1: ARGUMENTO DE VENTA -->
      <div class="card">
        <div class="step-header">4. Argumento de Venta (Output de IA)</div>

        <label for="selected_course" class="block text-sm font-medium text-gray-700 mb-1">
          Selecciona la Opci√≥n para Generar el Pitch:
        </label>
        <select id="selected_course"
                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4">
          <option value="">-- Selecciona un curso primero --</option>
        </select>

        <button id="btn_pitch"
                onclick="generatePitch()"
                class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150">
          üé§ Generar Pitch (AI Venta)
        </button>

        <div id="pitch_output" class="ai-result-box text-gray-800 text-sm mt-4">
          El argumento de venta aparecer√° aqu√≠. Seleccione un curso y presione 'Generar Pitch'.
        </div>

        <div id="loading_indicator" class="mt-4 hidden text-center text-blue-600 font-semibold">
          Cargando an√°lisis de IA y datos de disponibilidad...
        </div>
      </div>

      <!-- COLUMNA 2: ENVIAR VENTA -->
      <div class="card bg-gradient-to-br from-blue-50 to-purple-50">
        <div class="step-header bg-blue-100">5. Confirmar y Enviar Venta</div>

        <div id="sale-summary" class="mb-4 p-3 bg-white rounded-lg border border-blue-200">
          <h3 class="font-semibold text-gray-800 mb-2">üìã Resumen de la Venta:</h3>
          <div id="summary-content" class="text-sm text-gray-600">
            Completa el diagn√≥stico y selecciona un curso para ver el resumen.
          </div>
        </div>

        <button id="btn_submit_sale"
                onclick="submitSale()"
                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
          üì§ Enviar Venta y Guardar Registro
        </button>

        <p class="text-xs text-gray-500 mt-2 text-center">
          Los datos se guardar√°n en el Google Sheet de TCM Sales
        </p>
      </div>

    </div>
  </div>

  <!-- Modal para ver todos los cursos activos -->
  <div id="modal-overlay" class="modal-overlay" onclick="closeCoursesModal()"></div>
  <div id="courses-modal" class="modal-container">
    <div class="modal-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Todos los Cursos Activos Disponibles</h2>
          <p class="text-sm text-gray-600 mt-1">Selecciona hasta 2 cursos para generar pitch</p>
        </div>
        <button onclick="closeCoursesModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
          √ó
        </button>
      </div>
      <div id="selected-count" class="mt-3 text-sm font-semibold text-blue-600"></div>
    </div>
    <div id="modal-courses-list" class="modal-body"></div>
  </div>

  <!-- Modal para ver todos los grupos posibles -->
  <div id="possible-modal-overlay" class="modal-overlay" onclick="closePossibleGroupsModal()"></div>
  <div id="possible-groups-modal" class="modal-container">
    <div class="modal-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Todos los Grupos Posibles Disponibles</h2>
          <p class="text-sm text-gray-600 mt-1">Grupos creados por demanda de estudiantes</p>
        </div>
        <button onclick="closePossibleGroupsModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
          √ó
        </button>
      </div>
    </div>
    <div id="modal-possible-groups-list" class="modal-body"></div>
  </div>

  <!-- Modal para Preferred Schedule -->
  <div id="schedule-modal-overlay" class="modal-overlay" onclick="closeScheduleModal()"></div>
  <div id="schedule-modal" class="modal-container">
    <div class="modal-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 class="text-xl font-bold text-gray-900">üïê Selecciona tu Horario Preferido</h2>
          <p class="text-sm text-gray-600 mt-1">Marca los horarios que te funcionan (puedes seleccionar varios)</p>
        </div>
        <button onclick="closeScheduleModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
          √ó
        </button>
      </div>
    </div>
    <div class="modal-body">
      <div style="overflow-x: auto;">
        <table class="w-full border-collapse text-sm">
          <thead>
            <tr class="bg-gray-100">
              <th class="border p-2 font-semibold">Hora</th>
              <th class="border p-2 font-semibold">Lun</th>
              <th class="border p-2 font-semibold">Mar</th>
              <th class="border p-2 font-semibold">Mi√©</th>
              <th class="border p-2 font-semibold">Jue</th>
              <th class="border p-2 font-semibold">Vie</th>
              <th class="border p-2 font-semibold">S√°b</th>
              <th class="border p-2 font-semibold">Dom</th>
            </tr>
          </thead>
          <tbody id="schedule-table-body"></tbody>
        </table>
      </div>
      <button onclick="submitPreferredSchedule()" 
              class="w-full bg-orange-600 text-white p-3 rounded-lg font-semibold hover:bg-orange-700 transition duration-150 mt-4">
        ‚úÖ Confirmar Horarios Seleccionados
      </button>
    </div>
  </div>

  <script>
// ============================================
// CONFIGURACI√ìN DE SPREADSHEETS
// ============================================
const SHEET_ID = "2PACX-1vRiopvWS8N7E_A7G10Y85jND6Pl7n2Acgm4tdeQRImxtRuGS1mUuSHyQavLytAelrP1fsLU_8EcHH6e";
const SHEET_GID = "2084392899";

// NUEVO: Configuraci√≥n para Possible Groups
const POSSIBLE_GROUPS_SHEET_ID = "2PACX-1vRfJ1Dc2mTlooFRM6Jc0r-zKyrjmbWFGCOaT3UeiOc0vyihrxBL8UaN3n8Z0QxxJDfSEwzQYn1-YmIM";
const POSSIBLE_GROUPS_GID = "1601359885";

const SALES_SCRIPT_URL = "";

const DATA_SOURCES = {
  active: {
    csv: `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv`,
    json: `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`
  },
  possible: {
    csv: `https://docs.google.com/spreadsheets/d/e/${POSSIBLE_GROUPS_SHEET_ID}/pub?gid=${POSSIBLE_GROUPS_GID}&single=true&output=csv`,
    json: `https://docs.google.com/spreadsheets/d/e/${POSSIBLE_GROUPS_SHEET_ID}/gviz/tq?tqx=out:json&gid=${POSSIBLE_GROUPS_GID}`
  }
};

const API_KEY = "";
const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

// ============================================
// VARIABLES GLOBALES
// ============================================
let currentLang = "es";
let LIVE_COURSE_DATA = [];
let LIVE_POSSIBLE_GROUPS = [];
let connectionStatus = { connected: false, method: null };
let lastFetchTime = null;
let isFetching = false;
let allFilteredCourses = [];
let allFilteredPossibleGroups = [];
let selectedCourses = [];
let preferredSchedule = [];

// ============================================
// FUNCIONES DE UI Y CONEXI√ìN
// ============================================
function updateConnectionStatus(status) {
  const statusEl = document.getElementById('connection-status');
  statusEl.className = 'connection-status ' + status;
  if (status === 'connected') statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Conectado';
  else if (status === 'disconnected') statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Sin conexi√≥n';
  else statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando...';
}

function showSystemMessage(type, title, message) {
  const container = document.getElementById('system-messages');
  const msgId = 'msg-' + Date.now();
  const html = `<div id="${msgId}" class="${type}-box"><div style="display: flex; justify-content: space-between; align-items: start;"><div><strong>${title}</strong><p class="text-sm mt-1">${message}</p></div><button onclick="document.getElementById('${msgId}').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button></div></div>`;
  container.innerHTML = html + container.innerHTML;
  if (type === 'success') setTimeout(() => { const el = document.getElementById(msgId); if (el) el.remove(); }, 5000);
}

// ============================================
// FUNCIONES DE PARSING
// ============================================
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(',').map(v => v.trim().replace(/['"]/g, ''));
    if (values.length === headers.length) rows.push(values);
  }
  return { headers, rows };
}

function parseAgeRange(ageStr) {
  const m = String(ageStr || "").match(/(\d+)\D+(\d+)/);
  return m ? { min: parseInt(m[1],10), max: parseInt(m[2],10) } : { min: 7, max: 17 };
}

function inferInterest(courseTitle) {
  const t = String(courseTitle || "").toLowerCase();
  if (t.includes("roblox") || t.includes("minecraft") || t.includes("game")) return "games";
  if (t.includes("design") || t.includes("figma") || t.includes("art")) return "design";
  return "coding";
}

function extractCourseType(courseName, courseTitle) {
  const title = String(courseTitle || courseName || "").toLowerCase();
  if (title.includes("roblox")) return "Roblox";
  if (title.includes("minecraft")) return "Minecraft";
  if (title.includes("unity")) return "Unity";
  if (title.includes("godot")) return "Godot";
  if (title.includes("game")) return "Desarrollo de Videojuegos";
  if (title.includes("figma")) return "Figma";
  if (title.includes("photoshop")) return "Photoshop";
  if (title.includes("illustrator")) return "Illustrator";
  if (title.includes("canva")) return "Canva";
  if (title.includes("blender")) return "Blender 3D";
  if (title.includes("design")) return "Dise√±o Digital";
  if (title.includes("python")) return "Python";
  if (title.includes("javascript") || title.includes("js")) return "JavaScript";
  if (title.includes("scratch")) return "Scratch";
  if (title.includes("web")) return "Desarrollo Web";
  if (title.includes("app")) return "Desarrollo de Apps";
  if (title.includes("c++")) return "C++";
  if (title.includes("java")) return "Java";
  return courseTitle || null;
}

function parseISODateOnly(s) {
  const m = String(s || "").match(/(\d{4}-\d{2}-\d{2})/);
  if (!m) return null;
  const d = new Date(m[1] + "T00:00:00");
  return isNaN(d.getTime()) ? null : d;
}

function parseTimeToMinutes(timeStr) {
  // Parsea formato "HH:MM" a minutos desde medianoche
  const match = String(timeStr || "").match(/(\d{1,2}):(\d{2})/);
  if (!match) return null;
  return parseInt(match[1]) * 60 + parseInt(match[2]);
}

function parseDayAbbreviation(dayStr) {
  const dayMap = {
    'mon': 'lunes', 'monday': 'lunes', 'lun': 'lunes',
    'tue': 'martes', 'tuesday': 'martes', 'mar': 'martes',
    'wed': 'mi√©rcoles', 'wednesday': 'mi√©rcoles', 'mi√©': 'mi√©rcoles', 'mie': 'mi√©rcoles',
    'thu': 'jueves', 'thursday': 'jueves', 'jue': 'jueves',
    'fri': 'viernes', 'friday': 'viernes', 'vie': 'viernes',
    'sat': 's√°bado', 'saturday': 's√°bado', 's√°b': 's√°bado', 'sab': 's√°bado',
    'sun': 'domingo', 'sunday': 'domingo', 'dom': 'domingo'
  };
  const normalized = String(dayStr || "").toLowerCase().trim();
  return dayMap[normalized] || normalized;
}

// ============================================
// MAPEO DE DATOS: GRUPOS ACTIVOS
// ============================================
function mapRowsToCourses(headers, rows) {
  const findCol = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
  const idx_group = findCol("group_title");
  const idx_course = findCol("course_title");
  const idx_age = findCol("age");
  const idx_capacity = findCol("capacity");
  const idx_enrolled = findCol("enrolled");
  const idx_status = findCol("status");
  const idx_teacher = findCol("teacher") >= 0 ? findCol("teacher") : findCol("tutor");
  const idx_date = findCol("date");
  const idx_time = findCol("time");

  const today = new Date();
  today.setHours(0,0,0,0);
  const twoWeeksAgo = new Date(today);
  twoWeeksAgo.setDate(today.getDate() - 14);

  const courses = [];
  for (let i = 0; i < rows.length; i++) {
    const r = rows[i];
    const groupTitle = idx_group >= 0 ? (r[idx_group] || "") : "";
    const name = groupTitle || (idx_course >= 0 ? r[idx_course] : "");
    const topic = idx_course >= 0 ? r[idx_course] : name;
    const capacity = idx_capacity >= 0 ? parseInt(r[idx_capacity] || "0") : 0;
    const enrolled = idx_enrolled >= 0 ? parseInt(r[idx_enrolled] || "0") : 0;
    const status = idx_status >= 0 ? r[idx_status] : "";
    const teacher = idx_teacher >= 0 ? r[idx_teacher] : "Tutor N/A";
    const dateStr = idx_date >= 0 ? r[idx_date] : "";
    const timeStr = idx_time >= 0 ? r[idx_time] : "";

    if (groupTitle.includes("WRONG") || !name || status.toLowerCase() === "closed") continue;
    
    // NUEVO: Filtrar grupos sobrevendidos (enrolled > capacity)
    if (capacity > 0 && enrolled > capacity) continue;
    
    const startDate = parseISODateOnly(dateStr);
    // NUEVO: Para grupos al 100%, solo mostrar si iniciaron hace m√°ximo 2 semanas
    if (startDate) {
      if (capacity > 0 && enrolled === capacity) {
        // Grupo lleno al 100%
        if (startDate < twoWeeksAgo) continue; // No mostrar si inici√≥ hace m√°s de 2 semanas
      } else {
        // Grupos no llenos: solo mostrar si no han iniciado o iniciaron hace m√°ximo 2 semanas
        if (startDate < twoWeeksAgo) continue;
      }
    }

    const ageRange = parseAgeRange(idx_age >= 0 ? r[idx_age] : "");
    courses.push({
      id: `active_${i}_${name}_${dateStr}`,
      name_es: name,
      topic: topic || name,
      courseTitle: topic,
      min_age: ageRange.min,
      max_age: ageRange.max,
      interest: inferInterest(topic),
      courseType: extractCourseType(name, topic),
      enrolled: enrolled,
      capacity: capacity,
      isFull: capacity > 0 && enrolled >= capacity,
      next_start: dateStr && timeStr ? `${dateStr} | ${timeStr}` : (dateStr || "N/A"),
      teacher: teacher,
      startDateObj: startDate,
      timeStr: timeStr,
      timeMinutes: parseTimeToMinutes(timeStr),
      type: 'active'
    });
  }
  return courses;
}

// ============================================
// MAPEO DE DATOS: GRUPOS POSIBLES
// ============================================
function mapRowsToPossibleGroups(headers, rows) {
  // Columnas esperadas:
  // A: Course, B: Format, C: Day, D: Hora, E: Students, G: Age Range
  const findCol = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
  
  const idx_course = 0; // Columna A
  const idx_format = 1; // Columna B
  const idx_day = 2; // Columna C
  const idx_hora = 3; // Columna D
  const idx_students = 4; // Columna E
  const idx_age = 6; // Columna G

  const groups = [];
  for (let i = 0; i < rows.length; i++) {
    const r = rows[i];
    const courseName = r[idx_course] || "";
    const format = (r[idx_format] || "").toLowerCase();
    const day = parseDayAbbreviation(r[idx_day] || "");
    const hora = r[idx_hora] || "";
    const students = parseInt(r[idx_students] || "0");
    const ageRange = parseAgeRange(r[idx_age] || "");

    if (!courseName) continue;

    // Determinar capacidad seg√∫n formato
    const isPremium = format.includes("prm") || format.includes("premium");
    const capacity = isPremium ? 4 : 14;

    // NUEVO: No mostrar grupos sobrevendidos
    if (students > capacity) continue;

    groups.push({
      id: `possible_${i}_${courseName}_${day}_${hora}`,
      name_es: courseName,
      topic: courseName,
      courseTitle: courseName,
      format: isPremium ? "premium" : "regular",
      day: day,
      hora: hora,
      timeMinutes: parseTimeToMinutes(hora),
      enrolled: students,
      capacity: capacity,
      isFull: students >= capacity,
      min_age: ageRange.min,
      max_age: ageRange.max,
      interest: inferInterest(courseName),
      courseType: extractCourseType(courseName, courseName),
      next_start: `${day} | ${hora}`,
      teacher: "Por asignar",
      type: 'possible'
    });
  }
  return groups;
}

// ============================================
// FUNCIONES DE FETCH
// ============================================
async function fetchWithCSV(dataSource) {
  let url = dataSource.csv + "&_=" + Date.now();
  let resp;
  try {
    resp = await fetch(url, { mode: 'cors', cache: "no-store" });
  } catch {
    url = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    resp = await fetch(url, { cache: "no-store" });
  }
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const text = await resp.text();
  return parseCSV(text);
}

async function fetchWithGViz(dataSource) {
  let url = dataSource.json + "&_=" + Date.now();
  let resp;
  try {
    resp = await fetch(url, { mode: 'cors', cache: "no-store" });
  } catch {
    url = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    resp = await fetch(url, { cache: "no-store" });
  }
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  let text = await resp.text();
  text = text.replace(/^.*?google\.visualization\.Query\.setResponse\(/, '').replace(/\);?\s*$/, '');
  const data = JSON.parse(text);
  const headers = data.table.cols.map(col => col.label || col.id || "");
  const rows = data.table.rows.map(row => row.c.map(cell => cell ? (cell.v || "") : ""));
  return { headers, rows };
}

function updateDataSourceInfo() {
  const el = document.getElementById('data-source-info');
  if (lastFetchTime) {
    const diffSec = Math.floor((new Date() - lastFetchTime) / 1000);
    const timeAgo = diffSec < 60 ? `${diffSec}s` : `${Math.floor(diffSec/60)}m`;
    el.innerHTML = `Data source: <b>${connectionStatus.method}</b> | <span class="text-xs text-green-600">‚úì ${timeAgo}</span>`;
  }
}

async function fetchCourseData(forceRefresh = false) {
  if (isFetching && !forceRefresh) return;
  isFetching = true;
  updateConnectionStatus('loading');
  
  const methods = [
    { name: 'CSV Export', fn: fetchWithCSV }, 
    { name: 'GViz JSON', fn: fetchWithGViz }
  ];

  // Fetch Active Groups
  for (const method of methods) {
    try {
      const result = await method.fn(DATA_SOURCES.active);
      LIVE_COURSE_DATA = mapRowsToCourses(result.headers, result.rows);
      if (LIVE_COURSE_DATA.length === 0) throw new Error("No hay cursos activos");
      break;
    } catch (err) {
      console.warn(`‚úó Active ${method.name}:`, err.message);
    }
  }

  // Fetch Possible Groups
  for (const method of methods) {
    try {
      const result = await method.fn(DATA_SOURCES.possible);
      LIVE_POSSIBLE_GROUPS = mapRowsToPossibleGroups(result.headers, result.rows);
      break;
    } catch (err) {
      console.warn(`‚úó Possible ${method.name}:`, err.message);
    }
  }

  if (LIVE_COURSE_DATA.length === 0 && LIVE_POSSIBLE_GROUPS.length === 0) {
    connectionStatus = { connected: false, method: null };
    isFetching = false;
    updateConnectionStatus('disconnected');
    throw new Error("Error de conexi√≥n");
  }

  connectionStatus = { connected: true, method: 'Multi-source' };
  lastFetchTime = new Date();
  updateConnectionStatus('connected');
  updateDataSourceInfo();
  isFetching = false;
}

// ============================================
// C√ÅLCULO DE PRIORIDAD
// ============================================
function calculatePriority(course) {
  const remaining = course.capacity - course.enrolled;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const daysUntilStart = course.startDateObj ? Math.floor((course.startDateObj - today) / (1000 * 60 * 60 * 24)) : 999;
  
  let urgencyScore = 0;
  if (course.isFull) {
    urgencyScore = 5;
  } else if (remaining === 1) {
    urgencyScore = 1000;
  } else if (remaining === 2) {
    urgencyScore = 900;
  } else if (remaining === 3) {
    urgencyScore = 800;
  } else if (remaining === 4) {
    urgencyScore = 700;
  } else if (remaining === 5) {
    urgencyScore = 600;
  } else if (remaining <= 10) {
    urgencyScore = 500 - (remaining * 10);
  } else {
    urgencyScore = 300 - remaining;
  }
  
  let proximityScore = 0;
  if (daysUntilStart <= 0) proximityScore = 50;
  else if (daysUntilStart <= 7) proximityScore = 40;
  else if (daysUntilStart <= 14) proximityScore = 30;
  else if (daysUntilStart <= 30) proximityScore = 20;
  else proximityScore = Math.max(0, 10 - (daysUntilStart / 10));
  
  return (urgencyScore * 0.95) + (proximityScore * 0.05);
}

// NUEVO: Calcular match score para horarios
function calculateScheduleMatchScore(course) {
  if (preferredSchedule.length === 0) return 0;
  
  let bestScore = 0;
  const courseTime = course.timeMinutes;
  const courseDay = course.day ? course.day.toLowerCase() : null;
  
  if (!courseTime) return 0;
  
  const dayMap = {
    'mon': 'lunes', 'tue': 'martes', 'wed': 'mi√©rcoles',
    'thu': 'jueves', 'fri': 'viernes', 'sat': 's√°bado', 'sun': 'domingo'
  };
  
  for (const pref of preferredSchedule) {
    const prefTime = pref.hour * 60;
    const prefDay = dayMap[pref.day];
    const timeDiff = Math.abs(courseTime - prefTime);
    
    // Prioridad 1: Mismo d√≠a + misma hora (exacto o muy cercano)
    if (courseDay === prefDay && timeDiff <= 30) {
      bestScore = Math.max(bestScore, 1000 - timeDiff);
    }
    // Prioridad 2: Misma hora (¬±30min) + d√≠a diferente
    else if (timeDiff <= 30) {
      bestScore = Math.max(bestScore, 800 - timeDiff);
    }
    // Prioridad 3: Mismo d√≠a + hora cercana (¬±2 horas = 120 min)
    else if (courseDay === prefDay && timeDiff <= 120) {
      bestScore = Math.max(bestScore, 600 - timeDiff);
    }
    // Prioridad 4: D√≠a diferente + hora cercana (¬±2 horas)
    else if (timeDiff <= 120) {
      bestScore = Math.max(bestScore, 400 - timeDiff);
    }
  }
  
  return bestScore;
}

// ============================================
// FUNCIONES DE ACTUALIZACI√ìN DE UI
// ============================================
function updateCourseTypeOptions() {
  const interest = document.getElementById("student_interest").value;
  const courseTypeSelect = document.getElementById("course_type");
  if (!LIVE_COURSE_DATA.length && !LIVE_POSSIBLE_GROUPS.length) {
    courseTypeSelect.innerHTML = '<option value="">-- Cargando... --</option>';
    return;
  }
  const types = new Set();
  [...LIVE_COURSE_DATA, ...LIVE_POSSIBLE_GROUPS].forEach(c => {
    if (c.interest === interest && c.courseType) types.add(c.courseType);
  });
  courseTypeSelect.innerHTML = '<option value="">-- Todos --</option>';
  Array.from(types).sort().forEach(type => {
    courseTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
  });
}

// ============================================
// DIAGN√ìSTICO Y MATCHING
// ============================================
async function diagnoseAndMatch() {
  const activeDiv = document.getElementById("course_recommendation");
  const possibleDiv = document.getElementById("possible_groups_list");
  
  activeDiv.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> Cargando grupos activos...</span>';
  possibleDiv.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> Cargando grupos posibles...</span>';
  
  try {
    await fetchCourseData(true);
  } catch {
    activeDiv.innerHTML = '<span class="text-red-600">Error de conexi√≥n</span>';
    possibleDiv.innerHTML = '<span class="text-red-600">Error de conexi√≥n</span>';
    return;
  }

  const age = parseInt(document.getElementById("student_age").value, 10);
  const interest = document.getElementById("student_interest").value;
  const courseType = document.getElementById("course_type").value;
  const groupType = document.getElementById("group_type").value;

  if (isNaN(age) || age < 7 || age > 17) {
    activeDiv.innerHTML = '<span class="text-red-600">Edad inv√°lida</span>';
    possibleDiv.innerHTML = '<span class="text-red-600">Edad inv√°lida</span>';
    return;
  }

  // Filtrar grupos activos
  let filteredActive = LIVE_COURSE_DATA.filter(c => {
    const basicMatch = age >= c.min_age && age <= c.max_age && c.interest === interest;
    if (!basicMatch) return false;
    if (courseType && c.courseType !== courseType) return false;
    const isPremium = (c.name_es || "").toUpperCase().includes("PRM");
    if (groupType === "premium" && !isPremium) return false;
    if (groupType === "regular" && isPremium) return false;
    return true;
  });

  // Filtrar grupos posibles
  let filteredPossible = LIVE_POSSIBLE_GROUPS.filter(c => {
    const basicMatch = age >= c.min_age && age <= c.max_age && c.interest === interest;
    if (!basicMatch) return false;
    if (courseType && c.courseType !== courseType) return false;
    if (groupType !== c.format) return false;
    return true;
  });

  // Calcular scores
  filteredActive.forEach(course => {
    course.priority = calculatePriority(course);
    course.scheduleScore = calculateScheduleMatchScore(course);
  });
  
  filteredPossible.forEach(course => {
    course.priority = calculatePriority(course);
    course.scheduleScore = calculateScheduleMatchScore(course);
  });

  // Si hay horarios preferidos, priorizar por schedule match
  if (preferredSchedule.length > 0) {
    filteredActive.sort((a, b) => {
      if (b.scheduleScore !== a.scheduleScore) return b.scheduleScore - a.scheduleScore;
      return b.priority - a.priority;
    });
    filteredPossible.sort((a, b) => {
      if (b.scheduleScore !== a.scheduleScore) return b.scheduleScore - a.scheduleScore;
      return b.priority - a.priority;
    });
  } else {
    filteredActive.sort((a, b) => b.priority - a.priority);
    filteredPossible.sort((a, b) => b.priority - a.priority);
  }

  allFilteredCourses = filteredActive;
  allFilteredPossibleGroups = filteredPossible;
  selectedCourses = [];

  // Renderizar grupos activos
  if (filteredActive.length === 0) {
    activeDiv.innerHTML = '<span class="text-gray-600">No hay grupos activos para estos criterios</span>';
  } else {
    const top3Active = filteredActive.slice(0, 3);
    let html = renderCourseList(top3Active, true);
    if (filteredActive.length > 3) {
      html += `<div class="mt-4 text-center"><button onclick="openCoursesModal()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700">üìã Ver todos los ${filteredActive.length} grupos activos</button></div>`;
    }
    activeDiv.innerHTML = html;
  }

  // Renderizar grupos posibles
  if (filteredPossible.length === 0) {
    possibleDiv.innerHTML = '<span class="text-gray-600">No hay grupos posibles para estos criterios</span>';
  } else {
    const top3Possible = filteredPossible.slice(0, 3);
    let html = renderCourseList(top3Possible, false);
    if (filteredPossible.length > 3) {
      html += `<div class="mt-4 text-center"><button onclick="openPossibleGroupsModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700">üìã Ver todos los ${filteredPossible.length} grupos posibles</button></div>`;
    }
    possibleDiv.innerHTML = html;
  }

  // Mensaje de coincidencia de horario
  if (preferredSchedule.length > 0) {
    const hasMatches = filteredActive.some(c => c.scheduleScore > 0) || filteredPossible.some(c => c.scheduleScore > 0);
    if (hasMatches) {
      showSystemMessage('success', '‚úÖ Coincidencias encontradas', 'Se encontraron cursos que coinciden con los horarios preferidos');
    } else {
      showSystemMessage('warning', '‚ö†Ô∏è Sin coincidencias exactas', 'No se encontraron cursos con los horarios exactos, pero aqu√≠ est√°n todas las opciones disponibles');
    }
  }

  updatePitchDropdown();
  updateSaleSummary();
}

function renderCourseList(courses, showIndex = true) {
  let html = "";
  courses.forEach((course, idx) => {
    const remaining = course.capacity - course.enrolled;
    const critical = remaining <= 2 && remaining > 0;
    const almostFull = remaining > 2 && remaining <= 5;
    const isSelected = selectedCourses.some(c => c.id === course.id);
    
    let cardClass = "course-option";
    if (course.type === 'possible') cardClass += " possible-group";
    else if (course.isFull) cardClass += " critical";
    else if (critical) cardClass += " critical";
    else if (almostFull) cardClass += " almost-full";
    
    if (isSelected) cardClass += " selected";
    
    const displayIdx = showIndex ? `OPCI√ìN ${idx + 1}` : `#${idx + 1}`;
    const badge = course.type === 'possible' 
      ? '<span class="course-option-badge badge-possible">GRUPO POSIBLE</span>'
      : '<span class="course-option-badge badge-active">GRUPO ACTIVO</span>';
    
    html += `<div class="${cardClass}" id="course-card-${course.id}">
      <div class="course-option-title">${displayIdx}: ${course.name_es} ${badge}</div>
      <div class="course-option-row">‚è∞ ${course.next_start}</div>
      <div class="course-option-row ${critical || course.isFull ? "text-orange-600 font-semibold" : ""}">üíª ${course.enrolled}/${course.capacity} (${remaining} restantes)</div>
      <div class="course-option-row">üë®‚Äçüè´ ${course.teacher}</div>`;
    
    // Mostrar score de coincidencia de horario si existe
    if (preferredSchedule.length > 0 && course.scheduleScore > 0) {
      let matchText = "‚ú® Coincidencia de horario";
      if (course.scheduleScore >= 900) matchText = "üéØ Coincidencia EXACTA";
      else if (course.scheduleScore >= 700) matchText = "‚ú® Muy similar a tu horario";
      else if (course.scheduleScore >= 500) matchText = "üìç Horario cercano";
      html += `<div class="course-option-row text-green-600 font-semibold">${matchText}</div>`;
    }
    
    if (course.isFull) {
      html += '<div class="course-option-urgency critical-text">‚ö†Ô∏è GRUPO LLENO - REQUIERE AUTORIZACI√ìN</div>';
    } else if (remaining === 1) {
      html += '<div class="course-option-urgency critical-text">üö® ¬°√öLTIMO CUPO DISPONIBLE! üö®</div>';
    } else if (remaining === 2) {
      html += '<div class="course-option-urgency critical-text">üö® URGENTE - 2 cupos üö®</div>';
    } else if (remaining === 3) {
      html += '<div class="course-option-urgency warning-text">‚ö†Ô∏è Casi lleno - 3 cupos</div>';
    } else if (almostFull) {
      html += `<div class="course-option-urgency warning-text">‚ö†Ô∏è Casi lleno - ${remaining} cupos</div>`;
    }
    
    html += `<button onclick="toggleCourseSelection('${course.id}')" class="btn-select mt-3 w-full ${isSelected ? "selected" : "unselected"}" id="btn-select-${course.id}">${isSelected ? "‚úì Seleccionado" : "Seleccionar"}</button>
    </div>`;
  });
  return html;
}

// ============================================
// SELECCI√ìN DE CURSOS
// ============================================
function toggleCourseSelection(courseId) {
  const course = [...allFilteredCourses, ...allFilteredPossibleGroups].find(c => c.id === courseId);
  if (!course) return;
  const isSelected = selectedCourses.some(c => c.id === courseId);
  if (isSelected) {
    selectedCourses = selectedCourses.filter(c => c.id !== courseId);
  } else {
    if (selectedCourses.length >= 2) {
      alert("‚ö†Ô∏è M√°ximo 2 cursos para comparaci√≥n");
      return;
    }
    selectedCourses.push(course);
  }
  updateSelectionUI();
  updatePitchDropdown();
  updateSaleSummary();
}

function updateSelectionUI() {
  [...allFilteredCourses, ...allFilteredPossibleGroups].forEach(course => {
    const btn = document.getElementById(`btn-select-${course.id}`);
    const card = document.getElementById(`course-card-${course.id}`);
    const isSelected = selectedCourses.some(c => c.id === course.id);
    if (btn) {
      btn.className = `btn-select mt-3 w-full ${isSelected ? "selected" : "unselected"}`;
      btn.textContent = isSelected ? "‚úì Seleccionado" : "Seleccionar";
      if (selectedCourses.length >= 2 && !isSelected) btn.classList.add("disabled");
    }
    if (card) {
      isSelected ? card.classList.add("selected") : card.classList.remove("selected");
    }
  });
  const countEl = document.getElementById("selected-count");
  if (countEl) countEl.textContent = `${selectedCourses.length}/2 cursos seleccionados`;
}

function updatePitchDropdown() {
  const selectElement = document.getElementById("selected_course");
  const submitBtn = document.getElementById("btn_submit_sale");
  if (selectedCourses.length === 0) {
    selectElement.innerHTML = '<option value="">-- Selecciona un curso primero --</option>';
    submitBtn.disabled = true;
    return;
  }
  selectElement.innerHTML = '<option value="">-- Elige cu√°l pitch generar --</option>';
  selectedCourses.forEach((course, idx) => {
    const remaining = course.capacity - course.enrolled;
    let urgencyTag = "";
    if (remaining === 1) urgencyTag = " (¬°√öLTIMO CUPO!)";
    else if (remaining === 2) urgencyTag = " (URGENTE - 2 cupos)";
    else if (remaining === 3) urgencyTag = " (Casi lleno - 3 cupos)";
    else if (remaining <= 5) urgencyTag = ` (${remaining} cupos)`;
    
    const typeTag = course.type === 'possible' ? " [GRUPO POSIBLE]" : "";
    
    selectElement.innerHTML += `<option value="${course.id}">Curso ${idx + 1}: ${course.name_es}${urgencyTag}${typeTag}</option>`;
  });
  submitBtn.disabled = false;
}

function updateSaleSummary() {
  const summaryContent = document.getElementById("summary-content");
  const amoCrm = document.getElementById("amo_crm_link").value.trim();
  const age = document.getElementById("student_age").value;
  const interest = document.getElementById("student_interest").value;
  const groupType = document.getElementById("group_type").value;
  const isSen = document.getElementById("is_sen").checked;
  
  if (selectedCourses.length === 0) {
    summaryContent.innerHTML = '<p class="text-gray-500">Completa el diagn√≥stico y selecciona cursos</p>';
    return;
  }
  
  let html = '<div class="space-y-2">';
  if (amoCrm) html += `<div><strong>amo CRM:</strong> <a href="${amoCrm}" target="_blank" class="text-blue-600 hover:underline">Ver lead</a></div>`;
  html += `<div><strong>Edad:</strong> ${age} a√±os</div>`;
  html += `<div><strong>Inter√©s:</strong> ${interest}</div>`;
  html += `<div><strong>Tipo:</strong> ${groupType}</div>`;
  if (isSen) html += '<div><strong>SEN:</strong> ‚≠ê S√≠</div>';
  if (preferredSchedule.length > 0) {
    html += `<div><strong>Horarios preferidos:</strong> ${preferredSchedule.length} seleccionados</div>`;
  }
  html += `<div class="mt-2"><strong>Cursos seleccionados:</strong> ${selectedCourses.length}</div>`;
  selectedCourses.forEach((c, idx) => {
    const remaining = c.capacity - c.enrolled;
    const typeLabel = c.type === 'possible' ? ' [POSIBLE]' : ' [ACTIVO]';
    html += `<div class="text-sm pl-4">‚Ä¢ <strong>Opci√≥n ${idx + 1}:</strong> ${c.name_es} (${remaining} cupos)${typeLabel}</div>`;
  });
  html += '</div>';
  summaryContent.innerHTML = html;
}

// ============================================
// MODALES
// ============================================
function openCoursesModal() {
  const modal = document.getElementById("courses-modal");
  const overlay = document.getElementById("modal-overlay");
  const modalBody = document.getElementById("modal-courses-list");
  modalBody.innerHTML = renderCourseList(allFilteredCourses, false);
  modal.classList.add("active");
  overlay.classList.add("active");
  updateSelectionUI();
}

function closeCoursesModal() {
  document.getElementById("courses-modal").classList.remove("active");
  document.getElementById("modal-overlay").classList.remove("active");
}

function openPossibleGroupsModal() {
  const modal = document.getElementById("possible-groups-modal");
  const overlay = document.getElementById("possible-modal-overlay");
  const modalBody = document.getElementById("modal-possible-groups-list");
  modalBody.innerHTML = renderCourseList(allFilteredPossibleGroups, false);
  modal.classList.add("active");
  overlay.classList.add("active");
  updateSelectionUI();
}

function closePossibleGroupsModal() {
  document.getElementById("possible-groups-modal").classList.remove("active");
  document.getElementById("possible-modal-overlay").classList.remove("active");
}

function openPreferredScheduleModal() {
  const modal = document.getElementById("schedule-modal");
  const overlay = document.getElementById("schedule-modal-overlay");
  const tbody = document.getElementById("schedule-table-body");
  const days = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
  let html = "";
  for (let hour = 6; hour <= 22; hour++) {
    const timeStr = `${hour.toString().padStart(2, '0')}:00`;
    html += `<tr><td class="border p-2 font-medium">${timeStr}</td>`;
    days.forEach(day => {
      const checkId = `schedule-${day}-${hour}`;
      const isChecked = preferredSchedule.some(p => p.day === day && p.hour === hour);
      html += `<td class="border p-2 text-center"><input type="checkbox" id="${checkId}" class="w-5 h-5 cursor-pointer schedule-checkbox" data-day="${day}" data-hour="${hour}" ${isChecked ? 'checked' : ''}/></td>`;
    });
    html += "</tr>";
  }
  tbody.innerHTML = html;
  modal.classList.add("active");
  overlay.classList.add("active");
}

function closeScheduleModal() {
  document.getElementById("schedule-modal").classList.remove("active");
  document.getElementById("schedule-modal-overlay").classList.remove("active");
}

function submitPreferredSchedule() {
  const checkboxes = document.querySelectorAll('.schedule-checkbox:checked');
  if (checkboxes.length === 0) {
    alert("‚ö†Ô∏è Selecciona al menos un horario preferido");
    return;
  }
  preferredSchedule = [];
  checkboxes.forEach(cb => {
    preferredSchedule.push({ day: cb.dataset.day, hour: parseInt(cb.dataset.hour) });
  });
  
  // Actualizar UI del bot√≥n
  const btn = document.getElementById("btn_select_schedule");
  btn.classList.add("selected");
  btn.innerHTML = `‚úÖ ${checkboxes.length} horarios seleccionados`;
  
  // Mostrar resumen
  const summary = document.getElementById("schedule-summary");
  summary.classList.remove("hidden");
  summary.innerHTML = `<i class="fas fa-check-circle text-green-600"></i> ${checkboxes.length} horarios guardados - Se buscar√°n coincidencias`;
  
  showSystemMessage('success', '‚úÖ Horarios guardados', `${checkboxes.length} horarios seleccionados. Presiona "Sugerir Cursos" para buscar coincidencias`);
  closeScheduleModal();
}

// ============================================
// GENERACI√ìN DE PITCH
// ============================================
async function generatePitch() {
  const selectedId = document.getElementById("selected_course").value;
  const loading = document.getElementById("loading_indicator");
  const out = document.getElementById("pitch_output");

  if (!selectedId) {
    out.innerHTML = '<span class="text-gray-600">‚ö†Ô∏è Selecciona un curso de la lista para generar el pitch</span>';
    return;
  }

  const course = [...LIVE_COURSE_DATA, ...LIVE_POSSIBLE_GROUPS].find(c => c.id === selectedId);
  if (!course) return;

  const remaining = course.capacity - course.enrolled;
  const typeLabel = course.type === 'possible' ? 'üåü GRUPO POSIBLE (creado por demanda)' : '‚úÖ GRUPO ACTIVO';
  loading.classList.remove("hidden");

  const baseInfo = `<div class="mb-4 p-2 bg-blue-100 rounded-lg"><b>üìä DETALLES DEL CURSO:</b><div class="mt-1"><span class="font-semibold">${typeLabel}</span></div><div class="mt-1">üìÖ Inicio: ${course.next_start}</div><div>üßë‚Äçüíª Disponibilidad: ${remaining} cupos de ${course.capacity} totales</div><div>üë®‚Äçüè´ Instructor: ${course.teacher}</div>${course.isFull ? '<div class="text-orange-600 font-semibold">‚ö†Ô∏è Grupo lleno - requiere autorizaci√≥n</div>' : ''}</div>`;

  if (!API_KEY) {
    out.innerHTML = baseInfo + "<p class='text-gray-600 mt-2'><i>‚ö†Ô∏è Configura tu API key para generar pitches personalizados con IA</i></p>";
    loading.classList.add("hidden");
    return;
  }

  const age = document.getElementById("student_age").value;
  const interest = document.getElementById("student_interest").value;
  
  const systemPrompt = `Eres un experto en ventas educativas. Genera un pitch de venta convincente en espa√±ol, m√°ximo 150 palabras, enfocado en los beneficios del curso para el estudiante y los padres. Incluye urgencia si hay pocos cupos. ${course.type === 'possible' ? 'Este es un grupo POSIBLE creado por demanda, enfatiza la oportunidad de formar parte de un grupo nuevo.' : 'Este es un grupo ACTIVO confirmado.'}`;
  
  const userQuery = `Curso: ${course.name_es}
Tipo: ${course.type === 'possible' ? 'Grupo Posible (por demanda)' : 'Grupo Activo'}
Edad estudiante: ${age} a√±os
Inter√©s: ${interest}
Cupos disponibles: ${remaining} de ${course.capacity}
Horario: ${course.next_start}
Profesor: ${course.teacher}

Genera un pitch persuasivo que destaque los beneficios y cree urgencia apropiada.`;

  try {
    const resp = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
      }),
    });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
    if (!text) throw new Error("Sin respuesta de la IA");
    out.innerHTML = baseInfo + `<div class="mt-3"><b>üé§ PITCH GENERADO:</b><p style="margin-top:10px;line-height:1.6;">${text.replace(/\n/g, "<br>")}</p></div>`;
  } catch (err) {
    out.innerHTML = `<div class="mb-4 p-2 bg-red-100 rounded-lg"><b>‚ö†Ô∏è Error al generar pitch con IA</b><p class="text-sm mt-1">${err.message}</p></div>` + baseInfo;
  } finally {
    loading.classList.add("hidden");
  }
}

// ============================================
// ENV√çO DE VENTA
// ============================================
async function submitSale() {
  if (selectedCourses.length === 0) {
    alert("‚ö†Ô∏è Selecciona al menos un curso antes de enviar la venta");
    return;
  }
  if (!SALES_SCRIPT_URL) {
    alert("‚ö†Ô∏è Sistema de guardado no conectado.\n\nContacta al administrador para configurar la integraci√≥n con Google Sheets.");
    return;
  }
  const saleData = {
    timestamp: new Date().toISOString(),
    amo_crm_link: document.getElementById("amo_crm_link").value.trim(),
    student_age: document.getElementById("student_age").value,
    interest: document.getElementById("student_interest").value,
    course_type: document.getElementById("course_type").value,
    group_type: document.getElementById("group_type").value,
    is_sen: document.getElementById("is_sen").checked,
    selected_courses: selectedCourses.map(c => ({
      id: c.id,
      name: c.name_es,
      type: c.type,
      schedule: c.next_start,
      teacher: c.teacher,
      enrolled: c.enrolled,
      capacity: c.capacity,
      remaining: c.capacity - c.enrolled
    })),
    preferred_schedule: preferredSchedule.length > 0 ? preferredSchedule : null
  };
  try {
    const response = await fetch(SALES_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(saleData)
    });
    const result = await response.json();
    if (result.success) {
      showSystemMessage('success', '‚úÖ ¬°Venta registrada exitosamente!', 'Los datos han sido guardados en el sistema');
      setTimeout(() => location.reload(), 2000);
    } else {
      throw new Error(result.message || "Error desconocido");
    }
  } catch (error) {
    showSystemMessage('error', '‚ùå Error al guardar la venta', error.message);
  }
}

// ============================================
// CONFIGURACI√ìN DE IDIOMA
// ============================================
function setLanguage(lang) {
  currentLang = lang;
}

// ============================================
// INICIALIZACI√ìN
// ============================================
window.onload = () => {
  setLanguage("es");
  document.getElementById("student_age").value = 10;
  fetchCourseData().then(() => {
    updateDataSourceInfo();
    updateCourseTypeOptions();
  }).catch(() => {
    showSystemMessage('warning', '‚ö†Ô∏è Conexi√≥n limitada', 'No se pudo cargar la base de datos de cursos. Intenta refrescar la p√°gina.');
  });
  setInterval(() => { if (lastFetchTime) updateDataSourceInfo(); }, 30000);
};
</script>
</body>
</html>

